MODULE PurchaseInvoiceMarketing;

REQUIRE InvoiceMarketing, PurchaseInvoice;

NAMESPACE Purchase;

@defineOperationProperty(showMarketingSupplier, 'Маркетинг (закупка)', showContainer);
showMarketingSupplier = showMarketingSupplier(operation(Purchase.Invoice i));

percMarketingSupplier '% маркетинга' = ABSTRACT NUMERIC[8,4] (Purchase.InvoiceDetail);
percMarketingSupplier '% маркетинга' = DATA NUMERIC[8,4] (Purchase.UserInvoiceDetail);
percMarketingSupplier(Purchase.UserInvoiceDetail d) += percMarketingSupplier(d);
Invoice.percMarketingSupplier(Purchase.InvoiceDetail d) += percMarketingSupplier(d);

EXTEND FORM Purchase.userInvoice
    PROPERTIES (d) percMarketingSupplier SHOWIF showMarketingSupplier(i) 
;
EXTEND FORM Purchase.invoices
    PROPERTIES (d) READONLY percMarketingSupplier SHOWIF showMarketingSupplier(i)   
;
marketingSum 'Сумма маркетинга'  (InvoiceDetail d) = round2(sum(d)*percMarketingSupplier(d)/100.0); 
marketingSumInvoiceDetail 'Сумма маркетинга'  = GROUP BY invoice(InvoiceDetail d) SUM marketingSum(d); 