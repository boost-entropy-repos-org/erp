MODULE FiscalVMK;

REQUIRE System,
        POS;

loadDefaultCashRegisterModels() + {  EXEC loadDefaultCashRegisterModel('Фискальный регистратор VMK', 'VMK', NULL, NULL, TRUE, NULL, NULL ); };

needDLL() = GROUP SUM 1 IF computer(CashRegister c) == currentComputer() AND sidModel(groupMachinery(c)) == 'VMK';
onDesktopClientStarted() + { 
	IF needDLL() THEN {
	    IF is64Java(currentComputer()) THEN
	        loadLibrary('lib/win64/vmkd.dll');
	    ELSE
	        loadLibrary('lib/win32/vmkd.dll');
	}
};

fiscalVMKPrint 'Напечатать фискальный чек'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKPrintReceiptActionProperty' (Receipt);
postPrint(Receipt receipt) + {  IF sidCashRegisterModel(receipt) == 'VMK' THEN fiscalVMKPrint(receipt); }

fiscalVMKReceiptTitle 'Заголовок чека VMK' = ABSTRACT TEXT ();
fiscalVMKTop 'Дополнительный текст перед чеком VMK' = ABSTRACT TEXT (Receipt);
fiscalVMKBottom 'Дополнительный текст после чека VMK' = ABSTRACT TEXT (Receipt);

fiscalVMKPrintCopyReceipt 'Копия чека'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKPrintCopyReceiptActionProperty' ();
fiscalPrintCopyReceipt() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKPrintCopyReceipt(); }

fiscalVMKAdvancePaper 'Прогон ленты'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKAdvancePaperActionProperty' ();
fiscalAdvancePaper() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKAdvancePaper(); }

fiscalVMKXReport 'X-отчёт'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKXReportActionProperty' ();
fiscalXReport() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKXReport(); }

fiscalVMKZReport 'Z-отчёт'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKZReportActionProperty' ();
fiscalZReport() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKZReport(); }

fiscalVMKCashSum 'Наличных в кассе'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKCashSumActionProperty' ();
fiscalCashSum() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKCashSum(); }

fiscalVMKReportTop 'Заголовок отчёта VMK' = ABSTRACT TEXT ();

fiscalVMKUpdateData 'Загрузить информацию'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKUpdateDataActionProperty' ();
fiscalUpdateData() + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKUpdateData(); }

fiscalVMKService 'Перемещение денег'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKServiceInOutActionProperty' (CashOperation);
fiscalService(CashOperation cashOperation) + {  IF sidCashRegisterModel(cashOperation) == 'VMK' THEN fiscalVMKService(cashOperation); }

fiscalVMKDisplayText 'Вывести текст на дисплей'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKDisplayTextActionProperty' (ReceiptDetail);
fiscalDisplayText (ReceiptDetail receiptDetail) + {  IF sidCashRegisterModel(receiptDetail) == 'VMK' THEN fiscalVMKDisplayText(receiptDetail); }

fiscalVMKCancel 'Отменить чек'  INTERNAL  'lsfusion.erp.region.by.machinery.cashregister.fiscalvmk.FiscalVMKCancelReceiptActionProperty' (Receipt);
fiscalCancel(Receipt receipt) + {  IF sidModelCurrentCashRegister() == 'VMK' THEN fiscalVMKCancel(receipt); }

UNP 'УНП (VMK)' = DATA STRING[9] (Machinery);
UNPCurrentCashRegister() = UNP(currentCashRegister());
regNumber 'Регистрационный номер (VMK)' = DATA STRING[20] (Machinery);
regNumberCurrentCashRegister() = regNumber(currentCashRegister());
machineryNumber 'Номер КСА (VMK)' = DATA STRING[20] (Machinery);
machineryNumberCurrentCashRegister() = machineryNumber(currentCashRegister());

isVMK(CashRegister c) = sid(model(groupCashRegister(c))) == 'VMK';
EXTEND FORM groupCashRegister
    PROPERTIES(c) SHOWIF isVMK(c) UNP, regNumber, machineryNumber
;