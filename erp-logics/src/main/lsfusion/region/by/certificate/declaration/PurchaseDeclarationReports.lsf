MODULE PurchaseDeclarationReports;

REQUIRE PurchaseDeclarationDetailBy;

NAMESPACE Purchase;

// -------------------------------------------- Сбивка по декларации ------------------------------------- //

left6 = FORMULA STRING[6] 'left($1, 6)';  // ISO

quantity 'Кол-во' (declaration, code)= GROUP 
    BY declaration(DeclarationDetail detail), left6(codeCustomsGroup(detail)) SUM quantity(detail);
    
quantity 'Кол-во' (code, DeclarationDetail detail)= GROUP 
    BY left6(codeCustomsGroup(detail)) SUM quantity(detail);    
    
nameCustoms'Наименование' (declaration, code)= GROUP 
    BY declaration(DeclarationDetail detail), left6(codeCustomsGroup(detail)) MIN nameCustoms(detail);    
        
sum 'Стоимость' (declaration, code)= GROUP 
    BY declaration(DeclarationDetail detail), left6(codeCustomsGroup(detail)) SUM sum(detail);
sumNetWeight 'Вес нетто, кг' (declaration, code)= GROUP 
    BY declaration(DeclarationDetail detail), left6(codeCustomsGroup(detail)) SUM sumNetWeight(detail);
sumGrossWeight 'Вес брутто, кг' (declaration, code)= GROUP 
    BY declaration(DeclarationDetail detail), left6(codeCustomsGroup(detail)) SUM sumGrossWeight(detail);
        
            
FORM declarationReport 'Сбивка по декларации'

    OBJECTS d = Declaration PANEL
    PROPERTIES(d) number, series, date, time, sumDeclarationDetail,
                  sumNetWeightDeclarationDetail, sumGrossWeightDeclarationDetail 
                  
    OBJECTS s=STRING[6]
    PROPERTIES objS = VALUE(s), nameCustoms(d,s), sum(d,s), sumNetWeight(d,s),
               sumGrossWeight(d,s)
    ORDER objS
    FILTERS quantity(d,s)
    
    OBJECTS dd=DeclarationDetail

    PROPERTIES(dd) number, invoices READONLY, nameCustoms, shortNameUOM,
                   nameCountry, sumNetWeight, sumGrossWeight,
                   codeCustomsGroup, nameVATCustomsException BACKGROUND backgroundVATCustomsException(dd),
                   quantity, price, sum, deliverySum, chargeSum, homeSum,
                   percentDuty, weightDuty, dutySum,
                   numberVAT, percentVAT, VATSum
                 

    FILTERS declaration(dd) == d,
            quantity(s,dd)

;
printReport 'Сбивка по декларации' (Declaration declaration) = { PRINT declarationReport OBJECTS d = declaration; }   IMAGE 'print.png' IN print;

EXTEND FORM declarations
    PROPERTIES (d) printReport TOOLBAR
;
