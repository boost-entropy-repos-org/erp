MODULE InvoiceEInvoice;

REQUIRE EDI, Invoice;

PRIORITY Invoice;

NAMESPACE EDI;

eInvoice = ABSTRACT EInvoice (Invoice);

invoice = GROUP AGGR Invoice i BY eInvoice(i);
numberInvoice 'Номер накладной (продажа)' (EInvoice i) = number(invoice(i));

numberEInvoice 'Номер'(Invoice i) = deliveryNoteNumber(eInvoice(i));


defaultNumeratorDeliveryNoteNumber = DATA Numerator ();
nameDefaultNumeratorDeliveryNote 'DeliveryNoteNumber Накладные (продажа)' = name(defaultNumeratorDeliveryNoteNumber()) IN defaultNumerator;

EXTEND FORM defaultNumerators
    PROPERTIES() nameSaleDefaultNumeratorDeliveryNote = nameDefaultNumeratorDeliveryNote
;

loadDefaultNumerators() + { 
    NEW n = Numerator {
        name(n) <- 'DeliveryNoteNumber Накладные (продажа)';
        series(n) <- '';
        minValue(n) <- 1L;
        maxValue(n) <- 9999999999L;
        stringLength(n) <- 10;

        defaultNumeratorDeliveryNoteNumber() <- n;
    }
}

generateSeriesNumber 'Сгенерировать номер'(EInvoice o)  { 
    deliveryNoteNumber(o) <- '001-' + GLN(supplier(o)) + '-' + curStringValue(defaultNumeratorDeliveryNoteNumber()); //ССС-GGGGGGGGGGGGG-NNNNNNNNNN
    incrementValueSession(defaultNumeratorDeliveryNoteNumber());
}


EXTEND FORM eInvoices
    PROPERTIES (e) READONLY numberInvoice
;

signAndSendSupplierEDI 'Подписать и отправить (поставщик)'(Invoice i)  { 
    in(EInvoice e) <- e = eInvoice(i);
    signAndSendSupplierEDI();
    in(EInvoice e) <- NULL;
}