MODULE InvoiceEInvoice;

REQUIRE EDI, Invoice;

PRIORITY Invoice;

NAMESPACE EDI;

invoice = DATA Invoice(EInvoice);
eInvoice = GROUP LAST EInvoice ei IF NOT isCancel(ei) ORDER dateTime(ei), ei BY invoice(ei);
numberInvoice 'Номер накладной EDI' (EInvoice i) = number(invoice(i));

numberEInvoice 'Номер'(Invoice i) = deliveryNoteNumber(eInvoice(i));


defaultNumeratorDeliveryNoteNumber = DATA Numerator ();
nameDefaultNumeratorDeliveryNote 'DeliveryNoteNumber Накладные EDI' = name(defaultNumeratorDeliveryNoteNumber()) IN defaultNumerator;

EXTEND FORM defaultNumerators
    PROPERTIES() nameSaleDefaultNumeratorDeliveryNote = nameDefaultNumeratorDeliveryNote
;

loadDefaultNumerators() + { 
    NEW n = Numerator {
        name(n) <- 'DeliveryNoteNumber Накладные EDI';
        series(n) <- '';
        minValue(n) <- 1L;
        maxValue(n) <- 9999999999L;
        stringLength(n) <- 10;

        defaultNumeratorDeliveryNoteNumber() <- n;
    }
}

generateSeriesNumber 'Сгенерировать номер'(EInvoice o)  { 
    deliveryNoteNumber(o) <- '001-' + GLN(supplier(o)) + '-' + curStringValue(defaultNumeratorDeliveryNoteNumber()); //ССС-GGGGGGGGGGGGG-NNNNNNNNNN
    incrementValueSession(defaultNumeratorDeliveryNoteNumber());
}


EXTEND FORM eInvoices
    PROPERTIES (e) READONLY numberInvoice
;

signAndSendSupplierEDI 'Подписать и отправить (поставщик)'(Invoice i)  { 
    in(EInvoice e) <- e = eInvoice(i);
    signAndSendSupplierEDI();
    in(EInvoice e) <- NULL;
}

cancelSignAndSendSupplierEDI 'Отменить (поставщик)'(Invoice i)  { 
    NEWSESSION {
        in(EInvoice e) <- e = eInvoice(i);
        exportedSupplier(EInvoice e) <- NULL WHERE e = eInvoice(i);
        isCancel(EInvoice e) <- TRUE WHERE e = eInvoice(i);
        signAndSendSupplierEDI();
        IF (GROUP SUM 1 IF exportedSupplier(EInvoice e) AND in(e)) THEN APPLY;
    }
}