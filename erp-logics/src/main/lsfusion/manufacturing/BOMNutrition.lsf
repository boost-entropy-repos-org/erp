MODULE BOMNutrition;

REQUIRE BOM, ItemNutrition;


// ------------------------------------------------------------------- //
GROUP nutrition 'Энергетическая ценность' : base;

showNutrition 'Отображать энергетическую ценность' = DATA BOOLEAN(BOM) IN documentPrm;

recipes 'Номер по сборнику рецептов' = DATA VARSTRING[100] (BOM) IN documentPrm CHARWIDTH 5;
recipes 'Номер по сборнику рецептов' (Product product) = recipes(BOM(product));

// Энергетическая ценность компонент

META changeNutrition(object, skuProp, property)
    change###property(###object object)   { 
        INPUT n = NUMERIC[8,2] DO
            property(Item item) <- n WHERE item == skuProp(object);
    }
END

fats 'Жиры на 100г, г' = fats[Item](overSku(Component c));
carbohydrates 'Углеводы 100г, г' = carbohydrates[Item](overSku(Component c));
proteins 'Белки 100г, г' = proteins[Item](overSku(Component c));
energy 'Энерг.ценность на 100г, ккал' = energy[Item](overSku(Component c));

@changeNutrition(component, overSku, fats);
@changeNutrition(component, overSku, carbohydrates);
@changeNutrition(component, overSku, proteins);
@changeNutrition(component, overSku, energy);

// Энергетическая ценность спецификации

fats 'Жиры'(BOM) = GROUP SUM fats(Component component) BY BOM(component) IN nutrition;
carbohydrates 'Углеводы'(BOM) = GROUP SUM carbohydrates(Component component) BY BOM(component) IN nutrition;
proteins 'Белки'(BOM) = GROUP SUM proteins(Component component) BY BOM(component) IN nutrition;
energy 'Энерг.ценность'(BOM) = GROUP SUM energy(Component component) BY BOM(component) IN nutrition;

// Энергетическая ценность изделий

fats 'Жиры 100г, г' =  DATA NUMERIC[8,2](Product);
carbohydrates 'Углеводы 100г, г' = DATA NUMERIC[8,2](Product);
proteins 'Белки 100г, г' = DATA NUMERIC[8,2](Product);
energy 'Энерг.ценность на 100г, ккал' = DATA NUMERIC[8,2](Product);
productYield 'Выход' = DATA VARSTRING[100] (Product) CHARWIDTH 20;

fatsItem 'Жиры 100г, г (товар)' (Product p) = fats(sku(p));
carbohydratesItem 'Углеводы 100г, г (товар)' (Product p) = carbohydrates(sku(p));
proteinsItem 'Белки 100г, г (товар)' (Product p) = proteins(sku(p));
energyItem 'Энерг.ценность на 100г, ккал (товар)' (Product p) = energy(sku(p));

composition 'Состав' = DATA VARSTRING[2550] (Product) CHARWIDTH 30;
components 'Компоненты' (Product product)= components(BOM(product));
composition(Product product) <- components(product) WHEN CHANGED(components(product));

changeComposition 'Записать в товар'(Product product)  { 
    FOR sku(product) == Sku item DO {
        composition[Item](item) <- VARSTRING[255](composition(product));
    }
} ASON CONTEXTMENU composition[Product];

//------------------------------- СТБ -------------------------------------//
CLASS StateStandart 'СТБ';
TABLE stateStandart (StateStandart);
  
name 'Наименование' = DATA VARISTRING[100](StateStandart);
number 'Номер' = DATA STRING[50](StateStandart);   
note 'Примечание' = DATA STRING[250](StateStandart);  
@defineExternalizable(stateStandart, VARSTRING[100]); 
 
FORM stateStandart 'СТБ'
    OBJECTS s=StateStandart PANEL
    PROPERTIES(s) id SHOWIF  showIDs(), name, number, note 
    EDIT StateStandart OBJECT s
;

DESIGN stateStandart {
    BOX {
        PROPERTY(name(s)){
            charWidth = 50;    
        }
    }       
}

FORM stateStandarts 'СТБ'
    OBJECTS s=StateStandart
    PROPERTIES(s) NEWSESSION id READONLY SHOWIF showIDs(), name READONLY, number READONLY , note, DELETE 
    PROPERTIES(s) NEWSESSION NEW, EDIT
    ORDER number(s)
    LIST StateStandart OBJECT s
;
DESIGN stateStandarts { BOX { size = (600, 400); } } 

stateStandart= DATA StateStandart (BOM);
numberStateStandart 'СТБ' (BOM BOM) = number(stateStandart(BOM));
nameStateStandart 'СТБ' (BOM BOM) = name(stateStandart(BOM));

numberStateStandart 'СТБ' (Product p) = numberStateStandart(BOM(p));
nameStateStandart 'СТБ' (Product p) = nameStateStandart(BOM(p));


backgroundFast (Product p) = IF (fats(p) OR fatsItem(p)) AND NOT fatsItem(p) == fats(p) THEN RGB(255,153,153) ELSE RGB(244,255,189);
backgroundCarbohydrates (Product p) = IF (carbohydrates(p) OR carbohydratesItem(p)) AND NOT carbohydratesItem(p) == carbohydrates(p) THEN RGB(255,153,153) ELSE RGB(244,255,189);
backgroundProteins (Product p) = IF (proteins(p) OR proteinsItem(p)) AND NOT proteinsItem(p) == proteins(p) THEN RGB(255,153,153) ELSE RGB(244,255,189);
backgroundEnergy (Product p) = IF (energy(p) OR energyItem(p)) AND NOT energyItem(p) == energy(p) THEN RGB(255,153,153) ELSE RGB(244,255,189);

// Расширяем формы
showNutritionBOM = ABSTRACT VALUE BOOLEAN (BOM);
showNutritionBOM(BOM b) += showNutrition(b);
EXTEND FORM BOM
    PROPERTIES(b) showNutrition
    PROPERTIES(b) recipes, numberStateStandart //SHOWIF showNutritionBOM(b)
    
    
    OBJECTS pp = Product
    PROPERTIES(pp) index 
    PROPERTIES(pp) READONLY idBarcodeSku, id SHOWIF showIDs(), nameSku, shortNameUOM     
    
    PROPERTIES(pp) READONLY quantity, overNettoNetWeight, pricePercent, calcPriceCoeff 
    FILTERS       BOM(pp) == b
    PROPERTIES(pp) SHOWIF showNutrition(b) fats BACKGROUND backgroundFast(pp), carbohydrates BACKGROUND backgroundCarbohydrates(pp), 
                   proteins BACKGROUND backgroundProteins(pp), energy BACKGROUND backgroundEnergy(pp), composition, productYield
    PROPERTIES(pp) SHOWIF showNutrition(b) READONLY fatsItem, carbohydratesItem, proteinsItem, energyItem
                  
    OBJECTS cc = Component
    PROPERTIES(cc) READONLY BACKGROUND background(cc) index 
    PROPERTIES(cc) READONLY BACKGROUND background(cc) idBarcodeSku, id SHOWIF showIDs(), nameMaterial, shortNameUOM 
    PROPERTIES(cc) READONLY BACKGROUND background(cc) nettoQuantity, overNettoNetWeight, wastage, bruttoQuantity, overBruttoNetWeight
    ORDER index(cc)
    FILTERS       BOM(cc) == b
                
    PROPERTIES(cc) SHOWIF showNutrition(b) BACKGROUND background(cc) fats ON CHANGE changeFats(cc), carbohydrates ON CHANGE changeCarbohydrates(cc), 
                  proteins ON CHANGE changeProteins(cc), energy ON CHANGE changeEnergy(cc)
;

DESIGN BOM {
    specificationBox {
        NEW nutrition {
            showIf = showNutritionBOM(b);
            fill = 1;
            caption = 'Энерг. ценность / Влажность';
            type = SPLITV;
            MOVE BOX(pp);
            MOVE BOX (cc);
        }
    }
    kitchen {
        MOVE PROPERTY(showNutrition(b));
        MOVE PROPERTY(recipes(b));
        MOVE PROPERTY(numberStateStandart(b)); 
    }
}
EXTEND FORM BOMs
    PROPERTIES(b) READONLY BACKGROUND background(b) showNutrition
    PROPERTIES(p) SHOWIF showNutrition(b) READONLY fats, carbohydrates, proteins, energy, composition, productYield
    PROPERTIES(c) SHOWIF showNutrition(b) BACKGROUND background(c) READONLY fats, carbohydrates, proteins, energy
    
    PROPERTIES(p1)  fats, carbohydrates, proteins, energy
    PROPERTIES(c2)  fats, carbohydrates, proteins, energy
;
EXTEND FORM BOMsDialog
    PROPERTIES(b) READONLY BACKGROUND background(b) showNutrition
    PROPERTIES(p) SHOWIF showNutrition(b) READONLY fats, carbohydrates, proteins, energy, composition, productYield
    PROPERTIES(c) SHOWIF showNutrition(b) BACKGROUND background(c) READONLY fats, carbohydrates, proteins, energy
    
;

