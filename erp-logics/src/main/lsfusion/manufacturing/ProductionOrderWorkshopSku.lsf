MODULE ProductionOrderWorkshopSku;

REQUIRE ProductionOrderSku, ProductionOrderWorkshop;

NAMESPACE Production;

fillNegativeBalanceWorkshopProductDetail 'Заполнить изделия по остаткам' (Order o) {
    FOR balanceA(Sku sk, productsStock(o), date(o)) < 0 AND inWorkshop(sk,workshopStock(o))  DO NEW d = ProductDetail {
        order(d) <- o;
        sku(d) <- sk;
        quantity(d) <- abs(balanceA(sk, productsStock(o), date(o)));
        product(d) <- GROUP MAX Product p IF isActive(BOM(p)) AND in(BOM(p), componentsStock(o)) AND sku(p) == sk;
    }    
    
}

@defineOperationProperty(showFillNegativeBalance, 'Показывать кнопку добавления строк с отриц. остатком', BOOLEAN, showContainer);

EXTEND FORM order PROPERTIES fillNegativeBalanceWorkshopProductDetail(o) SHOWIF showFillNegativeBalance(operation(o)) DRAW pd TOOLBAR;