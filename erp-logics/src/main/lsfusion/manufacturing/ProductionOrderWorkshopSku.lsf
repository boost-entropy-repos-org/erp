MODULE ProductionOrderWorkshopSku;

REQUIRE ProductionOrderSku, ProductionOrderWorkshop;

NAMESPACE Production;


WHEN LOCAL CHANGED(workshopStock(Order o)) AND NOT (GROUP SUM 1 IF CHANGED (inWorkshop(ItemGroup g,o))) DO {
    inWorkshop(ItemGroup g,o)<- inWorkshop(g,workshopStock(o));
}


fillNegativeBalanceWorkshopProductDetail 'Заполнить изделия по остаткам' (Order o) {
    FOR balanceA(Sku sk, productsStock(o), date(o)) < 0 AND inWorkshop(sk,o)  DO NEW d = ProductDetail {
        order(d) <- o;
        sku(d) <- sk;
        quantity(d) <- abs(balanceA(sk, productsStock(o), date(o)));
        product(d) <- GROUP MAX Product p IF isActive(BOM(p)) AND in(BOM(p), componentsStock(o)) AND sku(p) == sk;
    }    
    
}

@defineOperationProperty(showFillNegativeBalance, 'Показывать кнопку добавления строк с отриц. остатком', BOOLEAN, showContainer);

EXTEND FORM order PROPERTIES fillNegativeBalanceWorkshopProductDetail(o) SHOWIF showFillNegativeBalance(operation(o)) DRAW pd TOOLBAR;