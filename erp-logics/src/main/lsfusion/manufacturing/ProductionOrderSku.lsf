MODULE ProductionOrderSku;

REQUIRE ProductionOrder, Warehouse, Store;

NAMESPACE Production;

skuGroup = DATA ItemGroup(Stock);
nameSkuGroup 'Группа товаров' (Stock st) = name(skuGroup(st));

EXTEND FORM warehouse PROPERTIES nameSkuGroup(w);

DESIGN warehouse {
    headerExtraParams {
        MOVE PROPERTY (nameSkuGroup(w));
    }
}

EXTEND FORM departmentStore PROPERTIES nameSkuGroup(d);

DESIGN departmentStore {
    headerExtraParams {
        MOVE PROPERTY (nameSkuGroup(d));
    }
}

fillNegativeBalanceProductDetail 'Добавить строки с отрицательным остатком' (Order o, SkuGroup sg) {
    FOR balanceB(Sku sk, productsStock(o), date(o)) < 0 AND isParent(sg, sk) DO NEW d = ProductDetail {
        order(d) <- o;
        sku(d) <- sk;
        quantity(d) <- abs(balanceB(sk, productsStock(o), date(o)));
        product(d) <- GROUP MAX Product p IF isActive(BOM(p)) AND in(BOM(p), productsStock(o)) AND sku(p) == sk;
    }
}