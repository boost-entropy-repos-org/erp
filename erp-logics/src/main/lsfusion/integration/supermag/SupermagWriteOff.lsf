MODULE SupermagWriteOff;

REQUIRE SupermagSettings, SupermagFormMeta, Utils, TaxItem, PricingWriteOff;

NAMESPACE WriteOff;

@settingOperationSupermag(WriteOff);

@settingIntegration(WriteOff, WriteOffDetail);

@exportFilds(writeOff, writeOffDetail); 

@exportFormWO(exportWriteOffWO, writeOff, writeOffDetail, 'документ списания');

EXTEND FORM exportWriteOffWO
    PROPERTIES = indexMinus(docd) EXTID 'SPECITEM'
    PROPERTIES = indexMinus(docd2) EXTID 'SPECITEM'
    PROPERTIES = indexMinus(docd3) EXTID 'SPECITEM'
    PROPERTIES = indexMinus(docd4) EXTID 'SPECITEM'
    FILTERS quantity(docd) < 0
    FILTERS quantity(docd2) < 0
    FILTERS quantity(docd3) < 0
    FILTERS quantity(docd4) < 0
;                

exportWriteOffMag 'Экспорт в супермаг' (WriteOff i) {
    inc(WriteOff ii) <- NULL;
    IF docTypeSupermag(operation(i)) AND opcodeSupermag(operation(i)) THEN {        
        LOCAL NESTED dt = DATETIME();
        dt () <- currentDateTime();
        inc(i) <- TRUE;
        FOR iterate(INTEGER n, 1, wordCount(docTypeSupermag(operation(i)),';')) DO {
                doctype(i) <- STRING[10] (getWord(docTypeSupermag(operation(i)),';',n));
                opcode(i) <- STRING[10] (getWord(opcodeSupermag(operation(i)),';',n));
                userop(i) <- STRING[10] (getWord(useropSupermag(operation(i)),';',n));
                clientIndex(i) <- id(contragentSupermag(stockGroup(stock(i))));
                priceWithTax(WriteOffDetail ad) <- price(ad) WHERE writeOff(ad) = i;
                valueTax(WriteOffDetail ad) <- valueVAT(sku(ad)) WHERE writeOff(ad) = i;
                priceNoTax(WriteOffDetail ad) <- NUMERIC[18,4] ( abs(round( priceWithTax(ad) / (1 + valueTax(ad)/100),2))) WHERE writeOff(ad) = i;
                sumWithTax(WriteOffDetail ad) <- abs(sum(ad)) WHERE writeOff(ad) = i;
                sumNoTax(WriteOffDetail ad) <- NUMERIC[18,4] ( abs(round( sumWithTax(ad) / (1 + valueTax(ad)/100),2))) WHERE writeOff(ad) = i;
                sumTax(WriteOffDetail ad) <- sumWithTax(ad) - sumNoTax(ad) WHERE writeOff(ad) = i;
                sumWithTaxCurr(WriteOffDetail ad) <-round(sumWithTax(ad)/curRate(i),2) WHERE writeOff(ad) = i;
                locationFrom(i) <- stock(i);
                locationTo(i) <- stock(i);
                location(i)  <- stock(i);                 
                CASE WHEN doctype(i) = 'WI' THEN {
                        id(i) <- 'Ф' + seriesNumber(i);
                        sumWithTax(i) <- GROUP SUM abs(sumWithTax(WriteOffDetail add)) IF (writeOff(add) = i AND sum(add) > 0);                
                        sumWithTaxCurr(i) <- GROUP SUM sumWithTaxCurr(WriteOffDetail add) IF (writeOff(add) = i AND sum(add) > 0);                                
                     }
                     WHEN doctype(i) = 'WO' THEN {
                        id(i) <- 'Ф' + seriesNumber(i);
                        sumWithTax(i) <- GROUP SUM abs(sumWithTax(WriteOffDetail add)) IF (writeOff(add) = i AND sum(add) < 0);                
                        sumWithTaxCurr(i) <- GROUP SUM sumWithTaxCurr(WriteOffDetail add) IF (writeOff(add) = i AND sum(add) < 0);                                
                     }
           TRY {                
                CASE WHEN doctype(i) = 'WI' THEN EXPORT exportWriteOffWO XML TO System.exportFile;                 
           } CATCH MESSAGE 'Ошибка формирования файла';
           
           TRY {          
                WRITE System.exportFile() TO 'file://' + exportDirectorySupermag() + '/' + doctype(i) +'_' +STRING[30](LONG(i))+'_'+(OVERRIDE id(i), '')+'_'+ formulaDateT(dt());
           } CATCH {
                MESSAGE 'file://' + exportDirectorySupermag() + '/' + doctype(i) +'_' +STRING[30](LONG(i))+'_'+(OVERRIDE id(i), '')+'_'+ formulaDateT(dt())+ '.xml';
                MESSAGE messageCaughtException();            
                MESSAGE javaStackTraceCaughtException();            
                MESSAGE lsfStackTraceCaughtException();            
           }
           
           TRY 
           {      
                fileExists('file://' + exportDirectorySupermag() + '/' + doctype(i) +'_' +STRING[30](LONG(i))+'_'+(OVERRIDE id(i), '')+'_'+ formulaDateT(dt()) + '.xml'); 
                IF fileExists()  THEN NEWSESSION NESTED LOCAL {
                    FOR inc(WriteOff ii)  DO NEW log = SupermagLog {
                        id(log)<- doctype(i) + '_' +STRING[30](LONG(ii))+'_'+(OVERRIDE id(ii), '')+'_'+ formulaDateT(dt());  
                        dateTime(log) <- currentDateTime();
                        userLogin(log) <- login(currentUser()); 
                        nameContact(log) <- STRING[100](name(currentUser()));
                    }     
                    APPLY NESTED LOCAL;
                }             
                     
           } CATCH {
                logToFile('supermag', CONCAT '\n', 'Изменение остатков', 'file://' + exportDirectorySupermag() + '/' + doctype(i) + '_' + STRING[30](LONG(i))+'_'+(OVERRIDE id(i), '')+'_'+ formulaDateT(dt()) + ' ParseMessage error:', messageCaughtException(), javaStackTraceCaughtException(), lsfStackTraceCaughtException());
                MESSAGE 'Файл не найден' + 'file://' + exportDirectorySupermag() + '/' + doctype(i) +'_' +STRING[30](LONG(i))+'_'+(OVERRIDE id(i), '')+'_'+ formulaDateT(dt());
           }
        } 
    }       
    inc(WriteOff ii) <- NULL;
}

EXTEND FORM writeOffs PROPERTIES exportWriteOffMag(w) DRAW w TOOLBAR;
