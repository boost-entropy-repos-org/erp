MODULE SupermagSettings;

REQUIRE StockDocument, LogTools, Store, PaymentCondition;

DESIGN integrationData {
    pane {
        NEW supermagScroll FIRST {
            type = SCROLL;
            caption = 'Супермаг';
            NEW supermag {                
                fill = 1;
                type = CONTAINERH;
                NEW supermag1 {
                    type = CONTAINERH;
                    fill = 1;
                    NEW supermagLeft {                
                        fill = 1;
                        NEW supermagParams { caption = 'Параметры подключения'; }
                        NEW integrationSettings { caption = 'Настройки интеграции'; }
                        NEW supermagExportButtons { fill = 1; caption = 'Экспорт'; }               
                        NEW supermagImportButtons { fill = 1; caption = 'Импорт'; }
                    }
                    NEW supermagRight { fill = 1;  }    
}   }   }   }   }   


host 'Хост' = DATA ISTRING[30]();
base 'База' = DATA ISTRING[100]();
login 'Логин' = DATA ISTRING[100]();
password 'Пароль' = DATA ISTRING[100]();
exportDirectorySupermag 'Путь для исходящих файлов в супермаг' = DATA STRING[500] ();
importDirectorySupermag 'Путь для входящих файлов из супермаг' = DATA STRING[500] ();
baseIDSupermag 'ID нашей базы в Супермаг' = DATA STRING[100] ();
idGroupWarehouseInSuperMag 'ид группы складов (вне магазинов)' = DATA INTEGER ();

EXTEND FORM integrationData PROPERTIES smhost = host(), base(), login(), password(), exportDirectorySupermag(), importDirectorySupermag(), baseIDSupermag();

DESIGN integrationData {
    supermagParams {
        MOVE PROPERTY (smhost);
        MOVE PROPERTY (base());
        MOVE PROPERTY (login());
        MOVE PROPERTY (password());
        MOVE PROPERTY (exportDirectorySupermag());  
        MOVE PROPERTY (importDirectorySupermag());     
        MOVE PROPERTY (baseIDSupermag());
    }
}

in 'Отм.' = DATA BOOLEAN (Stock);
stocks 'Склады для синхронизации' () = GROUP CONCAT id(Stock st) IF in(st), ',' ORDER id(st) CHARWIDTH 50;

FORM dialogDepartmentStores 'Склады'
    OBJECTS d = Stock
    PROPERTIES (d) in
    PROPERTIES (d) READONLY id, name, nameStore
    FILTERS d IS DepartmentStore OR isCompany(legalEntity(d))
    FILTERGROUP active FILTER 'Активные' active(d) DEFAULT
    FILTERGROUP in FILTER 'Отмеченные' in(d)
    ORDER nameStore(d), name(d)
;

DESIGN dialogDepartmentStores {
    size = (600, 600);
}

EXTEND FORM integrationData 
    PROPERTIES() stocks ON CHANGE { SHOW dialogDepartmentStores; }
;

DESIGN integrationData {
    supermag {
        integrationSettings {
            MOVE PROPERTY (stocks()) { caption = ''; alignment = STRETCH; }
        }        
    }
}

dateTimeChange 'Дата/время изменения' = ABSTRACT DATETIME (StockDocumentLedger);
bornin 'ИД базы создателя' = ABSTRACT STRING[100] (StockDocumentLedger);
exportSupermag 'Экспорт в супермаг' ABSTRACT (StockDocumentLedger);
exportTime (DATETIME dt)=  [FORMULA STRING[20] 'to_char(($1),\'YYYY-MM-DD\') || \'T\' || to_char(($1),\'HH24:MI:SS\')'](dt);
formulaDateT =  [FORMULA STRING[20] 'to_char(($1),\'YYYYMMDDHH24MISSMS\')']( DATETIME dt);

exportSupermagAll 'Экспорт в супермаг' ABSTRACT LIST ();

EXTEND FORM integrationData 
    PROPERTIES()  exportSupermagAll
;

DESIGN integrationData {
    pane {
        supermagExportButtons {
            MOVE PROPERTY (exportSupermagAll());   
}   }   }

docTypeSupermag 'Вид документа в супермаг' = DATA STRING[10] (Operation.Operation);
opcodeSupermag 'Код в супермаг' = DATA STRING[10] (Operation.Operation); 
useropSupermag 'Доп код в супермаг' = DATA STRING[10] (Operation.Operation); 
nameSuperMag 'Название в супермаг' = DATA STRING[200] (Operation.Operation);  
createFinobligation 'Фин.обязательство' = DATA BOOLEAN (Operation.Operation);  

contragentSupermag 'Контрагент для инвентаризаций с супермаг' = DATA LegalEntity (StockGroup);
nameContragentSupermag 'Контрагент для инвентаризаций с супермаг' (StockGroup sg) = name(contragentSupermag(sg));

EXTEND FORM stores  PROPERTIES nameContragentSupermag(s) READONLY;
EXTEND FORM store   PROPERTIES nameContragentSupermag(s);
DESIGN store {  headerExtraParams{
        MOVE PROPERTY (nameContragentSupermag(s));
}}

daysOrder 'Дней для синхронизации заказов' = DATA INTEGER ();
dateFromOrder () = sum(currentDate(), -daysOrder());
numberOrder 'Номер заказа' = DATA STRING[20] ();

daysStockDocument 'Дней для синхронизации товарных документов' = DATA INTEGER ();
dateFromStockDocument () = sum(currentDate(), -daysStockDocument());
numberStockDocument 'Номер товарного документа' = DATA STRING[20] ();

EXTEND FORM integrationData PROPERTIES daysOrder(), numberOrder(), daysStockDocument(), numberStockDocument();
DESIGN integrationData { 
    supermagImportButtons { 
        NEW orders {
            type = CONTAINERV;
            MOVE PROPERTY (daysOrder()) { alignment = CENTER; }
            MOVE PROPERTY (numberOrder()) { alignment = CENTER; }            
        } 
        NEW stockDocuments {
            type = CONTAINERV;
            MOVE PROPERTY (daysStockDocument()) { alignment = CENTER; }
            MOVE PROPERTY (numberStockDocument()) { alignment = CENTER; }            
        } 
    } 
}

//hashing (TEXT text, TEXT type2, TEXT type3) = FORMULA TEXT PG 'encode(digest($1,$2),$3)';
//hashing (TEXT text, TEXT key, TEXT type1, TEXT type2) = FORMULA TEXT PG 'encode(hmac($1,$2,$3),$4)';

CLASS SupermagLog 'История' ;
TABLE supermagLog (SupermagLog);
id 'Код' = DATA STRING[100] (SupermagLog);
dateTime 'Дата/время' = DATA DATETIME (SupermagLog);
userLogin 'Логин пользователя' = DATA STRING[100] (SupermagLog) CHARWIDTH 15; 
nameContact 'Имя пользователя' =  DATA STRING[100] (SupermagLog) IN id CHARWIDTH 15;
stockDocumentLedger 'Документ' = DATA StockDocumentLedger (SupermagLog);
action 'Действие' = DATA STRING[20] (SupermagLog);
dateTimeAnswer 'Дата/время ответа' = DATA DATETIME (SupermagLog);
errorAnswerFile 'Ошибка файла' = DATA BOOLEAN (SupermagLog);
errorAnswer 'Ошибка обработки' = DATA BOOLEAN (SupermagLog);
textError 'Текст ошибки' = DATA TEXT (SupermagLog);

supermagLog = GROUP MAX SupermagLog log BY ISTRING[100](id(log));

lastSupermagLog (StockDocumentLedger l) = GROUP LAST SupermagLog d ORDER dateTime(d), d BY stockDocumentLedger(d);
lastDateTimeSupermagLog 'Последняя выгрузка' = dateTime(lastSupermagLog (StockDocumentLedger l));     
dateTimeAnswerSupermagLog 'Дата/время ответа' = dateTimeAnswer(lastSupermagLog (StockDocumentLedger l));     
errorAnswerFileSupermagLog 'Ошибка файла' = errorAnswerFile(lastSupermagLog (StockDocumentLedger l));     
errorAnswerSupermagLog 'Ошибка обработки' = errorAnswer(lastSupermagLog (StockDocumentLedger l));   
    
isExport 'Загружен' (StockDocumentLedger d)= lastDateTimeSupermagLog(d) AND dateTimeAnswerSupermagLog(d) AND NOT (errorAnswerFileSupermagLog(d) OR errorAnswerSupermagLog(d));
banDroppedExport 'Запрещено удалять документы, которые экспортированы в супермаг' = DATA BOOLEAN ();
prevExportPosted (StockDocumentLedger l) = PREV(active(l) AND isExport(l)); 
//CONSTRAINT DROPPED (StockDocumentLedger l IS StockDocumentLedger) AND PREV(isExport(l)) AND banDroppedExport()
//    MESSAGE 'Запрещено удалять документы, которые экспортированы в супермаг';
CONSTRAINT DROPPED (isExport(StockDocumentLedger l)) AND PREV(isExport(l)) AND banDroppedExport()
    MESSAGE 'Запрещено удалять документы, которые экспортированы в супермаг';    
   
//форма документов обмена с Супермагом
FORM exportSupermag 'Экспорт в супермаг' 
    OBJECTS dates = (dFrom = DATE, dTo = DATE) PANEL
    PROPERTIES valFrom = VALUE(dFrom), valTo = VALUE(dTo)
    
    OBJECTS ol = StockDocumentLedger
    PROPERTIES(ol) READONLY isClosed, isPosted, date, nameStock,
                   oObjName = objectClassName, description,
                   nameOperation, nameLegalEntity, nameLegalEntityStock, 
                   sumItem, sumContainer, sum, dateTimeChange, lastDateTimeSupermagLog,
                   dateTimeAnswerSupermagLog,errorAnswerFileSupermagLog,errorAnswerSupermagLog, isExport
                   
    FILTERS date(ol) >= dFrom,
            date(ol) <= dTo
    ORDER date(ol), nameStock(ol)    
    FILTERGROUP open FILTER 'Открыт' isOpened(ol) 'F6'   
    FILTERGROUP post FILTER 'Проведен' active(ol) 'F7' DEFAULT 
         
    OBJECTS l = SupermagLog
    PROPERTIES (l) READONLY id, dateTime, userLogin, nameContact, dateTimeAnswer, errorAnswerFile, errorAnswer, textError
    FILTERS stockDocumentLedger(l)==ol
;
DESIGN exportSupermag {
    BOX {        
        OBJECTS {
            MOVE BOX (dates);
            NEW body {
                fill = 1;
                type = SPLITH;
                MOVE BOX(ol){
                    fill = 2;
                }
                MOVE BOX(l);
            }
        }
    }

}

//-- В планировщик
forExport = DATA LOCAL NESTED BOOLEAN (StockDocumentLedger);

exportSupermag 'Экспорт в супермаг' () {   
    IF exportDirectorySupermag() THEN {        
        forExport(StockDocumentLedger d) <- NULL;   
        forExport(StockDocumentLedger d) <- TRUE WHERE dateTimeChange(d) >= currentDateTime();   
        FOR forExport(StockDocumentLedger d) DO {
            exportSupermag(d);
        }
    } ELSE {
        MESSAGE 'Не задан путь для экспорта файлов в супермаг' NOWAIT;
    }
}

//принудительная выгрузка отфильтрованных документов
exportSupermagFilter 'Экспорт в супермаг (фильтр)'() {
    IF exportDirectorySupermag() THEN {
        FOR [ FILTER exportSupermag.ol](StockDocumentLedger l) DO {
            exportSupermag(l);
        }
    } ELSE {
        MESSAGE 'Не задан путь для экспорта файлов в супермаг';
    }
}

EXTEND FORM exportSupermag
    PROPERTIES (ol) exportSupermag TOOLBAR 
    PROPERTIES () exportSupermagFilter TOOLBAR DRAW ol
;

NAVIGATOR {
    stockReports {
        NEW exportSupermag;
    }
}

paymentPeriod (INTEGER days, INTEGER bank) = GROUP MAX PaymentPeriod p IF percent(p) == 100 
    AND type(paymentCondition(p)) == AgreementPaymentType.prepayment AND bank == (OVERRIDE 1 IF bankingDays(p), 0) BY countDays(p);


id = DATA LOCAL ISTRING[50] (INTEGER);
idDoc = DATA LOCAL ISTRING[50] (INTEGER);
idDet = DATA LOCAL ISTRING[50] (INTEGER);
docType = DATA LOCAL ISTRING[100] (INTEGER);
docNumber = DATA LOCAL ISTRING[50] (INTEGER);
operCode = DATA LOCAL INTEGER (INTEGER);
userOp = DATA LOCAL INTEGER (INTEGER);
bornIn = DATA LOCAL STRING[100] (INTEGER);
docDate = DATA LOCAL DATETIME (INTEGER);
dateFrom  = DATA LOCAL DATETIME (INTEGER);
dateTo  = DATA LOCAL DATETIME (INTEGER);
docState = DATA LOCAL INTEGER (INTEGER);
clientIndex = DATA LOCAL INTEGER (INTEGER);
locationTo = DATA LOCAL INTEGER (INTEGER);
locationFrom = DATA LOCAL INTEGER (INTEGER);
location = DATA LOCAL INTEGER (INTEGER);
paymentDelay = DATA LOCAL INTEGER (INTEGER);
isCalendarDelay = DATA LOCAL ISTRING[1] (INTEGER);
isBankDays = DATA LOCAL INTEGER (INTEGER);
comment = DATA LOCAL ISTRING[255] (INTEGER);
suppldocSum = DATA LOCAL NUMERIC[16,4] (INTEGER);
currentVersion = DATA LOCAL STRING (INTEGER);
codeOperation = DATA LOCAL STRING (INTEGER);
idBase = DATA LOCAL STRING (INTEGER);
baseNumber = DATA LOCAL STRING[50] (INTEGER);
baseDoctype = DATA LOCAL STRING (INTEGER);

specItem = DATA LOCAL INTEGER (INTEGER);
itemPrice = DATA LOCAL NUMERIC[19,4](INTEGER);
itemPriceNoTax = DATA LOCAL NUMERIC[19,4](INTEGER);
totalPrice = DATA LOCAL NUMERIC[19,4](INTEGER);
totalPriceNoTax = DATA LOCAL NUMERIC[19,4](INTEGER);
taxSum = DATA LOCAL NUMERIC[18,4](INTEGER);
taxRate = DATA LOCAL NUMERIC[10,5](INTEGER);
quantity = DATA LOCAL NUMERIC[14,3](INTEGER);
idItem = DATA LOCAL ISTRING[50](INTEGER);
priceManufacturer = DATA LOCAL NUMERIC[16,4] (INTEGER);
retailPrice = DATA LOCAL NUMERIC[16,4] (INTEGER); 

filterSql = DATA LOCAL TEXT ();
file = DATA LOCAL FILE ();

GROUP POSTOBJECT;
GROUP TOTALPACKAGE;

idDoc = DATA LOCAL STRING();
ERROR = DATA LOCAL STRING(INTEGER);
POSTOBJECTERROR = DATA LOCAL INTEGER(INTEGER);
ERROR1 = DATA LOCAL STRING(INTEGER);
TOTALPACKAGEERROR1 = DATA LOCAL INTEGER(INTEGER);
nameDoc = DATA LOCAL STRING();
packageType = DATA LOCAL STRING();

FORM REPLY
PROPERTIES() nameDoc ATTR, packageType ATTR
PROPERTIES() IN POSTOBJECT idDoc EXTID 'Id'

OBJECTS ERROR = INTEGER IN POSTOBJECT
PROPERTIES(ERROR) ERROR EXTID 'value'

OBJECTS ERROR1 = INTEGER EXTID 'ERROR' IN TOTALPACKAGE
PROPERTIES(ERROR1) ERROR1 EXTID 'value';

importAnswer 'Импорт ответов из супермаг'()  { 
    IF   importDirectorySupermag() THEN {  
        LOCAL importName = ISTRING[100] (INTEGER ); 
        
        fileName(INTEGER i)<- NULL;    
        listFiles('file://' + importDirectorySupermag());
        
        fileName(INTEGER i)<- NULL WHERE fileName(i) AND NOT isISubstring(fileName(i),'.Reply');    
        importName(INTEGER i)<- ISTRING[100](replace(replace(upper(fileName(i)),'.REPLY',''), '.XML','')) WHERE fileName(i) ;    
            
        FOR importName(INTEGER j) AND NOT fileIsDirectory(j) AND supermagLog(importName(j)) == SupermagLog log  DO NEWSESSION NESTED (fileName[INTEGER], importName[INTEGER]) {
            dateTimeAnswer(log) <- NULL;
            errorAnswerFile(log) <- NULL;
            errorAnswer(log) <- NULL;
            textError(log) <- NULL;
            LOCAL importFile = XMLFILE (); 
            
            TRY {
                READ 'file://' + importDirectorySupermag() + '/' + fileName(j) TO importFile;
                IMPORT REPLY XML FROM importFile();
            } CATCH {
                dateTimeAnswer(log)<- currentDateTime();
                errorAnswerFile(log) <- TRUE;
                logToFile('supermagAnswer', CONCAT '\n', 'file://' + fileName(j) + ' ParseMessage error:', messageCaughtException(), javaStackTraceCaughtException(), lsfStackTraceCaughtException());
                APPLY;
                RETURN;    
            }
            dateTimeAnswer(log)<- currentDateTime();
            IF (GROUP SUM 1 IF ERROR(INTEGER ii)) OR (GROUP SUM 1 IF ERROR1(INTEGER ii)) THEN {            
                errorAnswer(log)<- TRUE;                      
                textError(log) <- CONCAT '\n', (GROUP CONCAT ERROR(INTEGER ii) IF ERROR(ii), '\n'), 
                                                (GROUP CONCAT ERROR1(INTEGER ii) IF ERROR1(ii), '\n');  
            } 
            APPLY NESTED (fileName[INTEGER], importName[INTEGER]); 
          
            delete('file://' + importDirectorySupermag() + '/' + fileName(j));
            fileName(j) <- NULL;
            importName(j) <- NULL;                
            
        }
    } ELSE {
        MESSAGE 'Не задан путь для загрузки из супермаг' NOWAIT ;
    }
}
EXTEND FORM exportSupermag
    PROPERTIES () importAnswer TOOLBAR DRAW l
;

EXTEND FORM integrationData 
    PROPERTIES() importAnswer, banDroppedExport
;
DESIGN integrationData {
    supermagExportButtons {    
        MOVE PROPERTY (importAnswer());       
        MOVE PROPERTY (banDroppedExport());         
    }    
}

@defineLogRotate(supermag, 5, weekly);

// контроль статусов документов в супермаге
daysStatus 'Дней для синхронизации заказов' = DATA INTEGER ();
dateFromStatus () = sum(currentDate(), -daysStatus());

overCheckDocStatusSupermag ABSTRACT LIST();

docStatusId = DATA LOCAL ISTRING[50] (INTEGER);
docStatusType = DATA LOCAL ISTRING[20] (INTEGER);
docStatusOpcode = DATA LOCAL INTEGER (INTEGER);
docStatusUserop = DATA LOCAL INTEGER (INTEGER);
docStatusBornin = DATA LOCAL ISTRING[100] (INTEGER);
docLocationFrom = DATA LOCAL INTEGER (INTEGER);
docStatusState = DATA LOCAL INTEGER (INTEGER);
maxDocStatusState = DATA LOCAL INTEGER (STRING);

checkDocStatusSupermag 'Контроль статусов документов в Супермаг' () { 
    LOCAL filterSql = TEXT ();
    LOCAL file = FILE ();           
              
    EXTERNAL SQL 'jdbc:oracle:thin:' + SupermagSettings.login() + '/' + SupermagSettings.password() + '@//'+ SupermagSettings.host() + '/' + SupermagSettings.base() 
    EXEC 'SELECT d.ID, d.DOCTYPE, d.OPCODE, d.USEROP, d.DOCSTATE, d.LOCATIONFROM FROM Supermag.SMDocuments d WHERE d.CREATEDAT >= TO_DATE(\'' + toDateISO(dateFromStatus()) + '\',\'YYYY-MM-DD\')' TO file;
    
    IMPORT TABLE FROM file() TO docStatusId, docStatusType, docStatusOpcode, docStatusUserop, docStatusState, docLocationFrom;
    
    maxDocStatusState(STRING idDoc) <- [GROUP MAX docStatusState(INTEGER i) BY docStatusId(i)](idDoc);
    
    overCheckDocStatusSupermag();
    
    APPLY;
}

