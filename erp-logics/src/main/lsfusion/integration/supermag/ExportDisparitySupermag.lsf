MODULE ExportDisparitySupermag;

REQUIRE Disparity, ExportSupermag, DisparityOperation;

NAMESPACE Disparity;

EXTEND FORM operation
    PROPERTIES (o) docTypeSupermag, opcodeSupermag, useropSupermag
;
DESIGN operation{
    propertyContainer {
        MOVE PROPERTY(docTypeSupermag(o));
        MOVE PROPERTY(opcodeSupermag(o));
        MOVE PROPERTY(useropSupermag(o));
    }
}

EXTEND FORM operations
    PROPERTIES (o) READONLY docTypeSupermag, opcodeSupermag, useropSupermag
;

//---------------------- Изменение остатков код операции (-1)
GROUP LA;
GROUP SMDOCUMENTS: LA;

inc = DATA LOCAL BOOLEAN (Disparity);

dateTimeChange = DATA DATETIME (Disparity);
dateTimeChange[StockDocumentLedger](Disparity i) += dateTimeChange(i);

changeDoc(Disparity d) = CHANGED(seriesNumber(d))OR CHANGED(stock(d))  OR CHANGED(dateTime(d)) OR CHANGED(operation(d)) OR CHANGED(isPosted(d));

changeDoc(DisparityDetail d) = CHANGED(quantity( d)) OR CHANGED(sku(d)) OR CHANGED(price(d)) OR CHANGED(sum(d)) OR CHANGED(inputSku(d)) OR CHANGED(inputQuantity(d)); 
changeDocDetail(Disparity i) = GROUP SUM 1 IF changeDoc(DisparityDetail d) AND disparity(d)==i;

WHEN SET(changeDoc(Disparity i)) OR SET (changeDocDetail(i)) DO {
    dateTimeChange(i)<- currentDateTime();  
}

FORM exportDisparityMagN FORMEXTID 'PACKAGE'  
    PROPERTIES ATTR = exportTime(currentDateTime())  EXTID 'name'

    OBJECTS i = Disparity EXTID 'POSTOBJECT'
    PROPERTIES ATTR = 'Акт потерь' IF i IS Disparity EXTID 'description'  
    PROPERTIES ATTR = 'normal' IF i IS Disparity EXTID 'action'      
    
    PROPERTIES = STRING[100]('LA'+seriesNumber(i)) EXTID 'Id'
    PROPERTIES = STRING[100](STRING[100](seriesNumber(i))) EXTID 'ID' IN SMDOCUMENTS
    PROPERTIES = 'LA' IF i IS Disparity EXTID 'DOCTYPE' IN SMDOCUMENTS    
    PROPERTIES = idSupermag(stock(i)) EXTID 'BORNIN' IN SMDOCUMENTS    
    PROPERTIES = exportTime(dateTime(i))  EXTID 'CREATEDAT' IN SMDOCUMENTS    
    PROPERTIES = 0 IF i IS Disparity EXTID 'CURRENCYMULTORDER' IN SMDOCUMENTS      
    PROPERTIES = 1 IF i IS Disparity  EXTID 'CURRENCYRATE' IN SMDOCUMENTS 
    PROPERTIES = 1 IF i IS Disparity EXTID 'CURRENCYTYPE' IN SMDOCUMENTS        
    PROPERTIES = IF isPosted(i) THEN 3 ELSE 2 EXTID 'DOCSTATE' IN SMDOCUMENTS           
    PROPERTIES = 1 IF i IS Disparity  EXTID 'ISROUBLES' IN SMDOCUMENTS      
    PROPERTIES = id(stock(i)) EXTID 'LOCATION' IN SMDOCUMENTS  
    PROPERTIES = opcodeSupermag(operation(i))  EXTID 'OPCODE' IN SMDOCUMENTS  
    PROPERTIES = 0 IF i IS Disparity  EXTID 'PRICEROUNDMODE' IN SMDOCUMENTS       
    PROPERTIES = 0 IF i IS Disparity EXTID 'TOTALSUM' IN SMDOCUMENTS    
    PROPERTIES = 0 IF i IS Disparity EXTID 'TOTALSUMCUR' IN SMDOCUMENTS    
    PROPERTIES = 'Документ изменения сортности' IF i IS Disparity EXTID 'COMMENTARY' IN SMDOCUMENTS  

    OBJECTS d = DisparityDetail   EXTID 'SMSPEC' IN LA
    PROPERTIES = STRING[100](seriesNumber(disparity(d))) EXTID 'DOCID'    
    PROPERTIES = 'LA' IF d IS DisparityDetail EXTID 'DOCTYPE'      
    PROPERTIES = index(d) EXTID 'SPECITEM'        
    PROPERTIES = idSku(d) EXTID 'ARTICLE'                          
    PROPERTIES d1= index(d) EXTID 'DISPLAYITEM'  
    PROPERTIES = quantity(d) EXTID 'QUANTITY'      
    PROPERTIES = 0 IF d IS DisparityDetail EXTID 'TOTALPRICE'  
    PROPERTIES = 0 IF d IS DisparityDetail EXTID 'TOTALPRICECUR'      
    PROPERTIES = 0 IF d IS DisparityDetail EXTID 'TOTALPRICENOTAX'            
    FILTERS disparity(d)==i,            
            inc(i)                                           
; 

GROUP FA;
GROUP SMDOCUMENTS1 EXTID 'SMDOCUMENTS': FA;


FORM exportDisparityMagP FORMEXTID 'PACKAGE'  
    PROPERTIES ATTR = exportTime(currentDateTime())  EXTID 'name'

    OBJECTS i = Disparity EXTID 'POSTOBJECT'
    PROPERTIES ATTR = 'Акт обнаружений' IF i IS Disparity EXTID 'description'  
    PROPERTIES ATTR = 'normal' IF i IS Disparity EXTID 'action'      
    
    PROPERTIES = STRING[100]('FA'+seriesNumber(i)) EXTID 'Id'
    PROPERTIES = STRING[100](STRING[100](seriesNumber(i))) EXTID 'ID' IN SMDOCUMENTS1
    PROPERTIES = 'FA' IF i IS Disparity EXTID 'DOCTYPE' IN SMDOCUMENTS1    
    PROPERTIES = idSupermag(stock(i)) EXTID 'BORNIN' IN SMDOCUMENTS1    
    PROPERTIES = exportTime(dateTime(i))  EXTID 'CREATEDAT' IN SMDOCUMENTS1    
    PROPERTIES = 0 IF i IS Disparity EXTID 'CURRENCYMULTORDER' IN SMDOCUMENTS1      
    PROPERTIES = 1 IF i IS Disparity  EXTID 'CURRENCYRATE' IN SMDOCUMENTS1 
    PROPERTIES = 1 IF i IS Disparity EXTID 'CURRENCYTYPE' IN SMDOCUMENTS1        
    PROPERTIES = IF isPosted(i) THEN 3 ELSE 2 EXTID 'DOCSTATE' IN SMDOCUMENTS1           
    PROPERTIES = 1 IF i IS Disparity  EXTID 'ISROUBLES' IN SMDOCUMENTS1      
    PROPERTIES = id(stock(i)) EXTID 'LOCATION' IN SMDOCUMENTS1  
    PROPERTIES = opcodeSupermag(operation(i))  EXTID 'OPCODE' IN SMDOCUMENTS1  
    PROPERTIES = 0 IF i IS Disparity  EXTID 'PRICEROUNDMODE' IN SMDOCUMENTS1       
    PROPERTIES = 0 IF i IS Disparity EXTID 'TOTALSUM' IN SMDOCUMENTS1    
    PROPERTIES = 0 IF i IS Disparity EXTID 'TOTALSUMCUR' IN SMDOCUMENTS1      
    PROPERTIES = 'Документ изменения сортности' IF i IS Disparity EXTID 'COMMENTARY' IN SMDOCUMENTS1  
                                                                
    OBJECTS d = InputDisparityDetail   EXTID 'SMSPEC' IN FA
    PROPERTIES = STRING[100](seriesNumber(disparity(disparityDetail(d)))) EXTID 'DOCID'    
    PROPERTIES = 'FA' IF d IS InputDisparityDetail EXTID 'DOCTYPE'      
    PROPERTIES = index(disparityDetail(d)) EXTID 'SPECITEM'        
    PROPERTIES = id(sku(d)) EXTID 'ARTICLE'                          
    PROPERTIES d1= index(disparityDetail(d)) EXTID 'DISPLAYITEM'  
    PROPERTIES = quantity(d) EXTID 'QUANTITY'      
    PROPERTIES = 0 IF d IS InputDisparityDetail EXTID 'TOTALPRICE'  
    PROPERTIES = 0 IF d IS InputDisparityDetail EXTID 'TOTALPRICECUR'      
    PROPERTIES = 0 IF d IS InputDisparityDetail EXTID 'TOTALPRICENOTAX'            
    FILTERS disparity(disparityDetail(d))==i,            
            inc(i)                                          
; 


exportDisparityMag 'Экспорт в супермаг' (Disparity i) {
    inc(Disparity ii) <- NULL;
    inc(i) <- TRUE WHERE opcodeSupermag(operation(i)) AND idSupermag(stock(i));    
    LOCAL NESTED dt = DATETIME();
    dt () <- currentDateTime();
    IF (GROUP SUM 1 IF inc(Disparity ii)) THEN{    
        TRY{
            EXPORT exportDisparityMagN XML TO System.exportFile;
            WRITE System.exportFile() TO 'file://' + exportDirectorySupermag() + '/' + 'LA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt());  
            fileExists('file://' + exportDirectorySupermag() + '/' + 'LA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) + '.xml'); 
            IF fileExists()  THEN NEWSESSION NESTED LOCAL {
                FOR inc(Disparity ii)  DO NEW log = SupermagLog {
                    id(log)<- 'LA_' +STRING[30](LONG(ii))+'_'+(OVERRIDE seriesNumber(ii), '')+'_'+ formulaDateT(dt());  
                    dateTime(log) <- currentDateTime();
                    userLogin(log) <- login(currentUser()); 
                    nameContact(log) <- STRING[100](name(currentUser()));
                    stockDocumentLedger(log)<- ii;
                }     
                APPLY NESTED LOCAL;
            }             
                 
        } CATCH {
            logToFile('supermag', CONCAT '\n', 'Акт потерь', 'file://' + exportDirectorySupermag() + '/' + 'LA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) + ' ParseMessage error:', messageCaughtException(), javaStackTraceCaughtException(), lsfStackTraceCaughtException());
            MESSAGE  'Акт потерь. Ошибка при экспорте LA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) +'. Обратитесь к администратору' NOWAIT;        
        }             
        TRY{
            EXPORT exportDisparityMagP XML TO System.exportFile;
            WRITE System.exportFile() TO 'file://' + exportDirectorySupermag() + '/' + 'FA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt());  
            fileExists('file://' + exportDirectorySupermag() + '/' + 'FA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) + '.xml'); 
            IF fileExists()  THEN NEWSESSION NESTED LOCAL {
                FOR inc(Disparity ii)  DO NEW log = SupermagLog {
                    id(log)<- 'FA_' +STRING[30](LONG(ii))+'_'+(OVERRIDE seriesNumber(ii), '')+'_'+ formulaDateT(dt());  
                    dateTime(log) <- currentDateTime();
                    userLogin(log) <- login(currentUser()); 
                    nameContact(log) <- STRING[100](name(currentUser()));
                    stockDocumentLedger(log)<- ii;
                }     
                APPLY NESTED LOCAL;
            }             
                 
        } CATCH {
            logToFile('supermag', CONCAT '\n', 'Акт обнаружений', 'file://' + exportDirectorySupermag() + '/' + 'FA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) + ' ParseMessage error:', messageCaughtException(), javaStackTraceCaughtException(), lsfStackTraceCaughtException());
            MESSAGE  'Акт обнаружений. Ошибка при экспорте FA_' +STRING[30](LONG(i))+'_'+(OVERRIDE seriesNumber(i), '')+'_'+ formulaDateT(dt()) +'. Обратитесь к администратору' NOWAIT;        
        }         
        
    

    }   
    inc(Disparity ii) <- NULL;
}
exportSupermag(Disparity s) +{
    exportDisparityMag(s);
}

exportSupermagAll() +{
    FOR date(Disparity s AS Disparity) > sum(currentDate(),-countDaysExportData()) AND dateTimeChange(s) AND NOT (dateTimeChange(s) <lastDateTimeSupermagLog(s)) AND opcodeSupermag(operation(s)) DO {
        exportDisparityMag(s);
    }
}

EXTEND FORM disparities
    PROPERTIES (dis) exportDisparityMag TOOLBAR 
;
DESIGN disparities {
    actionContainer{
        NEW mag {
            caption = 'Супермаг';
            MOVE PROPERTY (exportDisparityMag(dis));
        }        
    }
}
