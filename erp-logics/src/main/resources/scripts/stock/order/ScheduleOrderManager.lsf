MODULE ScheduleOrderManager;

META defineScheduleOrderManager(managed, filter)

managerScheduleOrder = DATA Employee (ScheduleOrder);
nameManagerScheduleOrder 'Менеджер' (scheduleOrder) = shortNameContact(managerScheduleOrder(scheduleOrder));

managerScheduleOrderDetail (scheduleOrderDetail) = managerScheduleOrder(scheduleOrderScheduleOrderDetail(scheduleOrderDetail));

countInManagersEmployeeScheduleOrder (e, s) = GROUP SUM 1 IF inManagerEmployee(m, e) AND m == managerScheduleOrder(s) BY e, s;
inManagerEmployeeScheduleOrder (e, s) = TRUE IF countInManagersEmployeeScheduleOrder (e, s) OR e==managerScheduleOrder(s);

countInManagersEmployeeOrder (e, o) = GROUP SUM 1 IF inManagerEmployee(m, e) AND m == overManagerLegalEntityStock(managed##Order(o), filter##StockOrder(o)) BY e, s;
inManagerEmployeeOrder (e, o) = TRUE IF countInManagersEmployeeOrder (e, o) OR e == overManagerLegalEntityStock(managed##Order(o), filter##StockOrder(o));

EXTEND FORM scheduleOrder PROPERTIES (s) nameManagerScheduleOrder;

DESIGN scheduleOrder {
    header {
        NEW managerContainer {
            caption = 'Менеджмент';
            MOVE PROPERTY (nameManagerScheduleOrder(s));
        }
    }
}

WHEN SETCHANGED (managed##ScheduleOrder(s)) DO managerScheduleOrder(s) <- managerLegalEntity(managed##ScheduleOrder(s));

EXTEND FORM scheduleOrderDashboard
    FILTERS inManagerEmployeeScheduleOrder(currentUser(), s) OR NOT managerScheduleOrder(s)
    FILTERS inManagerEmployeeScheduleOrder(currentUser(), ss) OR NOT managerScheduleOrder(ss);

EXTEND FORM scheduleOrderDetails
    FILTERS inManagerEmployeeScheduleOrder(currentUser(), scheduleOrderScheduleOrderDetail(sd)) OR NOT managerScheduleOrderDetail(sd)
    FILTERS inManagerEmployeeOrder(currentUser(),o) OR NOT overManagerLegalEntityStock(managed##Order(o), filter##StockOrder(o));
    

END