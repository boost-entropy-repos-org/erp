MODULE DisparityDashboard;

REQUIRE DisparityOperation, Dashboard, TaxItem;

NAMESPACE Disparity;

//АРМ уценки
disparityQuantity 'Кол-во' = DATA LOCAL NUMERIC[14,3] (Item, Stock);
disparityPrice 'Цена' = DATA LOCAL NUMERIC[16,2] (Item, Stock);

backgroundDisparityQuantity (Item item, Stock stock) = RGB(212,255,212) IF item IS Item AND stock IS Stock;

disparityQuantity = GROUP SUM disparityQuantity(Item item, Stock stock) BY stock;

overCreateItemStock = ACTION ABSTRACT LIST (Item, Stock, DisparityDetail);

createDisparity 'Создать уценку'(Stock stock, Operation operation) = ACTION {
    NEWSESSION NESTED disparityQuantity[Item,Stock], disparityPrice[Item,Stock] {
        FOR ADDOBJ d = Disparity DO {
            operation(d) <- operation;
            stock(d) <- stock;
            date(d) <- currentDate();
            time(d) <- currentTime();
            
            FOR disparityQuantity(Item item, stock) ADDOBJ dd = DisparityDetail DO {
                disparity(dd) <- d;
                sku(dd) <- item;
                batch(dd) <- defaultBatch(item, stock);
                quantity(dd) <- disparityQuantity(item, stock); 
                FOR ADDOBJ i = Item DO {
                    copyDisparityData(item, i);
                    inputSku(dd) <- i;
                }  
                inputPrice(dd) <- disparityPrice(item, stock);
                overCreateItemStock (item, stock, dd);
            }
            
            FORM disparity OBJECTS dis=d MANAGESESSION DOCKEDMODAL;
        }     
    }
} TOOLBAR;

FORM disparityItemItemDashboard 'Уценки'
    OBJECTS dt = DATE FIXED PANEL
    PROPERTIES (dt) OBJVALUE 
    
    OBJECTS s = Stock FIXED PANEL
    PROPERTIES(s) name SELECTOR
    FILTERS isCompany(s)
    
    OBJECTS o = Operation FIXED PANEL
    PROPERTIES (o) name SELECTOR
   
    OBJECTS i=Item
    PROPERTIES (i) READONLY idBarcode, name
    PROPERTIES(i, s) READONLY currentBalance, averagePrice, currentSum, 
                     averageCostPriceBatch
    PROPERTIES (i) valueVAT                
    PROPERTIES(i, s) disparityQuantity BACKGROUND backgroundDisparityQuantity(i, s),
                     disparityPrice BACKGROUND backgroundDisparityQuantity(i, s)
    ORDER BY name(i)
    FILTERS currentBalance(i, s) AND NOT disparityItem(i)
    FILTERGROUP baseFilter
        FILTER 'Позиции с уценкой'countItemDisparity(i) 'F9' 
    
    PROPERTIES (s, o) createDisparity TODRAW i SHOWIF disparityQuantity(s)
        
    OBJECTS di=Item
    PROPERTIES (di) READONLY idBarcode, name
    PROPERTIES (di, s) READONLY currentBalance, averageCostPriceBatch, averagePrice, currentSum  
    FILTERS disparityItem(di)==i, currentBalance(di, s)  
       
    OBJECTS dis = Disparity
    PROPERTIES (dis) READONLY isClosed, isPosted, number, series, date, time, nameStock
    PROPERTIES(dis)  READONLY countDisparityDetail, quantityDisparityDetail, sumDisparityDetail,
                              inputQuantityDisparityDetail, inputSumDisparityDetail, note

    PROPERTIES (dis) ADDFORM, EDITFORM SHOWIF isOpened(dis)
    PROPERTIES(dis)  close SHOWIF isOpened(dis), open SHOWIF isClosed(dis)     
    
    PROPERTIES (dis) deleted=DELETE FORCE PANEL TOOLBAR SHOWIF isOpened(dis)
    FILTERGROUP bdisparityFilter
        FILTER 'Уценки на дату' date(dis)==dt 'F8' DEFAULT
;

DESIGN disparityItemItemDashboard {
    main{
        NEW top {
            type = CONTAINERH;
            MOVE dt.box;
            MOVE s.box;
            MOVE o.box;
        }    
        NEW balanceContainer {
            type = CONTAINERV;
            fill = 1;
            caption = 'Товары';
            MOVE i.box;
        }
        NEW disparityContainer {
            fill = 1;
            type = TABBED;
            NEW disparityItemContainer {
                type = CONTAINERV;
                fill = 1;
                caption = 'Уцененные товары';
                MOVE di.box;
            }
            NEW disparityDocContainer {
                type = CONTAINERV;
                fill = 1;
                caption = 'Документы уценки';
                MOVE dis.box;      
            }
        }
        MOVE functions.box;
    }
}

NAVIGATOR {
    dashboardNavigator {
        NEW disparityDashboard 'Уценка' {
            ADD disparityItemItemDashboard;
        }    
    }
}