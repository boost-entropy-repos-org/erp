MODULE StockDocumentSkuLedger;

REQUIRE StockDocument, SkuLedger;

NAMESPACE Stock;

stockDocumentLedgerSkuLedger = ABSTRACT StockDocumentLedger (SkuLedger) PERSISTENT;

numberDocumentSkuLedger 'Номер документа' (ledger) = numberStockDocumentLedger(stockDocumentLedgerSkuLedger(ledger)) MINCHARWIDTH 8;
seriesDocumentSkuLedger 'Серия документа' (ledger) = seriesStockDocumentLedger(stockDocumentLedgerSkuLedger(ledger)) FIXEDCHARWIDTH 3;

legalEntityDocumentSkuLedger (ledger) = legalEntityStockDocumentLedger(stockDocumentLedgerSkuLedger(ledger)); 
nameLegalEntityDocumentSkuLedger 'Контрагент' (ledger) = nameLegalEntity(legalEntityDocumentSkuLedger(ledger));
overNameLegalEntityDocumentSkuLedger 'Контрагент' (ledger) = OVERRIDE 'Не задан', nameLegalEntityDocumentSkuLedger(ledger);

legalEntityStockDocumentSkuLedger (ledger) = legalEntityStockStockDocumentLedger(stockDocumentLedgerSkuLedger(ledger));
nameLegalEntityStockDocumentSkuLedger 'Склад контрагента' (ledger) = nameStock(legalEntityStockDocumentSkuLedger(ledger));
overNameLegalEntityStockDocumentSkuLedger 'Склад контрагента' (ledger) = OVERRIDE 'Не задан', nameLegalEntityStockDocumentSkuLedger(ledger);

operationDocumentSkuLedger (ledger) = operationStockDocumentLedger(stockDocumentLedgerSkuLedger(ledger));
nameOperationDocumentSkuLedger 'Операция' (ledger) = nameOperation(operationDocumentSkuLedger (ledger));
overNameOperationDocumentSkuLedger 'Операция' (ledger) = OVERRIDE 'Не задана',  nameOperationDocumentSkuLedger(ledger);

EXTEND FORM costSkuLedger
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE quantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM costSkuBatchLedger
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE quantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM currentBalanceSkuStock
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE signedQuantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM balanceSkuStock
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE signedQuantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM currentBalanceBatchStock
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE signedQuantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM balanceBatchStock
    PROPERTIES(bil) READONLY AFTER dateTimeSkuLedger(bil) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(bil) READONLY BEFORE signedQuantitySkuLedger(bil) nameLegalEntityDocumentSkuLedger, nameLegalEntityStockDocumentSkuLedger
;

EXTEND FORM skuLedger
    PROPERTIES(s) READONLY AFTER dateTimeSkuLedger(s) seriesDocumentSkuLedger, numberDocumentSkuLedger
    PROPERTIES(s) READONLY BEFORE signedQuantitySkuLedger(s) overNameOperationDocumentSkuLedger, overNameLegalEntityDocumentSkuLedger, overNameLegalEntityStockDocumentSkuLedger
;

// --------- Суммы по документу ------------//

sumSkuLedgerStockDocumentLedger 'Сумма по регистру' = GROUP SUM signedSumSkuLedger(l) BY stockDocumentLedgerSkuLedger(l);

EXTEND FORM sumStockDocumentLedger
    PROPERTIES(il) sumSkuLedgerStockDocumentLedger
    FILTERGROUP incorrectIncSum FILTER 'Неправильная сумма по регистру' 'F7' NOT sumIncStockDocumentLedger(il) == sumSkuLedgerStockDocumentLedger(il)

    PROPERTIES(ol) sumSkuLedgerStockDocumentLedger
    FILTERGROUP incorrectOutSum FILTER 'Неправильная сумма по регистру' 'F7' NOT sumOutStockDocumentLedger(ol) == -sumSkuLedgerStockDocumentLedger(ol)
;