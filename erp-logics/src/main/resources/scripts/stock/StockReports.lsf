MODULE StockReports;

REQUIRE Stock, Barcode, PriceListLedger;

dataInSessionGroup 'Отм.' = DATA SESSION BOOLEAN (Group);

levelParentGroup (group) = GROUP MIN levelGroupGroup(group, parent) IF dataInSessionGroup(parent)
    BY group PERSISTENT;

inParentGroup (group) = TRUE IF levelParentGroup(group) PERSISTENT;

inSessionGroup 'Отм.' (group) = OVERRIDE
    inParentGroup(group),
    dataInSessionGroup(group);

sessionConcatGroups 'Склады' (groupType) =
    GROUP CONCAT nameGroup(group) IF inSessionGroup(group) AND NOT inSessionGroup(parentGroup(group)),','
    BY groupTypeGroup(group);

//остатки по товарам
FORM printListBalanceSkusStock 'Остатки по товарам' PRINT
    OBJECTS d = DATE FIXED PANEL
    PROPERTIES(d) OBJVALUE

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt) READONLY sessionConcatGroups

    TREE sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup
    FILTERS inSessionGroup(sk) AND isLeafGroup(sk)
    FILTERS groupTypeGroup(sk) == gt
    PROPERTIES(sk, st, d) READONLY sumASkuGroupStockDate

    OBJECTS s = Sku
    PROPERTIES(s) READONLY idBarcodeSku, nameSku, shortNameUOMSku
    ORDER BY nameSku
    FILTERS isParentGroupSku(sk, s)

    PROPERTIES(s, st, d) READONLY balanceASkuStockDate, sumASkuStockDate
    FILTERS balanceASkuStockDate(s, st, d)
;

printListBalanceSkusStockDate 'Списком' (stock, date) =
    ACTION FORM printListBalanceSkusStock OBJECTS st = stock, d = date  IMAGE 'print.png' IN printGroup;

FORM printBalanceSkusStock 'Остатки по товарам' PRINT
    OBJECTS d = DATE FIXED PANEL
    PROPERTIES(d) OBJVALUE

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup
    FILTERS inSessionGroup(sk) AND isLeafGroup(sk)
    FILTERS groupTypeGroup(sk) == gt
    PROPERTIES(sk, st, d) READONLY sumASkuGroupStockDate

    OBJECTS s = Sku
    PROPERTIES(s) READONLY idBarcodeSku, nameSku, shortNameUOMSku
    ORDER BY nameSku
    FILTERS isParentGroupSku(sk, s)

    PROPERTIES(s, st, d) READONLY balanceASkuStockDate, sumASkuStockDate
    FILTERS balanceASkuStockDate(s, st, d)
;

printBalanceSkusStockDate 'По группам' (stock, date) =
    ACTION FORM printBalanceSkusStock OBJECTS st = stock, d = date  IMAGE 'print.png' IN printGroup;

//остатки по партиям
FORM printListBalanceBatchesStock 'Остатки по партиям' PRINT
    OBJECTS d = DATE FIXED PANEL
    PROPERTIES(d) OBJVALUE

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt) READONLY sessionConcatGroups

    TREE sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup
    FILTERS inSessionGroup(sk) AND isLeafGroup(sk)
    FILTERS groupTypeGroup(sk) == gt
    PROPERTIES(sk, st, d) READONLY costSumASkuGroupBatchStockDate

    OBJECTS           bt=Batch
    PROPERTIES(bt)    READONLY dateBatch, nameBatch, idBarcodeSkuBatch, nameSkuBatch, shortNameUOMBatch//, quantityBatch
    FILTERS           isParentGroupBatch(sk, bt)
    ORDER BY          dateBatch, nameBatch, nameSkuBatch

    PROPERTIES(bt, st, d) READONLY balanceABatchStockDate, costSumABatchStockDate
    FILTERS balanceABatchStockDate(bt, st, d)
;

printListBalanceBatchesStockDate 'Списком' (stock, date) =
    ACTION FORM printListBalanceBatchesStock OBJECTS st = stock, d = date  IMAGE 'print.png' IN printGroup;

FORM printBalanceBatchesStock 'Остатки по партиям' PRINT
    OBJECTS d = DATE FIXED PANEL
    PROPERTIES(d) OBJVALUE

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup
    FILTERS inSessionGroup(sk) AND isLeafGroup(sk)
    FILTERS groupTypeGroup(sk) == gt
    PROPERTIES(sk, st, d) READONLY costSumASkuGroupBatchStockDate

    OBJECTS           bt=Batch
    PROPERTIES(bt)    READONLY dateBatch, nameBatch, idBarcodeSkuBatch, nameSkuBatch, shortNameUOMBatch//, quantityBatch
    FILTERS           isParentGroupBatch(sk, bt)
    ORDER BY          dateBatch, nameBatch, nameSkuBatch

    PROPERTIES(bt, st, d) READONLY balanceABatchStockDate, costSumABatchStockDate
    FILTERS balanceABatchStockDate(bt, st, d)
;

printBalanceBatchesStockDate 'По группам' (stock, date) =
    ACTION FORM printBalanceBatchesStock OBJECTS st = stock, d = date  IMAGE 'print.png' IN printGroup;

FORM reportBalanceStock 'Отчет по остаткам'
    OBJECTS d=DATE FIXED PANEL
    PROPERTIES(d) OBJVALUE

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
//    PROPERTIES(gt) READONLY sessionConcatGroups

    TREE skuTree sk = Group PARENT parentGroup
    PROPERTIES READONLY skuTreeName = nameGroup(sk)
    PROPERTIES(sk, st, d) READONLY sumASkuGroupStockDate, costSumASkuGroupBatchStockDate
    PROPERTIES inSessionGroup(sk)
    ORDER BY skuTreeName
    FILTERS groupTypeGroup(sk) == gt

    OBJECTS s = Sku
    PROPERTIES(s) READONLY idBarcodeSku, nameSku, shortNameUOMSku
    ORDER BY nameSku
    FILTERS isParentGroupSku(sk, s)

    PROPERTIES(s, st, d) READONLY balanceASkuStockDate, sumASkuStockDate
    PROPERTIES(st, d) printListBalanceSkusStockDate, printBalanceSkusStockDate
    FILTERS balanceASkuStockDate(s, st, d)

    OBJECTS           bt=Batch
    PROPERTIES(bt)    READONLY dateBatch, nameBatch, idBarcodeSkuBatch, nameSkuBatch, shortNameUOMBatch//, quantityBatch
    FILTERS           isParentGroupBatch(sk, bt)
    ORDER BY          dateBatch, nameBatch, nameSkuBatch

    PROPERTIES(bt, st, d) READONLY balanceABatchStockDate, costSumABatchStockDate
    PROPERTIES(st, d) printListBalanceBatchesStockDate, printBalanceBatchesStockDate
    FILTERS balanceABatchStockDate(bt, st, d)
;

DESIGN reportBalanceStock FROM DEFAULT{
    NEW topContainer{
        childConstraints = TO THE RIGHT;
        ADD d.box;
        ADD st.box;
        ADD gt.box{ADD PROPERTY(inSessionGroup);}
    }
    NEW bottomContainer{
        childConstraints = TO THE RIGHT;
        type = SPLITH;
        ADD skuTree.tree.box;
        NEW tabContainer{
            type = TABBED;
            fillHorizontal = 2;
            NEW skuContainer{
                caption = 'Товары';
                childConstraints = TO THE BOTTOM;
                NEW printSkuContainer{
                    childConstraints = TO THE RIGHT;
                    caption = 'Печать';
                    ADD PROPERTY(printListBalanceSkusStockDate);
                    ADD PROPERTY(printBalanceSkusStockDate);
                }
                ADD s.box;
            }
            NEW batchContainer{
                caption = 'Партии';
                childConstraints = TO THE BOTTOM;
                NEW printBatchContainer{
                    childConstraints = TO THE RIGHT;
                    caption = 'Печать';
                    ADD PROPERTY(printListBalanceBatchesStockDate);
                    ADD PROPERTY(printBalanceBatchesStockDate);
                }
                ADD bt.box;
            }
        }
    }
    ADD functions.box;
}

NAVIGATOR {
    stockReports{
        ADD reportBalanceStock;
    }
}