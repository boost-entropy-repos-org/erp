MODULE PriceListPurchaseShipment;

REQUIRE PurchaseShipment, PriceList;

NAMESPACE PriceList;

createPriceListPurchase 'Прайс-лист'(Purchase.Shipment shipment) = ACTION NEWSESSION {
    FOR ADDOBJ p = UserPriceList DO {
        fromDate(p) <- date(shipment);
        fromTime(p) <- time(shipment);
        company(p) <- customer(shipment);
        allStocks(p) <- TRUE;
        currency(p) <- currency(shipment);

        FOR shipment(Purchase.ShipmentDetail id)==shipment ADDOBJ pd=UserPriceListDetail DO {
            userPriceList(pd) <- p;
            sku[PriceListDetail](pd) <- sku(id);
        }

        FORM userPriceList OBJECTS p = p, tt = customerStock(shipment) MANAGESESSION DOCKED;
    }

} TOOLBAR;

EXTEND FORM shipments
    PROPERTIES(s) createPriceListPurchase BEFORE copy(s)
;

DESIGN shipments {
    main {
        createdContainer {
            MOVE PROPERTY(createPriceListPurchase(s));
        }
    }
}