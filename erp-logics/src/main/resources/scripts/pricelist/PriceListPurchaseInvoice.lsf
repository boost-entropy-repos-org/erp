MODULE PriceListPurchaseInvoice;

REQUIRE PurchaseInvoice, PriceList;

NAMESPACE PriceList;

createPriceListPurchaseInvoice 'Прайс-лист' = ACTION (purchaseInvoice) NEWSESSION {
    FOR ADDOBJ p = UserPriceList DO {
        fromDateUserPriceList(p) <- Purchase.dateInvoice(purchaseInvoice);
        fromTimeUserPriceList(p) <- Purchase.timeInvoice(purchaseInvoice);
        companyUserPriceList(p) <- Purchase.customerInvoice(purchaseInvoice);
        allStocksUserPriceList(p) <- TRUE;
        currencyUserPriceList(p) <- OVERRIDE Purchase.currencyInvoice(purchaseInvoice), homeCurrencyInvoice(purchaseInvoice);

        FOR Purchase.invoiceInvoiceDetail(id)==purchaseInvoice ADDOBJ pd=UserPriceListDetail DO {
            userPriceListUserPriceListDetail(pd) <- p;
            skuPriceListDetail(pd) <- Purchase.skuInvoiceDetail(id);
        }

        FORM userPriceList OBJECTS p = p, tt = Purchase.customerStockInvoice(purchaseInvoice) MANAGESESSION DOCKEDMODAL;
    }

} TOOLBAR;

EXTEND FORM invoices
    PROPERTIES(i) createPriceListPurchaseInvoice BEFORE copyInvoice(i)
;

DESIGN invoices {
    main {
        createdContainer {
            ADD PROPERTY(createPriceListPurchaseInvoice(i));
        }
    }
}