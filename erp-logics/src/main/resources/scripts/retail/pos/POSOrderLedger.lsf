MODULE POSOrderLedger;

REQUIRE POS, OrderLedger;

NAMESPACE POS;

incorrectReceipt(Receipt r) += WHEN overBanNegativeBatch(departmentStore(r)) AND 
                                    [= GROUP SUM 1 IF [= GROUP SUM quantity(ReceiptSaleDetail d) BY batch(d), receipt(d)](Batch b, Receipt r) > prevCurrentBalance(b, departmentStore(r)) BY r](r) THEN 
                                    TEXT('Продаваемое количество по партии ' + [= GROUP CONCAT nameSku(Batch b) IF [= GROUP SUM quantity(ReceiptSaleDetail d) BY batch(d), receipt(d)](b, Receipt r) > prevCurrentBalance(b, departmentStore(r)), ', ' BY r](r) + ' больше текущего остатка');

