MODULE POSInvoice;

REQUIRE POS, SaleInvoiceContract, ContractPayment, SaleShipment, ZReportPayment;

NAMESPACE Sale;

passportPartyBContract 'Паспорт' = passportNumberLegalEntity(partyBContract(contract));
shortNameOwnershipPartyBContract 'Форма собственности (сокр.)' = shortNameOwnershipLegalEntity(partyBContract(contract));
balanceAContractCurrentDate 'Задолженность' = balanceAContractDate(contract, currentDate());
lastPaymentContract 'Платеж' = GROUP LAST payment BY contractPayment(payment) ORDER payment;

fiscalTypePayment 'Тип платежа' = ABSTRACT INTEGER (Payment.Payment); 
dataFiscalTypePayment 'Тип платежа' = DATA INTEGER (Payment.Payment);
fiscalTypePayment(p) += dataFiscalTypePayment(p); 

defaultCurrencyPaymentInstallments = DATA Currency (); 
nameDefaultCurrencyPaymentInstallmentsy 'Валюта рассрочки' = nameCurrency(defaultCurrencyPaymentInstallments()) PREFCHARWIDTH 30;

defaultTypeExchangePaymentInstallments  = DATA TypeExchange ();
nameDefaultTypeExchangePaymentInstallments 'Тип обмена рассрочки' = nameTypeExchange(defaultTypeExchangePaymentInstallments());

defaultTypeExchangeRepaymentInstallments  = DATA TypeExchange ();
nameDefaultTypeExchangeReaymentInstallments 'Тип обмена погашения' = nameTypeExchange(defaultTypeExchangeRepaymentInstallments());

EXTEND FORM options
    PROPERTIES() nameDefaultCurrencyPaymentInstallmentsy, nameDefaultTypeExchangePaymentInstallments, nameDefaultTypeExchangeReaymentInstallments
;

DESIGN options {
    pane {
        NEW paymentInstallmentsy {
            caption = 'Рассрочка';
            MOVE PROPERTY(nameDefaultCurrencyPaymentInstallmentsy());
            MOVE PROPERTY(nameDefaultTypeExchangePaymentInstallments());
            MOVE PROPERTY(nameDefaultTypeExchangeReaymentInstallments());
        }    
    }
}

setPassportPhoneLegalEntity = ABSTRACT ACTION (); 

isReadonly() = DATA LOCAL BOOLEAN ();

nameLegalEntity = DATA LOCAL STRING[150] ();     
passportNumberLegalEntity = DATA LOCAL STRING[10] ();
phoneContact = DATA LOCAL STRING[30] ();
postAddressContact = DATA LOCAL STRING[100] ();  
noteInvoice = DATA LOCAL STRING[255] ();  

FORM paymentInstallments 'Рассрочка'
    PROPERTIES READONLYIF isReadonly() nameLegalEntity()     
        
    PROPERTIES READONLYIF isReadonly() passportNumberLegalEntity() ON CHANGE setPassportPhoneLegalEntity()
     
    PROPERTIES READONLYIF isReadonly() phoneContact()
    
    PROPERTIES READONLYIF isReadonly() postAddressContact()    
    
    PROPERTIES noteInvoice()        
    
    OBJECTS n = NUMERIC[16,2] FIXED PANEL
    PROPERTIES(n) sumPayment = OBJVALUE
    
    OBJECTS pt = PaymentType FIXED PANEL 
    PROPERTIES(pt) SELECTOR namePaymentType
    
    OBJECTS pc = PaymentCondition FIXED PANEL
    PROPERTIES(pc) SELECTOR descriptionPaymentCondition    
;

DESIGN paymentInstallments {
    NEW topContainer{
        type = CONTAINERH;
        NEW customerContainer {
            caption = 'Покупатель';
            MOVE PROPERTY(passportNumberLegalEntity()) {
                caption = 'Паспорт';
                fontSize = 24;
                panelCaptionAbove = TRUE;   
                alignment = STRETCH;   
                notNull = TRUE;
            }
            MOVE PROPERTY(nameLegalEntity()) {
                caption = 'ФИО';
                fontSize = 24;
                panelCaptionAbove = TRUE;
                notNull = TRUE;
            }
            MOVE PROPERTY(postAddressContact()) {
                caption = 'Адрес';
                fontSize = 24;
                panelCaptionAbove = TRUE;      
                alignment = STRETCH;
                notNull = TRUE;
            }   
            MOVE PROPERTY(phoneContact()) {
                caption = 'Телефон';
                fontSize = 24;
                panelCaptionAbove = TRUE;      
                alignment = STRETCH;
                notNull = TRUE;
            }                                    
        }
        NEW sumContainer {
            caption = 'Платеж';
            MOVE PROPERTY(descriptionPaymentCondition(pc)) {
                caption = 'Условия рассрочки';
                fontSize = 32;   
                panelCaptionAbove = TRUE;
                preferredCharWidth = 15;
            }              
            MOVE PROPERTY(namePaymentType(pt)) {
                caption = 'Тип платежа';
                fontSize = 32;   
                panelCaptionAbove = TRUE;
                preferredCharWidth = 15;
            }                
            MOVE PROPERTY(sumPayment) {
                caption = 'Сумма первоначального платежа';
                fontSize = 32;   
                panelCaptionAbove = TRUE;
                alignment = STRETCH;
            }         
        }
    }
    NEW bottomContainer {
        caption = 'Примечание';
        MOVE PROPERTY(noteInvoice()) {
            caption = '';
            fontSize = 24;
            panelCaptionAbove = TRUE;
            preferredCharWidth = 76;
        }        
    }
    MOVE functions.box;
    REMOVE leftControls;
    REMOVE PROPERTY(formRefresh());
}

setPassportPhoneLegalEntity () += ACTION () {
    REQUEST STRING[150] INPUT;
    passportNumberLegalEntity() <- requestedString(); 
    FOR NOT requestCanceled() AND passportNumberLegalEntity(l) == requestedString() DO {
        nameLegalEntity() <- nameLegalEntity(l);
        phoneContact() <- phoneContact(l);
        postAddressContact() <- postAddressContact(l);
        isReadonly() <- TRUE;
    }
} 

printReceiptInvoicePayment = ABSTRACT ACTION LIST (Sale.Invoice, Payment.Payment);
printReceiptResult = DATA LOCAL BOOLEAN ();

createInvoiceReceipt  = ACTION (receipt, customer, sum, paymentType, paymentCondition, note) {       
    FOR ADDOBJ i = UserInvoice DO {
        supplierStockUserInvoice(i) <- departmentStoreReceipt(receipt);
        supplierUserInvoice(i) <- legalEntityStock(departmentStoreReceipt(receipt));
        customerUserInvoice(i) <- customer;
        customerStockUserInvoice(i) <- defaultStockLegalEntity(customer);
        dateUserInvoice(i) <- dateReceipt(receipt);
        timeUserInvoice(i) <- timeReceipt(receipt);
        paymentConditionUserInvoice(i) <- paymentCondition;
        noteUserInvoice(i) <- note;
        createShipmentUserInvoice(i) <- TRUE;
        isPostedUserInvoice(i) <- TRUE;
        
        FOR ADDOBJ c = UserContractSku DO {
            supplierContractSku(c) <- legalEntityStock(departmentStoreReceipt(receipt));
            customerContractSku(c) <- customer;
            dateFromContract(c) <- dateReceipt(receipt);
            currencyContract(c) <- defaultCurrencyPaymentInstallments();
            typeContractSku(c) <- ContractSkuType.sale;
            paymentConditionContract(c) <- paymentCondition;
            typeExchangeContract(c) <- defaultTypeExchangePaymentInstallments();
            contractSkuUserInvoice(i) <- c;            
        }
        
        FOR receiptReceiptDetail(detail) == receipt ADDOBJ d = UserInvoiceDetail DO {
            userInvoiceUserInvoiceDetail(d) <- i;
            skuUserInvoiceDetail(d) <- skuReceiptDetail(detail);
            quantityUserInvoiceDetail(d) <- quantityReceiptDetail(detail);
            invoiceSumUserInvoiceDetail(d) <- sumReceiptDetail(detail);
            shipmentSumUserInvoiceDetail(d) <- sumReceiptDetail(detail);
            valueVATUserInvoiceDetail(d) <- valueVATReceiptDetail(detail);
            invoicePriceUserInvoiceDetail(d) <- priceReceiptDetail(detail);
            priceUserInvoiceDetail(d) <- invoicePriceUserInvoiceDetail (d) * 100/(100 + valueVATUserInvoiceDetail(d));
        }
        
        FOR ADDOBJ p = Payment.Payment DO {
            datePayment(p) <- dateReceipt(receipt);
            timePayment(p) <- timeReceipt(receipt); 
            payerPayment(p) <- customer;
            beneficiaryPayment(p) <- legalEntityStock(departmentStoreReceipt(receipt));
            sumPayment(p) <- sum;
            contractPayment(p) <- contractSkuUserInvoice(i);
            isPostedPayment(p) <- TRUE;
            IF debtInContractLedger(i) >= sumContractPayment(p) THEN {
                costOutContractLedgerInContractLedger(p, i) <- sumContractPayment(p);    
            } ELSE IF debtInContractLedger(i) < sumContractPayment(p) THEN{
                costOutContractLedgerInContractLedger(p, i) <- debtInContractLedger(i);     
            } 
            dataFiscalTypePayment(p) <- IF sidPaymentType(paymentType) == 'card' THEN 1 ELSE 0;
            
            DELETE detail WHERE receiptReceiptDetail(detail) == receipt;                                   
            DELETE receipt;
            
            IF modelGroupMachinery(groupCashRegisterCashRegister(currentCashRegister())) THEN {
                printReceiptInvoicePayment(i, p); 
                IF printReceiptResult() THEN 
                    zReportPayment(p) <- currentZReport();      
                    typePayment(p) <- IF sidPaymentType(chosenObject('pt')) == 'card' THEN 1 ELSE 0;          
                    apply();
                    createCurrentReceipt();
            }                 
            ELSE {
                apply();
                createCurrentReceipt(); 
            }
        }
    }
}

createPaymentInstallments 'Рассрочка' = ACTION (receipt) {
    IF quantityReceiptDetailReceipt(receipt) THEN {
        passportNumberLegalEntity() <- NULL;
        nameLegalEntity() <- NULL;
        phoneContact() <- NULL;
        postAddressContact() <- NULL;
        noteInvoice() <- NULL;
        FORM paymentInstallments MODAL;
        IF formResult() == FormResult.ok THEN {
            FOR passportNumberLegalEntity(l) == passportNumberLegalEntity() DO { 
                createInvoiceReceipt(receipt, l, chosenNumeric('n'), chosenObject('pt'), chosenObject('pc'), noteInvoice());
            } ELSE {
                ADDOBJ LegalEntity;
                FOR l == addedObject() DO {
                    nameLegalEntity(l) <- nameLegalEntity();
                    passportNumberLegalEntity(l) <- passportNumberLegalEntity();
                    phoneContact(l) <- phoneContact();
                    postAddressContact(l) <- postAddressContact();
                    isCustomerLegalEntity(l) <- TRUE;
                    FOR shortNameOwnership(ownership) == 'Ф.Л.' DO {
                        ownershipLegalEntity(l) <- ownership;
                    }
                    FOR nameLegalEntityGroup(group) == 'Покупатели' DO {
                        legalEntityGroupLegalEntity(l) <- group;
                    }
                    createInvoiceReceipt(receipt, l, chosenNumeric('n'), chosenObject('pt'), chosenObject('pc'), noteInvoice());
                }
            }    
        } ELSE {
            isReadonly() <- NULL;
        }   
    }         
}

backgroundContractReceipt (contract, receipt)= RGB(255,75,75) IF (balanceAContractCurrentDate(contract) (+) sumReceiptDetailReceipt(receipt) > 0.0); 

FORM prePayment 'Предоплата'
    OBJECTS r = Receipt FIXED PANEL 
    OBJECTS c = Contract
    PROPERTIES(c) READONLY BACKGROUND backgroundContractReceipt(c, r) namePartyBContract, passportPartyBContract, balanceAContractCurrentDate
    FILTERS balanceAContractCurrentDate(c) < 0,
            shortNameOwnershipPartyBContract(c) == 'Ф.Л.'
    
    PROPERTIES noteInvoice()
;

DESIGN prePayment {
    REMOVE r.box;
    MOVE c.box {
        PROPERTY(namePartyBContract(c)){
            caption = 'ФИО';    
        }   
    }
    NEW bottomContainer {
        caption = 'Примечание';
        MOVE PROPERTY(noteInvoice()) {
            caption = '';
            fontSize = 24;
            panelCaptionAbove = TRUE;
            preferredCharWidth = 76;
        }        
    }
    MOVE functions.box;
}

createInvoicePrePayment 'Предоплата'  = ACTION (receipt) {
    IF quantityReceiptDetailReceipt(receipt) THEN {
        noteInvoice() <- NULL;
        FORM prePayment OBJECTS r = receipt MODAL;
        IF formResult() == FormResult.ok THEN {
            FOR ADDOBJ i = UserInvoice DO {
                supplierStockUserInvoice(i) <- departmentStoreReceipt(receipt);
                supplierUserInvoice(i) <- legalEntityStock(departmentStoreReceipt(receipt));
                customerUserInvoice(i) <- partyBContract(chosenObject('c'));
                customerStockUserInvoice(i) <- defaultStockLegalEntity(partyBContract(chosenObject('c')));
                dateUserInvoice(i) <- dateReceipt(receipt);
                timeUserInvoice(i) <- timeReceipt(receipt);
                contractSkuUserInvoice(i) <- chosenObject('c');
                paymentConditionUserInvoice(i) <- paymentConditionContract(chosenObject('c'));
                noteUserInvoice(i) <- noteInvoice();
                createShipmentUserInvoice(i) <- TRUE;
                isPostedUserInvoice(i) <- TRUE;
                FOR p == lastPaymentContract(chosenObject('c')) DO {
                    IF Payment.sumPayment(p) < sumReceiptDetailReceipt(receipt) THEN {
                        costOutContractLedgerInContractLedger(p, i) <- Payment.sumPayment(p);    
                    } ELSE {
                        costOutContractLedgerInContractLedger(p, i) <- sumReceiptDetailReceipt(receipt);                     
                    }
                }
                FOR receiptReceiptDetail(detail) == receipt ADDOBJ d = UserInvoiceDetail DO {
                    userInvoiceUserInvoiceDetail(d) <- i;
                    skuUserInvoiceDetail(d) <- skuReceiptDetail(detail);
                    quantityUserInvoiceDetail(d) <- quantityReceiptDetail(detail);
                    invoiceSumUserInvoiceDetail(d) <- sumReceiptDetail(detail);
                    invoicePriceUserInvoiceDetail(d) <- sumReceiptDetail(detail)/quantityReceiptDetail(detail);
                    priceUserInvoiceDetail(d) <- invoicePriceUserInvoiceDetail (d) * 100/(100 + calcValueVATUserInvoiceDetail(d));
                }
            }
            DELETE detail WHERE receiptReceiptDetail(detail) == receipt;                                   
            DELETE receipt;            
            apply();
            createCurrentReceipt();             
        }
    }   
}


EXTEND FORM POS
    PROPERTIES(r) SHOWIF currentZReport() createPaymentInstallments, createInvoicePrePayment
;
DESIGN POS {
    misc {
        NEW invoice {
            alignment = STRETCH;
            caption = 'Накладная';
            MOVE PROPERTY(createPaymentInstallments(r)) {alignment = STRETCH; focusable = FALSE; font = 'bold 24';  }
            MOVE PROPERTY(createInvoicePrePayment(r)) {alignment = STRETCH; focusable = FALSE; font = 'bold 24';  }
        }
    }
}