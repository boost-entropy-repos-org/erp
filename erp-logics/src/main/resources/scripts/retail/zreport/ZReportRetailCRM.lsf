MODULE ZReportRetailCRM;

REQUIRE ZReportDiscountCard, RetailCRM;

NAMESPACE ZReport;

// ----------------------------------- Расчет сумм скидок ------------------------------------- // 
TABLE receiptSaleDetailPromotionCondition(ReceiptSaleDetail, PromotionCondition);
quantity 'Кол-во по акции' = DATA NUMERIC[14,3] (ReceiptSaleDetail, PromotionCondition) INDEXED;
promotionSum 'Сумма скидки' = DATA NUMERIC[16,2] (ReceiptSaleDetail, PromotionCondition);
setUserPromotion 'Применить скидку' = DATA BOOLEAN (ReceiptSaleDetail, PromotionCondition);

idPromotionConditions 'Коды акций' (d) = GROUP CONCAT id(PromotionCondition p) IF quantity(ReceiptSaleDetail d, p),
                                                      ','
                                                      BY d
                                                      ORDER p;
                                                      
namePromotionConditions 'Названия акций' (d) = GROUP CONCAT name(PromotionCondition p) IF quantity(ReceiptSaleDetail d, p),
                                                      ','
                                                      BY d
                                                      ORDER p MINCHARWIDTH 20 PREFCHARWIDTH 20;
                                                      
prevTotalSum 'Накопленная сумма' (Receipt receipt) = OVERRIDE 0 IF receipt IS Receipt, [= PREV(totalSum(DiscountCard discountCard))](discountCard(receipt));
totalSum (Receipt receipt, Promotion promotion) = IF useCurrentReceipt(promotion) THEN totalSum(discountCard(receipt))
                                                                                         ELSE prevTotalSum (receipt);                                                  