MODULE ZReportReport;

REQUIRE ZReport;

NAMESPACE ZReport;

inReportStock 'Отм.' = DATA LOCAL BOOLEAN (Stock);

sumReceiptDetailZReportDateDateFromTo 'Сумма Z-отчета' (date, dateFrom, dateTo)= GROUP SUM sumReceiptDetailZReport(zReport) IF 
    dateZReport(zReport) >= (dateFrom AS DATE) AND dateZReport(zReport) <= (dateTo AS DATE) AND isPostedZReport(zReport) AND
    inReportStock(departmentStoreZReport(zReport))
        BY dateZReport(zReport), dateFrom, dateTo;
    
sumReceiptDetailZReportStockDate 'Сумма Z-отчета' (stock, date)= GROUP SUM sumReceiptDetailZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);

sumPositiveCashPaymentZReportStockDate 'Сумма продажа (наличные)' (stock, date)= GROUP SUM sumPositiveCashPaymentZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);
sumPositiveCardPaymentZReportStockDate 'Сумма продажа (карточка)' (stock, date)= GROUP SUM sumPositiveCardPaymentZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);
discountSumReceiptDetailZReportStockDate 'Сумма скидок Z-отчета по строкам чека' (stock, date)= GROUP SUM discountSumReceiptDetailZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);        
discountSumZReportStockDate 'Сумма скидок Z-отчета' (stock, date)= GROUP SUM discountSumZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);        
VATSumSaleZReportStockDate 'Сумма НДС по продажам' (stock, date)= GROUP SUM sumVATReceiptDetailZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);    
              
sumNegativeCashPaymentZReportStockDate 'Сумма возврата (наличные)' (stock, date)= GROUP SUM sumNegativeCashPaymentZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport); 
sumNegativeCardPaymentZReportStockDate 'Сумма возврата (карточка)' (stock, date)= GROUP SUM sumNegativeCardPaymentZReport(zReport) IF isPostedZReport(zReport)
        BY departmentStoreZReport(zReport), dateZReport(zReport);  

nameReceiptDetailZReportStock (stock)= nameStock(stock) + ' (сумма Z-отчета)';    
namePositiveCashStock (stock)= nameStock(stock) + ' (сумма продажа (наличные))';    
namePositiveCardStock (stock)= nameStock(stock) + ' (сумма продажа (карточка))';    
nameGiftCardStock (stock)= nameStock(stock) + ' (сумма продаж (сертификат))';    
nameReceiptDetailGiftCardStock (stock) = nameStock(stock) + ' (сумма проданных сертификатов)';    
nameDiscountSumStock (stock)= nameStock(stock) + ' (сумма скидок)';    
nameVATSumSaleStock (stock)= nameStock(stock) + ' (сумма НДС по продажам)';        
                                  
nameNegativeCashStock (stock)= nameStock(stock) + ' (сумма возврата (наличные)';    
nameNegativeCardStock (stock)= nameStock(stock) + ' (сумма возврата (карточка)';    
nameVATSumReturnStock (stock)= nameStock(stock) + ' (сумма НДС по возвратам)';                                     
countReceiptDepartmentStoreDate 'Кол-во чеков в магазине за день' (departmentStore, date) = 
    GROUP SUM countReceiptZReport(zReport) IF isPostedZReport(zReport) BY departmentStoreZReport(zReport), dateZReport(zReport);
    
countReturnReceiptZReport 'Кол-во возвратных чеков' (o) =
    GROUP SUM 1 IF [ = GROUP SUM 1 BY receiptReceiptReturnDetail(d) ](d) BY zReportReceipt(d) PERSISTENT IN documentSum;
    
countReturnReceiptDepartmentStoreDate 'Кол-во возвратных чеков за день' (departmentStore, date) = 
    GROUP SUM countReturnReceiptZReport(zReport) IF isPostedZReport(zReport) BY departmentStoreZReport(zReport), dateZReport(zReport);    

countFiscalReceiptDepartmentStoreDate 'Кол-во фискальных чеков за день' = countReceiptDepartmentStoreDate(departmentStore, date) (-) countReturnReceiptDepartmentStoreDate(departmentStore, date);    
    
averageSumReceiptDepartmentStoreDate 'Средняя сумма чека в магазине за день' (departmentStore, date) = 
    sumReceiptDetailZReportStockDate(departmentStore, date) / countReceiptDepartmentStoreDate(departmentStore, date);

countReceiptDetailZReport (zReport) = GROUP SUM countReceiptDetailReceipt(receipt) BY zReportReceipt(receipt);
countReceiptDetailDepartmentStoreDate 'Кол-во позиций чеков в магазине за период' (departmentStore, date) =
    GROUP SUM countReceiptDetailZReport(zReport) IF isPostedZReport(zReport) BY departmentStoreZReport(zReport), dateZReport(zReport);
averageCountReceiptDetailDepartmentStoreDate 'Среднее кол-во позиций в чеке в магазине за париод' (departmentStore, date) = 
    NUMERIC[14,2](countReceiptDetailDepartmentStoreDate(departmentStore, date)) / NUMERIC[14,2](countReceiptDepartmentStoreDate(departmentStore, date));
    
countReceiptStock (stock)= nameStock(stock) + ' (кол-во чеков)';        
averageSumReceiptStock (stock)= nameStock(stock) + ' (cредняя сумма чека)';        
countReceiptDetailStock (stock)= nameStock(stock) + ' (кол-во позиций чеков)';
averageCountReceiptDetailStock (stock)= nameStock(stock) + ' (среднее кол-во позиций в чеке)'; 
countFiscalReceiptStock (stock)= nameStock(stock) + ' (фискальных чеков)';        
        
FORM saleZreportStock 'Отчет по магазинам'

    OBJECTS dates = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES valFrom = OBJVALUE(dFrom), valTo = OBJVALUE(dTo)        
     
    OBJECTS ts = DepartmentStore FIXED GRID
    PROPERTIES nameStock(ts) READONLY, nameLegalEntityStock(ts) READONLY, inReportStock(ts)
    ORDER BY nameStock(ts)
    FILTERS isCompanyStock(ts)     
    FILTERGROUP inactiveStock FILTER 'Активный' activeStock(ts) 'ctrl F10' DEFAULT  
    
    OBJECTS st = DepartmentStore FIXED GRID     
    FILTERS isCompanyStock(st),
            inReportStock(st)   
         
    OBJECTS dt = DATE FIXED GRID
    PROPERTIES READONLY valDt = OBJVALUE(dt)
    PROPERTIES(dt) READONLY extractMonthName, extractDOWName 
    
    FILTERS    sumReceiptDetailZReportDateDateFromTo(dt,dFrom,dTo)
                         
    PROPERTIES READONLY sumReceiptDetailZReportStockDate(st,dt)  COLUMNS (st) HEADER nameReceiptDetailZReportStock(st)
    PROPERTIES READONLY sumPositiveCashPaymentZReportStockDate(st,dt)  COLUMNS (st) HEADER namePositiveCashStock(st)
    PROPERTIES READONLY sumPositiveCardPaymentZReportStockDate(st,dt)  COLUMNS (st) HEADER namePositiveCardStock(st)                                    
    PROPERTIES READONLY discountSumZReportStockDate(st,dt)  COLUMNS (st) HEADER nameDiscountSumStock(st)                                 
    PROPERTIES READONLY VATSumSaleZReportStockDate(st,dt)  COLUMNS (st) HEADER nameVATSumSaleStock(st)   
                                  
    PROPERTIES READONLY sumNegativeCashPaymentZReportStockDate(st,dt)  COLUMNS (st) HEADER nameNegativeCashStock(st)                                 
    PROPERTIES READONLY sumNegativeCardPaymentZReportStockDate(st,dt)  COLUMNS (st) HEADER nameNegativeCardStock(st)                             
    
    PROPERTIES READONLY countReceiptDepartmentStoreDate(st,dt) COLUMNS (st) HEADER countReceiptStock(st)   
    PROPERTIES READONLY countFiscalReceiptDepartmentStoreDate(st,dt) COLUMNS (st) HEADER countFiscalReceiptStock(st)                                 
    PROPERTIES READONLY averageSumReceiptDepartmentStoreDate(st,dt) COLUMNS (st) HEADER averageSumReceiptStock(st)                                 
    PROPERTIES READONLY countReceiptDetailDepartmentStoreDate(st,dt) COLUMNS (st) HEADER countReceiptDetailStock(st)                                 
    PROPERTIES READONLY averageCountReceiptDetailDepartmentStoreDate(st,dt) COLUMNS (st) HEADER averageCountReceiptDetailStock(st)                                 
;


EXTEND FORM saleZreportStock FILTERS (ts IS DepartmentStore AND NOT limitAccessEmployee(currentUser())) OR accessCompanyEmployeeStock(currentUser(),ts);


DESIGN saleZreportStock {

    MOVE dates.box {
        caption = 'Период';
        type = CONTAINERH;
    }

    REMOVE st.box;
    NEW detail {
        type = SPLITH;
        fill = 1;
        MOVE ts.box;
        MOVE dt.box {
            fill = 3;
            caption = 'Дата/склад';
        }
        PROPERTY(sumPositiveCashPaymentZReportStockDate(st,dt)) { background = #FFEEEE; } 
        PROPERTY(sumPositiveCardPaymentZReportStockDate(st,dt)) { background = #F4FFBD; }    

        PROPERTY(discountSumZReportStockDate(st,dt)) { background = #EEFFEE; }  
        PROPERTY(VATSumSaleZReportStockDate(st,dt)) { background = #E4FFBD; }             
        
        PROPERTY(sumNegativeCashPaymentZReportStockDate(st,dt)) { background = #D4FFFF; }              
        PROPERTY(sumNegativeCardPaymentZReportStockDate(st,dt)) { background = #C4FFBD; }              
                 
    }                                                                                
    MOVE functions.box;
}

NAVIGATOR {
    retailReports  {
        ADD saleZreportStock;
    }
}

divider 'Диапозон суммы'  = DATA LOCAL NUMERIC[16,2] ();

dividerReceipt 'Диапозон суммы' (r)  = INTEGER (sumReceiptDetailReceipt(r) / divider())*divider();

filterReceiptSumFrom 'Сумма с' = DATA LOCAL NUMERIC[16,2] ();
filterSumFromReceipt (r) = sumReceiptDetailReceipt(r) >= filterReceiptSumFrom() OR (r IS Receipt AND NOT filterReceiptSumFrom());   

filterReceiptSumTo 'Сумма по' = DATA LOCAL NUMERIC[16,2] ();
filterSumToReceipt (r) = sumReceiptDetailReceipt(r) <= filterReceiptSumTo() OR (r IS Receipt AND NOT filterReceiptSumTo());   

FORM receiptListPeriod 'Реестр чеков'

    OBJECTS dates = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES valFrom = OBJVALUE(dFrom), valTo = OBJVALUE(dTo)     
       
    PROPERTIES () filterReceiptSumFrom, filterReceiptSumTo, divider
    
    OBJECTS st = DepartmentStore FIXED PANEL 
    PROPERTIES nameStock(st) SELECTOR 
    FILTERS isCompanyStock(st), activeStock(st)    
    
    OBJECTS r = Receipt
    PROPERTIES(r) READONLY  numberReceipt, dateReceipt, timeReceipt, numberCashRegisterReceipt, nameEmployeeReceipt,
                            sumReceiptDetailReceipt, discountSumReceiptDetailReceipt,
                            discountSumReceipt, sumVATReceiptDetailReceipt, countReceiptDetailReceipt, quantityReceiptDetailReceipt,
                            sumCashPaymentReceipt, sumCardPaymentReceipt, dividerReceipt SHOWIF divider()
    ORDER BY dateReceipt(r), timeReceipt(r)                                            
    FILTERS dateReceipt(r) >= dFrom,
            dateReceipt(r) <= dTo,
            isPostedReceipt(r),
            departmentStoreReceipt(r) == st,
            filterSumFromReceipt(r),
            filterSumToReceipt(r)
;
DESIGN receiptListPeriod {
    main {
        NEW top {
            type = CONTAINERH;
            MOVE dates.box {caption ='Период';}
            MOVE st.box;
        }
        NEW mid {
            type = CONTAINERH;
         
            NEW filter {
                type = CONTAINERH;
                caption = 'Фильтры';
                MOVE PROPERTY (filterReceiptSumFrom());
                MOVE PROPERTY (filterReceiptSumTo());
            }
            NEW mid1 {
                caption = 'Делитель';
                MOVE PROPERTY (divider());
            }
        }
        MOVE r.box;
        MOVE functions.box;
    }
}
@extendFormFilterStockAccess(st, receiptListPeriod, company);

NAVIGATOR {
    retailReports  {
        ADD receiptListPeriod;
    }
}
