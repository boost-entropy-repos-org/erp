MODULE ZReportDiscountCard;

REQUIRE ZReport, DiscountCard;

NAMESPACE ZReport;

discountCardReceipt (receipt) = DATA DiscountCard (Receipt);
seriesNumberDiscountCardReceipt (receipt) = seriesNumberDiscountCard(discountCardReceipt(receipt));
discountCardReceiptSaleDetail (d) = discountCardReceipt(receiptReceiptSaleDetail(d));
discountCardReceiptReturnDetail (d) = discountCardReceipt(receiptReceiptReturnDetail(d));
discountCardReceiptDetail (d) = discountCardReceipt(receiptReceiptDetail(d));

CONSTRAINT dateToDiscountCard(discountCardReceipt(receipt)) < dateReceipt(receipt) CHECKED BY discountCardReceipt MESSAGE 'Закончился срок действия карты';

numberDiscountCardReceipt 'Номер дисконтной карты' (receipt) = seriesNumberDiscountCard(discountCardReceipt(receipt)) IN receiptDiscount;
nameLegalEntityDiscountCardReceipt 'Держатель дисконтной карты' (receipt) = nameLegalEntityDiscountCard(discountCardReceipt(receipt)) IN receiptDiscount MINCHARWIDTH 30 PREFCHARWIDTH 40;
numberDiscountCardReceiptDetail 'Номер дисконтной карты' (receiptDetail) = numberDiscountCardReceipt(receiptReceiptDetail(receiptDetail));
nameLegalEntityDiscountCardReceiptDetail 'Держатель дисконтной карты' (receiptDetail) = nameLegalEntityDiscountCardReceipt(receiptReceiptDetail(receiptDetail)) MINCHARWIDTH 30 PREFCHARWIDTH 40;

countReceiptsDiscountCardZReport 'Кол-во чеков по дисконтным картам в Z-отчете' (zReport) = GROUP SUM 1 IF discountCardReceipt(receipt)  
    BY zReportReceipt(receipt) PERSISTENT IN documentSum;
    
EXTEND FORM zReport
    PROPERTIES(b) AFTER nameEmployeeReceipt(b) numberDiscountCardReceipt, nameLegalEntityDiscountCardReceipt
;
EXTEND FORM zReports
    PROPERTIES(b) READONLY AFTER nameEmployeeReceipt(b) numberDiscountCardReceipt, nameLegalEntityDiscountCardReceipt 
;

//--Накопленные суммы

posSumDiscountCard 'Сумма продаж' (discountCard) = GROUP SUM sumReceiptDetailReceipt (receipt) BY discountCardReceipt(receipt) PERSISTENT;
posReturnSumDiscountCard 'Сумма возвратов' (discountCard) = GROUP SUM sumReceiptReturnDetail(d) IF NOT discountCardReceiptDetail(d) BY discountCardReceipt(receiptSaleReceiptReturnDetail(d)) PERSISTENT; 
cumulativeSumDiscountCard 'Накопленная сумма (основная)' (discountCard) = initialSumDiscountCard(discountCard) (+) posSumDiscountCard(discountCard) (-) posReturnSumDiscountCard(discountCard) PERSISTENT;

externalSumDiscountCard 'Дополнительные накопления' (discountCard) = ABSTRACT NUMERIC[16,2] (DiscountCard) PERSISTENT;
totalSumDiscountCard 'Накопленная сумма' (d) = cumulativeSumDiscountCard(d) (+) externalSumDiscountCard(d); 

EXTEND FORM discountCards
    PROPERTIES(d) READONLY AFTER initialSumDiscountCard(d) posSumDiscountCard, posReturnSumDiscountCard, cumulativeSumDiscountCard, externalSumDiscountCard, totalSumDiscountCard
;
