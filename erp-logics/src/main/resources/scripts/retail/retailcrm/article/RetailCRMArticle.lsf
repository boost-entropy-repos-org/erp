MODULE RetailCRMArticle;

REQUIRE RetailCRM, ItemArticle, StockArticle;

PRIORITY Stock;

// article
TABLE promotionConditionArticle (PromotionCondition, Article);
inData 'В условии' = DATA BOOLEAN (PromotionCondition, Article);

in 'В условии' (PromotionCondition condition, Article article) = OVERRIDE
    TRUE IF inParent(condition, itemGroup(article)),                                                                            
    inData(condition, article); 

promotionConditions 'В акциях' = GROUP CONCAT ',', name(PromotionCondition c) IF in(c, Article a)
                                              BY a
                                              ORDER c;
promotionConditions 'В других акциях' =
                                        GROUP CONCAT name(PromotionCondition c) IF 
                                                     inData(c, Article a) AND 
                                                     dateTo(c) >= dateFrom(PromotionCondition pc) AND
                                                     dateTo(pc) >= dateFrom(c) AND 
                                                     c != pc AS PromotionCondition, 
                                              ','
                                              BY pc, a
                                              ORDER c MINCHARWIDTH 10 PREFCHARWIDTH 20;

overIn (PromotionCondition condition, Item sku) += inData(condition, article(sku));

nameBalancer (Stock stock)= name(stock) + '(остаток)' MINCHARWIDTH 15 PREFCHARWIDTH 20;    

backgroundBalance (Promotion p)= RGB(204,204,255) IF p IS Promotion;

prevCurrentBalance 'Итого (остаток)' (ar, sh) = GROUP SUM prevCurrentBalance(Article ar,DepartmentStore ddd) IF in(Promotion sh, store(ddd)) BY ar, sh;

copyProperties(PromotionCondition promotionConditionTo, PromotionCondition promotionConditionFrom) += ACTION {
    inData(promotionConditionTo, Article article) <- inData(promotionConditionFrom, article);        
}

EXTEND FORM promotion
    OBJECTS params = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES objFrom = OBJVALUE(dFrom), objTo = OBJVALUE(dTo)

    OBJECTS ddd = Stock FIXED GRID
    FILTERGROUP inactiveStock FILTER 'Активный' active(ddd) 'ctrl F10' DEFAULT
    FILTERS     in(sh, store(ddd))
    
    OBJECTS ar = Article
    PROPERTIES(ar)     READONLY idItemGroup, id, caption, prevCurrentBalance, canonicalNameItemGroup FORCE PANEL,
                       image FORCE PANEL
    PROPERTIES(sg, ar) READONLY promotionConditions
    PROPERTIES(sg, ar)          in
    PROPERTIES READONLY prevCurrentBalance(ar,ddd) COLUMNS 'astock' (ddd) HEADER nameBalancer(ddd) BACKGROUND backgroundBalance(sh),
                       prevCurrentBalance(ar,sh)
    FILTERS                     isParent(skg, ar)

    FILTERGROUP filterArticle
        FILTER 'В акции' in(sg, ar) 'F10'                        
;

DESIGN promotion {
    REMOVE ddd.box;
    row212 {
        type = SPLITH;
        NEW row213 {
            fill = 1;
            type = SPLITV;
            MOVE skuTree.tree.box;            
        
            NEW imageBox {
                fill = 1;
                caption = 'Изображение';                     
                MOVE PROPERTY(image(ar)) {
                    caption = '';
                    fill = 1;
                }
            }                        
        }
        NEW filterBox {
            type = CONTAINERV;
            fill = 3.5;
            MOVE params.box {
                type = CONTAINERH;
                caption = 'Реализация за период'; 
            } 
            MOVE skuPane {
                type = TABBED;
                MOVE ar.box;
                MOVE sk.box;
            } 
        }
        
    }         
    PROPERTY(prevCurrentBalance(ar,ddd)) { minimumCharWidth = 2; preferredCharWidth = 2;} 
    PROPERTY(prevCurrentBalance(ar,sh)) { minimumCharWidth = 4; preferredCharWidth = 4;}  
}
                