MODULE PurchaseDemandAuto;

REQUIRE PurchaseDemand, PurchaseAutoOrder;

NAMESPACE Purchase;


insuranceReserve  (Sku sk, UserOrder o, Stock st) += NUMERIC[16,5](zScore(sk) * 
                                                                    dispersionSold(sk,st) *
                                                                    NUMERIC[8,2](quantityDaysNextShipment(o)) /
                                                                    sqrt(NUMERIC[8,3](countSoldDays(skuGroup(sk))))); 
    
recQuantity 'Кол-во к заказу' (Sku s, UserOrder o, Stock st) =  plan(s,o,st) * coeffSeason(s) (+) 
                                                                                  (MAX insuranceReserve(s,o,st) * coeffSeason(s) * overCoeffPromotion(s), 
                                                                                       purchaseReserve(st, s, date(o))) (-)              
                                                                                  (currentBalance(s, st) IF currentBalance(s, st) > 0) (-)
                                                                                   currentReservePurchase(s, st);
    
recommendedQuantity (Sku s, Stock st, UserOrder o) += NUMERIC[16,5](recQuantity(s,o,st)) IF recQuantity(s,o,st) > 0;   