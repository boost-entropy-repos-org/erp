MODULE PurchaseInvoicePriceListStock;

REQUIRE PurchaseInvoice, PriceListStockGroup;

NAMESPACE Purchase;

// Создаем вид цен по всем складам компании
CLASS InvoicePriceListLedger : PriceListLedger;

@defineAggregation(invoiceDetail, invoicePriceListLedger, is);

fromDateTimePriceListLedger (ledger) += dateTimeInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));

isPostedPriceListLedger(ledger) += isPostedInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));

skuPriceListLedger (ledger) += skuInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));

descriptionPriceListLedger (ledger) += descriptionInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));

companyPriceListLedger (ledger) += supplierInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));

inPriceListLedgerStock (ledger, stock) += isCompanyStock(stock) AND priceStockGroupStock(customerStockInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger))) == priceStockGroupStock(stock);

EXTEND CLASS SystemLedgerPriceListType { purchaseInvoicePriceListType 'Закупки (последняя по ценовой группе)' }
batchLedgerPriceListTypeStock (type, stock) += WHEN type == SystemLedgerPriceListType.purchaseInvoicePriceListType AND isCompanyStock(stock)
                                               THEN priceBatchLedgerStock(stock);
inPriceListLedgerSystemLedgerPriceListType (ledger, type) += WHEN CLASS(priceInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger))) AND type == SystemLedgerPriceListType.purchaseInvoicePriceListType THEN TRUE;
pricePriceListLedgerSystemLedgerPriceListType (ledger, type) += WHEN CLASS(priceInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger))) AND type == SystemLedgerPriceListType.purchaseInvoicePriceListType THEN priceInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger));
editPriceListLedger(d) += ACTION editInvoiceDetail(invoiceDetailInvoicePriceListLedger(d));      
differentOrganizationsLedgerPriceListType(type) += WHEN type == SystemLedgerPriceListType.purchaseInvoicePriceListType THEN TRUE;   
        
EXTEND CLASS SystemLedgerPriceListType { rateExchangePriceListType 'Курс обмена (последний по ценовой группе)' }
batchLedgerPriceListTypeStock(type, stock) += WHEN type == SystemLedgerPriceListType.rateExchangePriceListType AND isCompanyStock(stock)
                                              THEN priceBatchLedgerStock(stock);
inPriceListLedgerSystemLedgerPriceListType (ledger, type) += WHEN isHomeCurrencyInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger)) AND type == SystemLedgerPriceListType.rateExchangePriceListType THEN TRUE;
pricePriceListLedgerSystemLedgerPriceListType (ledger, type) += WHEN isHomeCurrencyInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger)) AND type == SystemLedgerPriceListType.rateExchangePriceListType THEN NUMERIC[14,2](rateExchangeInvoiceDetail(invoiceDetailInvoicePriceListLedger(ledger)));
