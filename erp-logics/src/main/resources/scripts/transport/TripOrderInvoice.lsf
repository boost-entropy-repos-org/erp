MODULE TripOrderInvoice;

REQUIRE TripOrder, TripInvoice;

NAMESPACE Trip;

quantity (trip, invoice) = GROUP SUM quantity(Order order, Invoice invoice) IF in(Trip trip, order) BY trip, invoice;

diffCountOrderInvoice 'Кол-во заказов без накладных'(Trip trip) = countOrder(trip) (-) countInvoice(trip);

createInvoicesOrder 'Создать накладные по заказам' (Trip trip) = ACTION  {
    FOR trip(Order order) == trip DO {
        createUserInvoicePosted(order);
        FOR createdUser (Invoice invoice, order) DO {
            trip(invoice) <- trip; // IF quantityTripInvoice (trip, invoice)
        }

        apply();
    };
    apply();

} TOOLBAR CONFIRM;

EXTEND FORM trip
    PROPERTIES createInvoicesOrder(t) TODRAW i
;