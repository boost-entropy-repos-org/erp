MODULE TripInvoiceWeight;

REQUIRE Invoice, TripInvoice;

NAMESPACE  Trip;

grossWeight 'Вес брутто, кг' = DATA NUMERIC[16,3] (Trip) PREFCHARWIDTH 15;

coeffNetWeightTrip 'Удельный вес' (InvoiceDetail d) =
    NUMERIC[22,8](sumNetWeight(d)) / netWeightInvoiced(trip(invoice(d)));

signGrossWeightInvoices 'Расписать вес брутто'(Trip trip) = ACTION  {
    REQUEST NUMERIC[16,3] INPUT;
    IF requestedNumeric() THEN {
        grossWeight(trip) <- requestedNumeric();
        sumGrossWeight(InvoiceDetail d) <- NUMERIC[9,3](coeffNetWeightTrip(d)* grossWeight(trip))
            WHERE d IS InvoiceDetail AND trip(invoice(d)) == trip;

    } ELSE {
        grossWeight(trip) <- NULL;
        sumGrossWeight(InvoiceDetail d) <- NULL WHERE d IS InvoiceDetail AND trip(invoice(d)) == trip;    
    }        
}

EXTEND FORM trip
    PROPERTIES(t) grossWeight ON CHANGE signGrossWeightInvoices(t)
;

DESIGN trip {
    invoiceSum1 {       
        MOVE PROPERTY(grossWeight(t));
    }
}