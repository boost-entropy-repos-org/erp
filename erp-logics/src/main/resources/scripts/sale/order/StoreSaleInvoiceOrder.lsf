MODULE StoreSaleInvoiceOrder;

REQUIRE StoreSaleOrder, SaleInvoiceOrderAggregation;

NAMESPACE Sale;

WHEN SESSION FORMS userOrder (CHANGED(invoiceQuantity(UserOrderDetail d)) OR CHANGED(invoicePrice(d)) OR CHANGED(valueVAT(d))) 
                               AND VAT(userOrder(d)) AND includeVAT(priceListType(d)) DO {
    invoiceSumInvoice(d) <- IF individualLegalEntitySale(operation(d)) THEN 
            round(invoiceQuantity(d) * invoicePrice(d), roundCondition(supplierStock(d)))     
        ELSE round(invoiceQuantity(d) * invoicePrice(d), currency(d));
    VATSumInvoice(d) <- round(invoiceSumInvoice(d) * calcValueVAT(d) / (100.0 + calcValueVAT(d)), currency(d));
    sumInvoice(d) <- invoiceSumInvoice(d) (-) VATSumInvoice(d); 
}