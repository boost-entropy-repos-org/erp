MODULE SaleStatistics;

REQUIRE System, Utils, Historizable, Stock, LegalEntity, SaleLedger, Sale, Integration;

NAMESPACE Sale;

// ----------------------------------- Статистический классификатор ------------------------------------------ //
CLASS StatisticGroupType 'Тип классификатора статистических групп' : GroupType;
TABLE statisticGroupType (StatisticGroupType);

countryStatisticGroupType = DATA Country (StatisticGroupType);
nameCountryStatisticGroupType 'Страна' (type)= nameCountry(countryStatisticGroupType(type)) IN base;

nameStatisticGroupType 'Наименование' = DATA VARISTRING[100](StatisticGroupType);

idStatisticGroupType 'Идентификатор' = DATA VARSTRING[20] (StatisticGroupType) MINCHARWIDTH 3 MAXCHARWIDTH 10 PREFCHARWIDTH 7;

typeIdStatisticGroupType (string1) = GROUP AGGR type
    BY idStatisticGroupType(type) WHERE type IS StatisticGroupType;

FORM statisticGroupType 'Тип классификатора статистических групп'
    OBJECTS t = StatisticGroupType FIXED PANEL
    PROPERTIES(t) nameStatisticGroupType, idStatisticGroupType, nameCountryStatisticGroupType
    EDIT StatisticGroupType OBJECT t
;

FORM dialogStatisticGroupType 'Тип статистической группы'
    OBJECTS t = StatisticGroupType
    PROPERTIES(t) READONLY nameStatisticGroupType, idStatisticGroupType, nameCountryStatisticGroupType
    DIALOG StatisticGroupType OBJECT t
;

FORM statisticGroupTypes 'Типы статистических групп'
    OBJECTS t = StatisticGroupType
    PROPERTIES(t) READONLY nameStatisticGroupType, idStatisticGroupType, nameCountryStatisticGroupType
    PROPERTIES(t) ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR
;

CLASS StatisticGroup 'Статистическая группа': Group;
TABLE statisticGroup(StatisticGroup);

nameStatisticGroup 'Наименование' = DATA VARISTRING[150](StatisticGroup);

CLASS GroupStatic 'Ед. изм.' {
    statisticLiter 'Литр',
    statisticThing 'Штука',
    statisticPounds 'Килограмм',
    statisticSum 'Валюта',
    statisticLinearMeters 'Пог. м',
    statisticPair 'Пара',
    statisticConditionalPiece 'Усл. кус.',
    statisticSquareMeters 'Квадратный м',
    statisticCubicMeters 'Кубический м'
}
FORM groupStaticsDialog 'Ед. изм. статистики'
    OBJECTS g = GroupStatic
    PROPERTIES(g) READONLY staticCaption
    DIALOG GroupStatic OBJECT g
;

TABLE groupStaticUOM (GroupStatic, UOM);
factorGroupStaticUOM 'Коэффициент перевода' = DATA NUMERIC[14,3] (GroupStatic, UOM);

FORM groupStatics 'Конвертация статистических ед. изм.'
    OBJECTS g=GroupStatic FIXED PANEL
    PROPERTIES(g) SELECTOR staticCaption

    OBJECTS u=UOM
    PROPERTIES   nameUOM(u) READONLY, shortNameUOM(u) READONLY, factorGroupStaticUOM(g,u)

    FILTERGROUP batch
        FILTER 'Ед.изм. с коэфф.' 'F11' factorGroupStaticUOM(g,u)
;

TABLE statisticGroupStatisticGroup(StatisticGroup, StatisticGroup);
@defineHierarchy(statisticGroup);

groupTypeStatisticGroup = DATA StatisticGroupType (StatisticGroup) AUTOSET NOT NULL DELETE;
nameGroupTypeStatisticGroup 'Тип классификатора' (group) = nameStatisticGroupType(groupTypeStatisticGroup(group));

countryStatisticGroup = countryStatisticGroupType(groupTypeStatisticGroup(group));
nameCountryStatisticGroup 'Страна' (statisticGroup)= nameCountry(countryStatisticGroup(statisticGroup)) IN base;

unitMeasureStatisticGroup 'Ед. изм. ИД' (statisticGroup) = DATA GroupStatic (StatisticGroup);
nameUOMStatisticGroup 'Ед. изм.' (statisticGroup) = staticCaption(unitMeasureStatisticGroup(statisticGroup)) MINCHARWIDTH 15 MAXCHARWIDTH 15 PREFCHARWIDTH 15;

sidStatisticGroup 'Код группы' (statisticGroup) = DATA STRING[12] (StatisticGroup)  MINCHARWIDTH 12 MAXCHARWIDTH 12 PREFCHARWIDTH 12;
canonicalNumberStatisticGroup 'Канонический код' (statisticGroup) = VARSTRING[255](
                           [= GROUP CONCAT sidStatisticGroup(parent), ' / ' BY child ORDER DESC levelStatisticGroupStatisticGroup(child, parent)](statisticGroup))
                           MINCHARWIDTH 50 MAXCHARWIDTH 100 PREFCHARWIDTH 100 PERSISTENT;

canonicalNumberNameStatisticGroup 'Канонический код-название' (statisticGroup) = canonicalNumberStatisticGroup(statisticGroup) + ' / ' + nameStatisticGroup(statisticGroup);

groupIdTypeIdGroup (string1, string2) = GROUP AGGR group
    BY idStatisticGroupType(groupTypeStatisticGroup(group)), sidStatisticGroup(group) WHERE group IS StatisticGroup;

sidParentStatisticGroup 'Код родительского объекта' (statisticGroup) = sidStatisticGroup(parentStatisticGroup(statisticGroup));

conversionFactorStatisticGroup 'Коэффициент перевода' (statisticGroup) = DATA NUMERIC[14,5] (StatisticGroup);

FORM statisticGroup 'Статистическая группа'
    OBJECTS g=StatisticGroup FIXED PANEL
    PROPERTIES(g)   nameGroupTypeStatisticGroup, nameStat=nameStatisticGroup, nameParentStatisticGroup, sidParentStatisticGroup,
                    sidStatisticGroup, nameUOMStatisticGroup,conversionFactorStatisticGroup

    EDIT StatisticGroup OBJECT g
;

addStatisticGroupType 'Добавить' = ACTION (group, type) NEWSESSION {
    FOR ADDOBJ g = StatisticGroup DO {
        ASSIGN parentStatisticGroup(g) <- group;
        ASSIGN groupTypeStatisticGroup(g) <- type;
        FORM statisticGroup OBJECTS g = g MODAL;
        IF formResult() == FormResult.ok THEN
            EXEC apply();
    };
} TOOLBAR IMAGE 'add.png' EDITKEY 'INSERT';

addStatisticGroup 'Добавить' (group)= addStatisticGroupType(group, groupTypeStatisticGroup(group)) TOOLBAR IMAGE 'add.png' EDITKEY 'INSERT';

TABLE statisticGroupTypeSku (StatisticGroupType, Sku);
statisticGroupTypeSku = ABSTRACT StatisticGroup (StatisticGroupType, Sku) PERSISTENT;
nameStatisticGroupTypeSku 'Статистическая группа' = nameStatisticGroup(statisticGroupTypeSku(type, sku));

TABLE statisticGroupSku(StatisticGroup, Sku);
isParentStatisticGroupSku (group, sku) = isParentStatisticGroupStatisticGroup(statisticGroupTypeSku(groupTypeStatisticGroup(group),sku), group) PERSISTENT;
isParentLeafStatisticGroupSku (group, sku) = isParentLeafStatisticGroupStatisticGroup(statisticGroupTypeSku(groupTypeStatisticGroup(group),sku), group) PERSISTENT;
parentStatisticGroupTypeSku (type, sku) = parentStatisticGroup(statisticGroupTypeSku(type,sku)) PERSISTENT;

residentCountryCountry 'Отечественный производитель' =  DATA BOOLEAN (Country, Country);
residentStatisticGroupSku (group, sku) = residentCountryCountry(countryStatisticGroupType(groupTypeStatisticGroup(group)), countrySku(sku));

FORM statisticGroups 'Статистические группы'

    OBJECTS ss=Country FIXED PANEL
    PROPERTIES(ss) SELECTOR nameCountry

    OBJECTS c=StatisticGroupType FIXED PANEL
    PROPERTIES(c) SELECTOR nameStatisticGroupType
    FILTERS countryStatisticGroupType(c) == ss

    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES READONLY nameStatisticGroup(g), sidStatisticGroup(g)
    PROPERTIES(g,c)       addStatisticGroupType
    PROPERTIES(g) EDITFORM, ADDFORM
    ORDER BY sidStatisticGroup(g)

    OBJECTS cg=StatisticGroup
    PROPERTIES(cg)     READONLY canonicalNumberNameStatisticGroup, sidStatisticGroup, nameUOMStatisticGroup,
                       conversionFactorStatisticGroup
    PROPERTIES(cg)     DELETE FORCE PANEL TOOLBAR

    FILTERS groupTypeStatisticGroup(g) == c,
            groupTypeStatisticGroup(cg) == c

    OBJECTS s = Country

    PROPERTIES(s) READONLY nameCountry, nameOriginCountry, sidCountry, sidOrigin2Country, sidOrigin3Country,
                           nameCurrencyCountry, nameLanguageCountry
    PROPERTIES(ss,s) residentCountryCountry
    FILTERGROUP filter
        FILTER 'Страны явл. отечественными' 'F11' residentCountryCountry(ss, s) DEFAULT

    FILTERGROUP filters
        FILTER 'Все листья' 'F10' isParentLeafStatisticGroupStatisticGroup(cg, g) DEFAULT
        FILTER 'Всех потомков' 'F9' isParentStatisticGroupStatisticGroup(cg, g)
        FILTER 'Только непосредственных потомков' 'F8' parentStatisticGroup(cg) == g
;

DESIGN statisticGroups FROM DEFAULT {
    main {
        NEW header {
            type = CONTAINERH;
            ADD ss.box;
            ADD c.box;
        }
        NEW specification.box {
            type = TABBED;
            fill = 1;
            NEW topContainer{
                caption = 'Статистические группы';
                type = SPLITH;
                fill = 1;
                ADD treeGroups.tree.box;
                ADD cg.box{fill = 4;}
            }
            ADD s.box {caption = 'Страны являющиеся отечественными';}
        }
    }
    ADD functions.box;
}

FORM statisticGroupDialog 'Статистические группы'
    OBJECTS c=StatisticGroupType FIXED PANEL
    PROPERTIES(c) SELECTOR nameStatisticGroupType

    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES(g) READONLY nameStatisticGroup, nameUOMStatisticGroup, sidStatisticGroup, canonicalNumberStatisticGroup
    PROPERTIES(g) ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR
    FILTERS groupTypeStatisticGroup(g) == c
    ORDER BY canonicalNumberStatisticGroup(g)

    DIALOG StatisticGroup OBJECT g
;

//---------------------------------------------- Отображение в форме товаров -------------------------------------//

parentGroup (statisticGroup) += parentStatisticGroup(statisticGroup);
nameGroup (statisticGroup) += nameStatisticGroup(statisticGroup);
nameGroupType (statisticGroupType) += nameStatisticGroupType (statisticGroupType);
groupTypeGroup (statisticGroup) += groupTypeStatisticGroup (statisticGroup);
groupGroupTypeSku (statisticGroupType, sku) += WHEN CLASS(statisticGroupTypeSku (statisticGroupType, sku)) THEN statisticGroupTypeSku (statisticGroupType, sku);

//---------------------------------------------- Формы стат. отчетов -------------------------------------//

//  12 ТОРГ ПРОДАЖИ

netWeightSoldSkuStockDateFromTo 'Вес проданного товара, кг' (sku, stock, dateFrom, dateTo) =
    quantitySoldSkuStockDateFromTo(sku, stock, dateFrom, dateTo) * netWeightSku(sku);
volumeSoldSkuStockDateFromTo 'Объем проданного товара, л' (sku, stock, dateFrom, dateTo) =
    quantitySoldSkuStockDateFromTo(sku, stock, dateFrom, dateTo) * volumeSku(sku);
// sumSoldSkuStockDateFromTo 'Продано, сумма' (sku, stock, dateFrom, dateTo)   - рубли
//quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)                      - шт.

                            //с коэффициентом пересчета за период//
//всего
quantitySoldByStatisticGroupDateFromTo 'Продано, шт' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku) BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
netWeightSoldByStatisticGroupDateFromTo 'Продано, кг' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
volumeSoldByStatisticGroupDateFromTo 'Продано, л' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
retailSumSoldByStatisticGroupDateFromTo 'Продано, сум.' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

//отечеств. пр-ва
quantitySoldResidentByStatisticGroupDateFromTo 'Продано, шт' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) IF isParentStatisticGroupSku(group, sku)
        BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
netWeightSoldResidentByStatisticGroupDateFromTo 'Продано, кг' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
volumeSoldResidentByStatisticGroupDateFromTo 'Продано, л' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
retailSumSoldResidentByStatisticGroupDateFromTo 'Продано, сум.' (group, stock, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo](group, stock, dateFrom, dateTo)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
//-- на конец
netWeightBalanceASkuLedgerDate 'Вес товара на конец , кг' (sku, stock, date) =
    balanceASkuStockDate (sku, stock, date) * netWeightSku(sku);
volumeBalanceASkuLedgerDate 'Объем товара на конец , л' (sku, stock, date) =
    balanceASkuStockDate (sku, stock, date) * volumeSku(sku);

//-- на начало
netWeightBalanceBSkuLedgerDate 'Вес товара на начало , кг' (sku, stock, date) =
    balanceBSkuStockDate (sku, stock, date) * netWeightSku(sku);
volumeBalanceBSkuLedgerDate 'Объем товара на начало , л' (sku, stock, date) =
    balanceBSkuStockDate (sku, stock, date) * volumeSku(sku);
    
//sumASkuStockDate (sku, stock, dateTo) -  сумма на конец

//retailSumBalanceASkuLedgerDate 'Сумма товара на конец , сум.' (sku, stock, dateTo) =
//    retailPriceASkuStockDate (sku, stock, dateTo) * balanceASkuStockDate(sku, stock, dateTo);
//balanceASkuStockDate (sku, stock, dateTo)    - шт.

                                   //с коэффициентом пересчета на конец//
// всего
balanceAByStatisticGroupDate 'Остаток на конец' (group, stock, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group, stock, date](group, stock, date)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
netWeightAByStatisticGroupDate 'Вес на конец, кг' (group, stock, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
volumeAByStatisticGroupDate 'Объем на конец, л' (group, stock, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
retailSumAByStatisticGroupDate 'Сумма на конец, сум.' (group, stock, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
        
// отечеств. пр-ва
balanceResidentAByStatisticGroupDate 'Остаток на конец' (group, stock, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, stock, date](group, stock, date)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
netWeightResidentAByStatisticGroupDate 'Вес на конец, кг' (group, stock, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
volumeResidentAByStatisticGroupDate 'Объем на конец, л' (group, stock, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
retailSumResidentAByStatisticGroupDate 'Сумма на конец, сум.' (group, stock, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));        
        
                                   //с коэффициентом пересчета на начало//
// всего
balanceBByStatisticGroupDate 'Остаток на начало' (group, stock, date)=
    [= GROUP SUM balanceBSkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group, stock, date](group, stock, date)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));        
netWeightBByStatisticGroupDate 'Вес на начало, кг' (group, stock, date)=
    [= GROUP SUM netWeightBalanceBSkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));   
volumeBByStatisticGroupDate 'Объем на начало, л' (group, stock, date)=
    [= GROUP SUM volumeBalanceBSkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));   
retailSumBByStatisticGroupDate 'Сумма на начало, сум.' (group, stock, date)=
    [= GROUP SUM sumBSkuStockDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));                  
                  

// отечеств. пр-ва
balanceResidentBByStatisticGroupDate 'Остаток на начало' (group, stock, date)=
    [= GROUP SUM balanceBSkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, stock, date](group, stock, date)/
            (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
netWeightResidentBByStatisticGroupDate 'Вес на начало, кг' (group, stock, date)=
    [= GROUP SUM netWeightBalanceBSkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
volumeResidentBByStatisticGroupDate 'Объем на начало, л' (group, stock, date)=
    [= GROUP SUM volumeBalanceBSkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
retailSumResidentBByStatisticGroupDate 'Сумма на начало, сум.' (group, stock, date)=
    [= GROUP SUM sumBSkuStockDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, date](group, stock, date)/
        (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));                                


valueByStatisticGroupDateFromTo 'Продано' (group, stock, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock
    ;
valueResidentByStatisticGroupDateFromTo 'Продано, бел. пр-ва' (group, stock, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldResidentByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldResidentByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldResidentByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldResidentByStatisticGroupDateFromTo(group, stock, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock
    ;

valueByStatisticGroupDateTo 'Остаток на конец' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumAByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;
valueResidentByStatisticGroupDateTo 'Остаток на конец, бел. пр-ва' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentAByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;

quantitySoldNotStatisticGroupTypeDateFromTo 'Продано без группы, шт' (type, stock, dateFrom, dateTo)=
    GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type,sku)  BY type, stock, dateFrom, dateTo;  
    
balanceBNotStatisticGroupTypeDate 'Остаток на начало без групп, шт' (type, stock, date)=
    GROUP SUM  balanceBSkuStockDate (sku, stock, date) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type,sku)  BY type, stock, date;  
balanceANotStatisticGroupTypeDate 'Остаток на конец без групп, шт' (type, stock, date)=
    GROUP SUM  balanceASkuStockDate (sku, stock, date) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type,sku)  BY type, stock, date; 
    
backgroundQuantityNotStatisticGroup (type, stock, dateFrom, dateTo) =  RGB(255,0,0) IF quantitySoldNotStatisticGroupTypeDateFromTo(type, stock, dateFrom, dateTo);
backgroundBalanceBNotStatisticGroup (type, stock, date) =  RGB(255,0,0) IF balanceBNotStatisticGroupTypeDate(type, stock, date);
backgroundBalanceANotStatisticGroup (type, stock, date) =  RGB(255,0,0) IF balanceANotStatisticGroupTypeDate(type, stock, date);
    
FORM statisticalReport 'Статистика (продажи) склад/группа/sku'

    OBJECTS dates = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES OBJVALUE(dFrom), OBJVALUE(dTo)
    OBJECTS c = StatisticGroupType FIXED PANEL
    PROPERTIES SELECTOR nameStatisticGroupType(c)

    TREE stockTree a = STRING[3], sg = StockGroup PARENT parentStockGroup, ts = Stock
    PROPERTIES READONLY OBJVALUE(a), sgTreeName = nameStockGroup(sg), nameStock(ts)
    ORDER BY sgTreeName
    FILTERS stringEqualsAll(a),
            stockGroupStock(ts) == sg
    FILTERGROUP inactiveStock FILTER 'Активный' 'ctrl F10' activeStock(ts) DEFAULT        
            
//    PROPERTIES READONLY 
//               balanceBNotStatisticGroupTypeDate(c,ts,dFrom) BACKGROUND backgroundBalanceBNotStatisticGroup(c,ts,dFrom),
//               quantitySoldNotStatisticGroupTypeDateFromTo(c,ts,dFrom,dTo) BACKGROUND backgroundQuantityNotStatisticGroup(c,ts,dFrom,dTo),
//               balanceANotStatisticGroupTypeDate(c,ts,dTo) BACKGROUND backgroundBalanceANotStatisticGroup(c,ts,dTo)
    
    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES READONLY gname = nameStatisticGroup(g),  sidStatisticGroup(g), nameUOMStatisticGroup(g)
    ORDER BY gname
    FILTERS groupTypeStatisticGroup(g) ==c

    OBJECTS           sts=(st=Stock, s=Sku)
    PROPERTIES        READONLY nameS=nameSku(s), nameStock(st)
    FILTERS           st == ts AND sg IS StockGroup OR isParentStockGroupStock(sg, st) AND NOT ts OR st IS Stock AND NOT sg AND NOT ts
    FILTERGROUP inactiveStock2 FILTER 'Активный' 'ctrl F10' activeStock(st) DEFAULT
    ORDER BY          nameS
    FILTERGROUP filters
        FILTER 'Все листья' 'F10' isParentLeafStatisticGroupSku(g, s) DEFAULT
        FILTER 'Всех потомков' 'F9' isParentStatisticGroupSku(g, s)
        FILTER 'Только непосредственных потомков' 'F8' parentStatisticGroupTypeSku(c,s) == g

    PROPERTIES        balanceBSkuStockDate(s, st, dFrom),
                      quantitySoldSkuStockDateFromTo(s, st, dFrom, dTo),
                      balanceASkuStockDate(s, st, dTo)
    PROPERTIES  FORCE PANEL valueByStatisticGroupDateFromTo(g, ts, dFrom, dTo), valueResidentByStatisticGroupDateFromTo(g, ts, dFrom, dTo)
    PROPERTIES  FORCE PANEL valueByStatisticGroupDateTo(g, ts, dTo), valueResidentByStatisticGroupDateTo(g, ts, dTo)
;
@extendFormFilterStockAccess(st, statisticalReport);
@extendFormFilterStockAccess(ts, statisticalReport);
@extendFormFilterStockGroupAccess(sg, statisticalReport);

DESIGN statisticalReport FROM DEFAULT {
    main{
        NEW topContainer{
            type = SPLITH;
            fill = 1;
            NEW firstCase {
                type = SPLITV;
                fill = 1;
                ADD stockTree.tree.box { caption = 'Склады'; }
                ADD treeGroups.tree.box { caption = 'Статистические группы'; }
            }

            NEW secondCase {
                fill = 2;
                NEW wor {
                    type = CONTAINERH;
                    ADD dates.box;
                    ADD c.box {caption = 'Тип классификатора статистических групп';};
                }
                ADD sts.box {caption = 'Показатели по продажам в номинальных единицах';}
            }
        }
        NEW row {
            caption = 'Суммы';
            NEW row1 {
                type = CONTAINERH;
                caption = 'По отдел-группа, с учетом ед. изм. и коэфф. перевода';
                ADD PROPERTY(valueByStatisticGroupDateFromTo(g,ts,dFrom,dTo));
                ADD PROPERTY(valueResidentByStatisticGroupDateFromTo(g,ts,dFrom,dTo));
                ADD PROPERTY(valueByStatisticGroupDateTo(g,ts,dTo));
                ADD PROPERTY(valueResidentByStatisticGroupDateTo(g,ts,dTo));
            }
        }
    }
    ADD functions.box;
}

                ///////////////--------по регионам и компании----------/////////////////

                           //c коэффициентом пересчета за период//
// всего
quantitySoldByStatisticGroupRegionDateFromTo 'Продано, шт' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
            (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightSoldByStatisticGroupRegionDateFromTo 'Продано, кг' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeSoldByStatisticGroupRegionDateFromTo 'Продано, л' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumSoldByStatisticGroupRegionDateFromTo 'Продано, руб.' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

// отечест. производствава
quantitySoldResidentByStatisticGroupRegionDateFromTo 'Продано, шт' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
            (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightSoldResidentByStatisticGroupRegionDateFromTo 'Продано, кг' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeSoldResidentByStatisticGroupRegionDateFromTo 'Продано, л' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumSoldResidentByStatisticGroupRegionDateFromTo 'Продано, руб.' (group, legalEntity, region, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo]
        (group, legalEntity, region, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

                             //с коэффициентом пересчета на коцен//
// всего
balanceAByStatisticGroupRegionDate 'Остаток на конец' (group, legalEntity, region, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group,legalEntityStock(stock), regionStock(stock), date]
            (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightAByStatisticGroupRegionDate 'Вес на конец, кг' (group, legalEntity, region, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeAByStatisticGroupRegionDate 'Объем на конец, л' (group, legalEntity, region, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumAByStatisticGroupRegionDate 'Сумма на конец, руб' (group, legalEntity, region, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
// белорусского производства
balanceResidentAByStatisticGroupRegionDate 'Остаток на конец' (group, legalEntity, region, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), regionStock(stock), date]
            (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightResidentAByStatisticGroupRegionDate 'Вес на конец, кг' (group, legalEntity, region, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeResidentAByStatisticGroupRegionDate 'Объем на конец, л' (group, legalEntity, region, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumResidentAByStatisticGroupRegionDate 'Сумма на конец, руб' (group, legalEntity, region, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), date]
        (group, legalEntity, region, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

valueByStatisticGroupLegalEntityRegionDateFromTo 'Продано всего' (group, legalEntity, region, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity
    ;

valueByStatisticGroupLegalEntityRegionDateTo 'Остаток на конец всего' (group, legalEntity, region, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumAByStatisticGroupRegionDate(group, legalEntity, region, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND region IS Region AND date IS DATE
    ;

valueResidentByStatisticGroupLegalEntityRegionDateFromTo 'Продано отеч. пр-ва' (group, legalEntity, region, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldResidentByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldResidentByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldResidentByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldResidentByStatisticGroupRegionDateFromTo(group, legalEntity, region, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND region IS Region
    ;

valueResidentByStatisticGroupLegalEntityRegionDateTo 'Остаток на конец отеч. пр-ва' (group, legalEntity, region, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentAByStatisticGroupRegionDate(group, legalEntity, region, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentAByStatisticGroupRegionDate(group, legalEntity, region, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND region IS Region AND date IS DATE
    ;

totalRetailSumSoldByStatisticGroupRegionDateFromTo 'Итого продано, руб.' (group, legalEntity, region, dateFrom, dateTo)=
    GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), regionStock(stock), dateFrom, dateTo;

FORM torgSales 'Статистика (продажи) организация/регион/группа'

    OBJECTS params = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES objFrom = OBJVALUE(dFrom), objTo = OBJVALUE(dTo)

    OBJECTS c = StatisticGroupType FIXED PANEL
    PROPERTIES SELECTOR nameStatisticGroupType(c)

    OBJECTS l=LegalEntity  FIXED PANEL
    PROPERTIES(l) SELECTOR nameLegalEntity

    OBJECTS r=Region  FIXED PANEL
    PROPERTIES(r) SELECTOR nameRegion

    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES READONLY gname = nameStatisticGroup(g), sidStatisticGroup(g), nameUOMStatisticGroup(g)
    ORDER BY sidStatisticGroup(g)

    FILTERS groupTypeStatisticGroup(g) == c

    PROPERTIES(g, l, r, dFrom, dTo) valueByStatisticGroupLegalEntityRegionDateFromTo, valueResidentByStatisticGroupLegalEntityRegionDateFromTo
    PROPERTIES(g, l, r, dTo) valueByStatisticGroupLegalEntityRegionDateTo, valueResidentByStatisticGroupLegalEntityRegionDateTo
    PROPERTIES(g, l, r, dFrom, dTo) totalRetailSumSoldByStatisticGroupRegionDateFromTo
;

DESIGN torgSales FROM DEFAULT {

    main{
        NEW firstCase BEFORE treeGroups.tree.box {
            caption = 'Параметры отчета';
            type = CONTAINERH;
            ADD c.box;
            NEW dateCase {
                caption = 'Даты';
                type = CONTAINERH;
                ADD PROPERTY(objFrom) {caption = 'Дата (с)';}
                ADD PROPERTY(objTo) {caption = 'Дата (по)';}
            }
            ADD l.box;
            ADD r.box;
        }
        ADD treeGroups.tree.box {caption = 'Показатели по стат. группам с учетом ед. изм. и коэфф. перевода';}
        ADD functions.box;
    }
}

//---------------------------------------------- Статотчет опта в соответствии с законодательством-----------------------------------------------------//

//------------------------------------- остатки и продажи по организациям-------------------------------------//
// всего
quantitySoldByStatisticGroupLegalEntityDateFromTo 'Продано, шт' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), dateFrom, dateTo]
            (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightSoldByStatisticGroupLegalEntityDateFromTo 'Продано, кг' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeSoldByStatisticGroupLegalEntityDateFromTo 'Продано, л' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumSoldByStatisticGroupLegalEntityDateFromTo 'Продано, руб.' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

// отечест. производствава
quantitySoldResidentByStatisticGroupLegalEntityDateFromTo 'Продано, шт' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), dateFrom, dateTo]
            (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightSoldResidentByStatisticGroupLegalEntityDateFromTo 'Продано, кг' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM netWeightSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeSoldResidentByStatisticGroupLegalEntityDateFromTo 'Продано, л' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM volumeSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumSoldResidentByStatisticGroupLegalEntityDateFromTo 'Продано, руб.' (group, legalEntity, dateFrom, dateTo)=
    [= GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo]
        (group, legalEntity, dateFrom, dateTo) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

                             //с коэффициентом пересчета на коцен//
// всего
balanceAByStatisticGroupLegalEntityDate 'Остаток на конец' (group, legalEntity, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group,legalEntityStock(stock), date]
            (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightAByStatisticGroupLegalEntityDate 'Вес на конец, кг' (group, legalEntity, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeAByStatisticGroupLegalEntityDate 'Объем на конец, л' (group, legalEntity, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumAByStatisticGroupLegalEntityDate 'Сумма на конец, руб' (group, legalEntity, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
// белорусского производства
balanceResidentAByStatisticGroupLegalEntityDate 'Остаток на конец' (group, legalEntity, date)=
    [= GROUP SUM balanceASkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), date]
            (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightResidentAByStatisticGroupLegalEntityDate 'Вес на конец, кг' (group, legalEntity, date)=
    [= GROUP SUM netWeightBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeResidentAByStatisticGroupLegalEntityDate 'Объем на конец, л' (group, legalEntity, date)=
    [= GROUP SUM volumeBalanceASkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumResidentAByStatisticGroupLegalEntityDate 'Сумма на конец, руб' (group, legalEntity, date)=
    [= GROUP SUM sumASkuStockDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

                             //с коэффициентом пересчета на начало//
// всего
balanceBByStatisticGroupLegalEntityDate 'Остаток на начало' (group, legalEntity, date)=
    [= GROUP SUM balanceBSkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    isParentStatisticGroupSku(group, sku)
        BY group,legalEntityStock(stock), date]
            (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightBByStatisticGroupLegalEntityDate 'Вес на начало, кг' (group, legalEntity, date)=
    [= GROUP SUM netWeightBalanceBSkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeBByStatisticGroupLegalEntityDate 'Объем на начало, л' (group, legalEntity, date)=
    [= GROUP SUM volumeBalanceBSkuLedgerDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumBByStatisticGroupLegalEntityDate 'Сумма на начало, руб' (group, legalEntity, date)=
    [= GROUP SUM sumBSkuStockDate (sku, stock, date) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));
// белорусского производства
balanceResidentBByStatisticGroupLegalEntityDate 'Остаток на начало' (group, legalEntity, date)=
    [= GROUP SUM balanceBSkuStockDate (sku, stock, date)/
    (OVERRIDE 1 IF group IS StatisticGroup AND sku IS Sku, factorGroupStaticUOM(unitMeasureStatisticGroup(group), UOMSku(sku))) IF
    residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
        BY group, legalEntityStock(stock), date]
            (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

netWeightResidentBByStatisticGroupLegalEntityDate 'Вес на начало, кг' (group, legalEntity, date)=
    [= GROUP SUM netWeightBalanceBSkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

volumeResidentBByStatisticGroupLegalEntityDate 'Объем на начало, л' (group, legalEntity, date)=
    [= GROUP SUM volumeBalanceBSkuLedgerDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

retailSumResidentBByStatisticGroupLegalEntityDate 'Сумма на начало, руб' (group, legalEntity, date)=
    [= GROUP SUM sumBSkuStockDate (sku, stock, date) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), date]
        (group, legalEntity, date) / (OVERRIDE 1 IF group IS StatisticGroup, conversionFactorStatisticGroup(group));

valueByStatisticGroupLegalEntityDateFromTo 'Продано, ЕИ' (group, legalEntity, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity
    ;

valueByStatisticGroupLegalEntityDateFrom 'Остаток на начало, ЕИ' (group, legalEntity, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND date IS DATE
    ;

valueResidentByStatisticGroupLegalEntityDateFrom 'В т.ч. отеч., ЕИ' (group, legalEntity, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentBByStatisticGroupLegalEntityDate(group, legalEntity, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND date IS DATE
    ;

valueByStatisticGroupLegalEntityDateTo 'Остаток на конец, ЕИ' (group, legalEntity, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND date IS DATE
    ;

valueResidentByStatisticGroupLegalEntityDateFromTo 'В т.ч. отеч., ЕИ' (group, legalEntity, dateFrom, dateTo) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN quantitySoldResidentByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightSoldResidentByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeSoldResidentByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumSoldResidentByStatisticGroupLegalEntityDateFromTo(group, legalEntity, dateFrom, dateTo)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity
    ;

valueResidentByStatisticGroupLegalEntityDateTo 'В т.ч. отеч., ЕИ' (group, legalEntity, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentAByStatisticGroupLegalEntityDate(group, legalEntity, date)
        ELSE 0 IF group IS StatisticGroup AND legalEntity IS LegalEntity AND date IS DATE
    ;

totalSumSoldByStatisticGroupLegalEntityDateFromTo 'Продано, руб.' (group, legalEntity, dateFrom, dateTo)=
    GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo;

totalSumResidentSoldByStatisticGroupLegalEntityDateFromTo 'В т.ч.отеч., руб.' (group, legalEntity, dateFrom, dateTo)=
    GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, legalEntityStock(stock), dateFrom, dateTo;

// суммовые показатели
sumBalanceBByStatisticGroupLegalEntityDate 'Сумма остатка на начало, руб.' (group, legalEntity, date) =
    GROUP SUM sumBSkuStockDate (sku, stock, dateFrom) IF isParentStatisticGroupSku(group, sku)
    BY group,legalEntityStock(stock), dateFrom;

sumResidentBalanceBByStatisticGroupLegalEntityDate 'В т.ч.отеч., руб.' (group, legalEntity, date) =
    GROUP SUM sumBSkuStockDate (sku, stock, dateFrom) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group,legalEntityStock(stock), dateFrom;

sumBalanceAByStatisticGroupLegalEntityDate 'Сумма остатка на конец, руб.' (group, legalEntity, date) =
    GROUP SUM sumASkuStockDate (sku, stock, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group,legalEntityStock(stock), dateTo;

sumResidentBalanceAByStatisticGroupLegalEntityDate 'В т.ч.отеч., руб.' (group, legalEntity, date) =
    GROUP SUM sumASkuStockDate (sku, stock, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group,legalEntityStock(stock), dateTo;


//residentStatisticGroupSku (group, sku) AND

quantitySoldNotStatisticGroupTypeLegalEntityDateFromTo 'Продано без группы, шт' (type, legalEntity, dateFrom, dateTo)=
    GROUP SUM quantitySoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type, sku) BY type, legalEntityStock(stock), dateFrom, dateTo;  
    
balanceBNotStatisticGroupTypeLegalEntityDate 'Остаток на начало без групп, шт' (type, legalEntity, date)=
    GROUP SUM  balanceBSkuStockDate (sku, stock, date) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type,sku)  BY type, legalEntityStock(stock), date;  
balanceANotStatisticGroupTypeLegalEntityDate 'Остаток на конец без групп, шт' (type, legalEntity, date)=
    GROUP SUM  balanceASkuStockDate (sku, stock, date) IF type IS StatisticGroupType AND NOT       
    statisticGroupTypeSku(type,sku)  BY type, legalEntityStock(stock), date; 
    
backgroundQuantityNotStatisticGroupLegalEntity (type, legalEntity, dateFrom, dateTo) =  RGB(255,0,0) IF quantitySoldNotStatisticGroupTypeLegalEntityDateFromTo(type, legalEntity, dateFrom, dateTo);
backgroundBalanceBNotStatisticGroupLegalEntity (type, legalEntity, date) =  RGB(255,0,0) IF balanceBNotStatisticGroupTypeLegalEntityDate(type, legalEntity, date);
backgroundBalanceANotStatisticGroupLegalEntity (type, legalEntity, date) =  RGB(255,0,0) IF balanceANotStatisticGroupTypeLegalEntityDate(type, legalEntity, date);

FORM statisticalLegalEntityReport 'Статистический отчет по организации'

    OBJECTS params = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES objFrom = OBJVALUE(dFrom), objTo = OBJVALUE(dTo)

    OBJECTS c = StatisticGroupType FIXED PANEL
    PROPERTIES SELECTOR nameStatisticGroupType(c)

    OBJECTS l=LegalEntity  FIXED PANEL
    PROPERTIES(l) SELECTOR nameLegalEntity      
    
    PROPERTIES READONLY balanceBNotStatisticGroupTypeLegalEntityDate(c,l,dFrom) BACKGROUND backgroundBalanceBNotStatisticGroupLegalEntity(c,l,dFrom),
               quantitySoldNotStatisticGroupTypeLegalEntityDateFromTo(c,l,dFrom, dTo) BACKGROUND backgroundQuantityNotStatisticGroupLegalEntity(c,l,dFrom, dTo),
               balanceANotStatisticGroupTypeLegalEntityDate(c,l,dTo) BACKGROUND backgroundBalanceANotStatisticGroupLegalEntity(c,l,dTo)    
    FILTERS isCompanyLegalEntity(l)
    
    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES READONLY gname = nameStatisticGroup(g), sidStatisticGroup(g), nameUOMStatisticGroup(g)
    ORDER BY sidStatisticGroup(g)

    FILTERS groupTypeStatisticGroup(g) == c

    PROPERTIES(g, l, dFrom) READONLY valueByStatisticGroupLegalEntityDateFrom, valueResidentByStatisticGroupLegalEntityDateFrom,
                                     sumBalanceBByStatisticGroupLegalEntityDate, sumResidentBalanceBByStatisticGroupLegalEntityDate
    PROPERTIES(g, l, dFrom, dTo) READONLY valueByStatisticGroupLegalEntityDateFromTo, valueResidentByStatisticGroupLegalEntityDateFromTo,
                                          totalSumSoldByStatisticGroupLegalEntityDateFromTo, totalSumResidentSoldByStatisticGroupLegalEntityDateFromTo
    PROPERTIES(g, l, dTo) READONLY valueByStatisticGroupLegalEntityDateTo, valueResidentByStatisticGroupLegalEntityDateTo,
                                   sumBalanceAByStatisticGroupLegalEntityDate, sumResidentBalanceAByStatisticGroupLegalEntityDate
;

DESIGN statisticalLegalEntityReport FROM DEFAULT {
    main{
        NEW firstCase BEFORE treeGroups.tree.box {
            caption = 'Параметры отчета';
            type = CONTAINERV;
            NEW row {
                type = CONTAINERH;
                ADD c.box;
                NEW dateCase {
                    caption = 'Даты';
                    type = CONTAINERH;
                    ADD PROPERTY(objFrom) {caption = 'Дата (с)';}
                    ADD PROPERTY(objTo) {caption = 'Дата (по)';}
                }             
            }
            ADD l.box;
        }
        ADD functions.box;
    }
}

//------------------------------------- остатки и продажи по складу-------------------------------------//

                             //с коэффициентом пересчета на коцен//
valueByStatisticGroupStockDateFrom 'Остаток на начало, ЕИ' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumBByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;

valueResidentByStatisticGroupStockDateFrom 'В т.ч. отеч., ЕИ' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentBByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentBByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;

valueByStatisticGroupStockDateTo 'Остаток на конец, ЕИ' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumAByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;

valueResidentByStatisticGroupStockDateTo 'В т.ч. отеч., ЕИ' (group, stock, date) =
    CASE
        WHEN (unitMeasureStatisticGroup(group)==GroupStatic.statisticThing OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticLinearMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticPair OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticConditionalPiece OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticSquareMeters OR
             unitMeasureStatisticGroup(group)==GroupStatic.statisticCubicMeters)
            THEN balanceResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticPounds
            THEN netWeightResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticLiter
            THEN volumeResidentAByStatisticGroupDate(group, stock, date)
        WHEN unitMeasureStatisticGroup(group)==GroupStatic.statisticSum
            THEN retailSumResidentAByStatisticGroupDate(group, stock, date)
        ELSE 0 IF group IS StatisticGroup AND stock IS Stock AND date IS DATE
    ;

totalSumSoldByStatisticGroupStockDateFromTo 'Продано, руб.' (group, stock, dateFrom, dateTo)=
    GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo;

totalSumResidentSoldByStatisticGroupStockDateFromTo 'В т.ч.отеч., руб.' (group, stock, dateFrom, dateTo)=
    GROUP SUM sumSoldSkuStockDateFromTo (sku, stock, dateFrom, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom, dateTo;

// суммовые показатели
sumBalanceBByStatisticGroupStockDate 'Сумма остатка на начало, руб.' (group, stock, date) =
    GROUP SUM sumBSkuStockDate (sku, stock, dateFrom) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom;

sumResidentBalanceBByStatisticGroupStockDate 'В т.ч.отеч., руб.' (group, stock, date) =
    GROUP SUM sumBSkuStockDate (sku, stock, dateFrom) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateFrom;

sumBalanceAByStatisticGroupStockDate 'Сумма остатка на конец, руб.' (group, stock, date) =
    GROUP SUM sumASkuStockDate (sku, stock, dateTo) IF isParentStatisticGroupSku(group, sku)
    BY group, stock, dateTo;

sumResidentBalanceAByStatisticGroupStockDate 'В т.ч.отеч., руб.' (group, stock, date) =
    GROUP SUM sumASkuStockDate (sku, stock, dateTo) IF residentStatisticGroupSku (group, sku) AND isParentStatisticGroupSku(group, sku)
    BY group, stock, dateTo;


//residentStatisticGroupSku (group, sku) AND

FORM statisticalStockReport 'Статистический отчет по складу'

    OBJECTS params = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES objFrom = OBJVALUE(dFrom), objTo = OBJVALUE(dTo)

    OBJECTS c = StatisticGroupType FIXED PANEL
    PROPERTIES SELECTOR nameStatisticGroupType(c)

    OBJECTS s=Stock  FIXED PANEL
    PROPERTIES(s) SELECTOR nameStock
    FILTERS isCompanyStock(s)
    PROPERTIES READONLY 
               balanceBNotStatisticGroupTypeDate(c,s,dFrom) BACKGROUND backgroundBalanceBNotStatisticGroup(c,s,dFrom),
               quantitySoldNotStatisticGroupTypeDateFromTo(c,s,dFrom,dTo) BACKGROUND backgroundQuantityNotStatisticGroup(c,s,dFrom,dTo),
               balanceANotStatisticGroupTypeDate(c,s,dTo) BACKGROUND backgroundBalanceANotStatisticGroup(c,s,dTo)    

    TREE treeGroups g=StatisticGroup PARENT parentStatisticGroup
    PROPERTIES READONLY gname = nameStatisticGroup(g), sidStatisticGroup(g), nameUOMStatisticGroup(g)
    ORDER BY sidStatisticGroup(g)

    FILTERS groupTypeStatisticGroup(g) == c

    PROPERTIES(g, s, dFrom) READONLY valueByStatisticGroupStockDateFrom, valueResidentByStatisticGroupStockDateFrom,
                                     sumBalanceBByStatisticGroupStockDate, sumResidentBalanceBByStatisticGroupStockDate
    PROPERTIES(g, s, dFrom, dTo) READONLY valueByStatisticGroupDateFromTo, valueResidentByStatisticGroupDateFromTo,
                                          totalSumSoldByStatisticGroupStockDateFromTo, totalSumResidentSoldByStatisticGroupStockDateFromTo
    PROPERTIES(g, s, dTo) READONLY valueByStatisticGroupDateTo, valueResidentByStatisticGroupDateTo,
                                   sumBalanceAByStatisticGroupStockDate, sumResidentBalanceAByStatisticGroupStockDate
;

DESIGN statisticalStockReport FROM DEFAULT {
    main{
        NEW firstCase BEFORE treeGroups.tree.box {
            caption = 'Параметры отчета';
            type = CONTAINERV;
            NEW row {
                type = CONTAINERH;
                ADD c.box;
                NEW dateCase {
                    caption = 'Даты';
                    type = CONTAINERH;
                    ADD PROPERTY(objFrom) {caption = 'Дата (с)';}
                    ADD PROPERTY(objTo) {caption = 'Дата (по)';}
                }             
            }
            ADD s.box;
        }
        ADD functions.box;
    }
}


//---------------------------------------------- Автоматическое заполнение -----------------------------------------------------//

loadDefaultStatisticGroupType 'Добавить значение классификатора стат.групп' = ACTION (iname, isid, isidCountry) {
    FOR ADDOBJ t = StatisticGroupType DO {
        ASSIGN nameStatisticGroupType(t) <- iname;
        ASSIGN idStatisticGroupType (t) <- isid;
        ASSIGN countryStatisticGroupType(t) <- countrySID(isidCountry);
    }
}

loadDefaultStatisticGroup 'Добавить значение статистические группы' = ACTION (sidType, sidParent, iname, isid, groupStatic, value) {
    FOR ADDOBJ g = StatisticGroup DO {
        ASSIGN groupTypeStatisticGroup(g) <- typeIdStatisticGroupType(sidType);
        ASSIGN parentStatisticGroup(g) <- groupIdTypeIdGroup(sidType, sidParent);

        ASSIGN nameStatisticGroup(g) <- iname;
        ASSIGN sidStatisticGroup(g) <- isid;
        ASSIGN unitMeasureStatisticGroup(g) <- groupStatic;
        ASSIGN conversionFactorStatisticGroup(g) <- value;
    }
}

loadDefaultResidentCountry 'Добавить отеч. производ' = ACTION (idCountry, idCountry2)  {
    ASSIGN residentCountryCountry(a,b) <- TRUE WHERE a == countrySID(idCountry) AND b == countrySID(idCountry2);
}

loadDefaultStatisticGroups 'Загрузить стандартные статистические группы и классификатор' () = ABSTRACT ACTION LIST ()  IN loadDefault;
@implementLoadDefaultData(loadDefaultStatisticGroups);

NAVIGATOR {
    saleNavigator {
        NEW statisticsNavigator 'Статистика' BEFORE saleMasterData {
            ADD statisticGroupTypes;
            ADD statisticGroups;
            ADD groupStatics;
            ADD statisticalReport;
            ADD torgSales;
            ADD statisticalLegalEntityReport;
            ADD statisticalStockReport;
        }
    }
}