MODULE SaleLedgerArticle;

REQUIRE SaleLedger, SaleLedgerItemArticle, StockArticle;

NAMESPACE SaleLedger;

//------------------- Продажи по артикулам -------------------------//


nameArticleBalanceBStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(остаток на начало)\''](nameStock(stock));    
nameArticleSumBStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма на начало)\''](nameStock(stock));    
nameArticleBalanceAStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(остаток на конец)\''](nameStock(stock));    
nameArticleSumAStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма на конец)\''](nameStock(stock));    
nameArticleQuantitySoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(продано кол-во)\''](nameStock(stock));    
nameArticleSumSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(продано сумма)\''](nameStock(stock));    
nameArticleDaysOnStockStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(дней на складе)\''](nameStock(stock));    
nameArticleAverageReportSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(продаж в день)\''](nameStock(stock));    
nameArticleTurnoverStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(товарооборачиваемость)\''](nameStock(stock));

nameArticleContractSumSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма контр. вал.)\''](nameStock(stock));    
nameArticleCostSumSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма себестоимость)\''](nameStock(stock));    
nameArticleMarkupSumSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма торг. надбавки)\''](nameStock(stock));    
nameArticleVATSumSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма НДС)\''](nameStock(stock));    
nameArticleAveragePriceSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(цена ср.)\''](nameStock(stock));    
nameArticleContractSumByrSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(сумма контр. руб.)\''](nameStock(stock));    
nameArticleAverageMarkupSoldStock (stock)= [= FORMULA VARSTRING[50] 'CAST($1 AS TEXT) || \' \' || \'(ср. % надбавки)\''](nameStock(stock));    
    
    
inArticleReportStock 'Отм.' = DATA SESSION BOOLEAN (Stock);

filterBalanceArticleDateFromTo 'С остатком' (ar,dFrom, dTo) = GROUP SUM 1 IF inArticleReportStock(st) AND (balanceBArticleStockDate(ar,st,dFrom) OR balanceAArticleStockDate(ar,st,dTo))
    BY ar,dFrom, dTo;
filterSoldArticleDateFromTo 'С продажей' (ar,dFrom,dTo) = GROUP SUM quantitySoldArticleStockDateFromTo(ar,st,dFrom,dTo) IF inArticleReportStock(st) 
    BY ar,dFrom,dTo;   

daysOnStockArticleStock 'Дней на складе' = DATA SESSION INTEGER (Article, Stock);
averageReportSoldArticleStock 'Продаж в день' = DATA SESSION NUMERIC[14,3] (Article, Stock);
turnoverArticleStock 'Товароооборачиваемость' = DATA SESSION NUMERIC[14,2] (Article, Stock);

calcSaleArticleParamsInterval 'Рассчитать продажи в день и товарооборачиваемость' = ACTION (dateFrom, dateTo) {
    LOCAL balance = NUMERIC[14,3] (Article, Stock);
    LOCAL cumBalance = NUMERIC[16,3] (Article, Stock);
    LOCAL dateCur = DATE();

    dateCur() <- dateFrom;
    balance(a, stock) <- balanceBArticleStockDate(a, stock, dateFrom) WHERE inArticleReportStock(stock);
    daysOnStockArticleStock(a, stock) <- NULL;
    
    WHILE dateCur() <= dateTo DO {
        daysOnStockArticleStock(a, stock) <- daysOnStockArticleStock(a, stock) (+)
                   (1 IF ((balance(a, stock) > 0) OR (quantityArticleStockDate(a, stock, dateCur()) > 0)));
        cumBalance(a, stock) <- cumBalance(a, stock) (+) balance(a, stock);  
        balance(a, stock) <- balance(a, stock) (+)
                   signedQuantityArticleStockDate(a, stock, dateCur());

        dateCur() <- sumDate(dateCur(), 1);
    }

    averageReportSoldArticleStock(a, stock) <- quantitySoldArticleStockDateFromTo (a, stock, dateFrom, dateTo) / daysOnStockArticleStock(a, stock);
    turnoverArticleStock(a, stock) <- IF quantitySoldArticleStockDateFromTo (a, stock, dateFrom, dateTo) != 0 THEN
                                         cumBalance(a, stock) / quantitySoldArticleStockDateFromTo (a, stock, dateFrom, dateTo)
                                      ELSE
                                        9999.99;
} TOOLBAR;

FORM saleArticle 'Продажи по артикулам'

    OBJECTS dates = (dFrom = DATE, dTo = DATE) FIXED PANEL
    PROPERTIES valFrom = OBJVALUE(dFrom), valTo = OBJVALUE(dTo)
       
    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType    
    
    
    TREE skuTree sk = Group PARENT parentGroup
    PROPERTIES READONLY skuTreeName = nameGroup(sk)
    ORDER BY skuTreeName
    FILTERS groupTypeGroup(sk) == gt
    FILTERGROUP inactive FILTER 'Активные' 'F5' activeGroup(sk) DEFAULT       
     
    OBJECTS ts = Stock
    PROPERTIES tsTreeName = nameStock(ts) READONLY, nameLegalEntityStock(ts) READONLY, inArticleReportStock(ts)
    ORDER BY tsTreeName
    FILTERS isCompanyStock(ts)     
      
    OBJECTS st = Stock      
    FILTERS isCompanyStock(st),
            inArticleReportStock(st)
    OBJECTS ar = Article 
    PROPERTIES(ar) READONLY idArticle, captionArticle,
                   nameSkuGroup3Article, nameSkuGroup4Article, imageArticle FORCE PANEL
    PROPERTIES     READONLY balanceBArticleStockDate(ar,st,dFrom)  COLUMNS (st) HEADER nameArticleBalanceBStock(st)
    PROPERTIES     READONLY sumBArticleStockDate(ar,st,dFrom)  COLUMNS (st) HEADER nameArticleSumBStock(st)
    PROPERTIES     READONLY quantitySoldArticleStockDateFromTo(ar,st,dFrom,dTo)  COLUMNS (st) HEADER nameArticleQuantitySoldStock(st)
    PROPERTIES     READONLY sumSoldArticleStockDateFromTo(ar,st,dFrom,dTo)  COLUMNS (st) HEADER nameArticleSumSoldStock(st)
    PROPERTIES     READONLY balanceAArticleStockDate(ar,st,dTo)  COLUMNS (st) HEADER nameArticleBalanceAStock(st)
    PROPERTIES     READONLY sumAArticleStockDate(ar,st,dTo)  COLUMNS (st) HEADER nameArticleSumAStock(st)    

    PROPERTIES     READONLY daysOnStockArticleStock(ar, st) COLUMNS (st) HEADER nameArticleDaysOnStockStock(st) 
    PROPERTIES     READONLY averageReportSoldArticleStock(ar, st) COLUMNS (st) HEADER nameArticleAverageReportSoldStock(st) 
    PROPERTIES     READONLY turnoverArticleStock(ar, st) COLUMNS (st) HEADER nameArticleTurnoverStock(st) 
    PROPERTIES(dFrom, dTo) calcSaleArticleParamsInterval FORCE PANEL TODRAW ar
                
    FILTERS           isParentGroupArticle(sk, ar)                
                            
    FILTERGROUP filtersSold
        FILTER 'С движением' 'F11' filterSoldArticleDateFromTo(ar,dFrom,dTo) OR filterBalanceArticleDateFromTo(ar,dFrom,dTo) DEFAULT
        FILTER 'С продажей' 'F10' filterSoldArticleDateFromTo(ar,dFrom,dTo)
        FILTER 'С остатком' 'F9' filterBalanceArticleDateFromTo(ar,dFrom,dTo)                           
;


DESIGN saleArticle FROM DEFAULT {
    NEW top {
        type = CONTAINERH;
        ADD dates.box {
            type = CONTAINERH;
        }
        ADD gt.box;
    }
    REMOVE st.box;
    NEW article {
        type = SPLITH;
        fill = 1;
        NEW skuFilters {
            fill = 1;
            type = SPLITV;
            NEW column{
                fill = 1.5;
                type = SPLITV;
                ADD ts.box;
                ADD skuTree.tree.box { caption = 'Группы SKU'; }
            }    
            NEW imageBox {
                fill = 1;
                caption = 'Изображение';                     
                ADD PROPERTY(imageArticle) {                           
                    caption = '';
                    fill = 1;
                }
            }
        }
        ADD ar.box {
            fill = 2.5;
        }    
    } 
    ADD functions.box;
    PROPERTY(balanceBArticleStockDate) { background = #FFEEEE; }
    PROPERTY(sumBArticleStockDate) { background = #FFEEEE; }
    PROPERTY(quantitySoldArticleStockDateFromTo) { background = #CCFFCC; }
    PROPERTY(sumSoldArticleStockDateFromTo) { background = #CCFFCC; }    
    PROPERTY(balanceAArticleStockDate) { background = #BDE3FF; }
    PROPERTY(sumAArticleStockDate) { background = #BDE3FF; }
}

NAVIGATOR {                                              
    salesReports{
        ADD saleArticle;
    }
}
