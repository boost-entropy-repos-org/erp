MODULE SaleReports;

REQUIRE SaleLedger;

//отчет по продажам

dataInSessionGroup 'Отм.' = DATA SESSION BOOLEAN (Group);

levelParentGroup (group) = GROUP MIN levelGroupGroup(group, parent) IF dataInSessionGroup(parent)
    BY group;

inParentGroup (group) = TRUE IF levelParentGroup(group);

inSessionGroup 'Отм.' (group) = OVERRIDE
    inParentGroup(group),
    dataInSessionGroup(group);

sessionConcatGroups 'Группы' (groupType) =
    GROUP CONCAT nameGroup(group) IF inSessionGroup(group) AND NOT inSessionGroup(parentGroup(group)),','
    BY groupTypeGroup(group);

//суммы продаж по группе
costSumSalesGroupStockDateDate 'Себестоимость продаж (по группе)' (group, stock, dateFrom, dateTo) =
    GROUP SUM costSumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY groupGroupTypeSku(groupType, skuSaleLedger(saleLedger)), stockSaleLedger(saleLedger), dateFrom, dateTo;
markupSumSalesGroupStockDateDate 'Надбавка (по группе)'(group, stock, dateFrom, dateTo) =
    GROUP SUM markupSumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY groupGroupTypeSku(groupType, skuSaleLedger(saleLedger)), stockSaleLedger(saleLedger), dateFrom, dateTo;
sumVATSalesGroupStockDateDate 'Сумма НДС (по группе)'(group, stock, dateFrom, dateTo) =
    GROUP SUM sumVATSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                              dateSaleLedger(saleLedger) >= dateFrom AND
                                              dateSaleLedger(saleLedger) <= dateTo
    BY groupGroupTypeSku(groupType, skuSaleLedger(saleLedger)), stockSaleLedger(saleLedger), dateFrom, dateTo;
sumSalesSkuGroupStockDateDate 'Сумма продаж (по группе)' (group, stock, dateFrom, dateTo) =
    GROUP SUM sumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                           dateSaleLedger(saleLedger) >= dateFrom AND
                                           dateSaleLedger(saleLedger) <= dateTo
    BY groupGroupTypeSku(groupType, skuSaleLedger(saleLedger)), stockSaleLedger(saleLedger), dateFrom, dateTo;
    
//суммы продаж всего
costRecSumSalesGroupStockDateDate 'Себестоимость продаж (всего)' (group, stock, dateFrom, dateTo) =
    GROUP SUM costSumSaleLedger(saleLedger) IF isParentGroupSku(group, skuSaleLedger(saleLedger)) AND
                                               activeSaleLedger(saleLedger) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY group, stockSaleLedger(saleLedger), dateFrom, dateTo;
markupRecSumSalesGroupStockDateDate 'Надбавка (всего)'(group, stock, dateFrom, dateTo) =
    GROUP SUM markupSumSaleLedger(saleLedger) IF isParentGroupSku(group, skuSaleLedger(saleLedger)) AND
                                                 activeSaleLedger(saleLedger) AND
                                                 dateSaleLedger(saleLedger) >= dateFrom AND
                                                 dateSaleLedger(saleLedger) <= dateTo
    BY group, stockSaleLedger(saleLedger), dateFrom, dateTo;
sumVATRecSalesGroupStockDateDate 'Сумма НДС (всего)'(group, stock, dateFrom, dateTo) =
    GROUP SUM sumVATSaleLedger(saleLedger) IF isParentGroupSku(group, skuSaleLedger(saleLedger)) AND
                                              activeSaleLedger(saleLedger) AND
                                              dateSaleLedger(saleLedger) >= dateFrom AND
                                              dateSaleLedger(saleLedger) <= dateTo
    BY group, stockSaleLedger(saleLedger), dateFrom, dateTo;  
sumRecSalesSkuGroupStockDateDate 'Сумма продаж (всего)' (group, stock, dateFrom, dateTo) =
    GROUP SUM sumSaleLedger(saleLedger) IF isParentGroupSku(group, skuSaleLedger(saleLedger)) AND
                                           activeSaleLedger(saleLedger) AND
                                           dateSaleLedger(saleLedger) >= dateFrom AND
                                           dateSaleLedger(saleLedger) <= dateTo
    BY group, stockSaleLedger(saleLedger), dateFrom, dateTo;

//суммы продаж по покупателю
costSumSalesGroupTypeCustomerStockDateDate 'Себестоимость продаж (по покупателю)' (groupType, customer, stock, dateFrom, dateTo) =
    GROUP SUM costSumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                               inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY groupType, customerSaleLedger(saleLedger), stockSaleLedger(saleLedger), dateFrom, dateTo;
markupSumSalesGroupTypeCustomerStockDateDate 'Надбавка (по покупателю)'(groupType, customer, stock, dateFrom, dateTo) =
    GROUP SUM markupSumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                               inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY groupType, customerSaleLedger(saleLedger), stockSaleLedger(saleLedger), dateFrom, dateTo;
sumVATSalesGroupTypeCustomerStockDateDate 'Сумма НДС (по покупателю)'(groupType, customer, stock, dateFrom, dateTo) =
    GROUP SUM sumVATSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                              inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                              dateSaleLedger(saleLedger) >= dateFrom AND
                                              dateSaleLedger(saleLedger) <= dateTo
    BY groupType, customerSaleLedger(saleLedger), stockSaleLedger(saleLedger), dateFrom, dateTo;
sumSalesGroupTypeCustomerStockDateDate 'Сумма продаж (по покупателю)' (groupType, customer, stock, dateFrom, dateTo) =
    GROUP SUM sumSaleLedger(saleLedger) IF activeSaleLedger(saleLedger) AND
                                           inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                           dateSaleLedger(saleLedger) >= dateFrom AND
                                           dateSaleLedger(saleLedger) <= dateTo
    BY groupType, customerSaleLedger(saleLedger), stockSaleLedger(saleLedger), dateFrom, dateTo;

//суммы продаж по SKU



//итоговые суммы продаж
costSumSalesGroupTypeStockDateDate 'Итоговая себестоимость продаж' (groupType, stock, dateFrom, dateTo) =
    GROUP SUM costSumSaleLedger(saleLedger) IF inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                               activeSaleLedger(saleLedger) AND
                                               dateSaleLedger(saleLedger) >= dateFrom AND
                                               dateSaleLedger(saleLedger) <= dateTo
    BY groupType, stockSaleLedger(saleLedger), dateFrom, dateTo PREFCHARWIDTH 15;
markupSumSalesGroupTypeStockDateDate 'Итоговая надбавка продаж' (groupType, stock, dateFrom, dateTo) =
    GROUP SUM markupSumSaleLedger(saleLedger) IF inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                                 activeSaleLedger(saleLedger) AND
                                                 dateSaleLedger(saleLedger) >= dateFrom AND
                                                 dateSaleLedger(saleLedger) <= dateTo
    BY groupType, stockSaleLedger(saleLedger), dateFrom, dateTo PREFCHARWIDTH 15;
sumVATSalesGroupTypeStockDateDate 'Итоговая сумма НДС продаж' (groupType, stock, dateFrom, dateTo) =
    GROUP SUM sumVATSaleLedger(saleLedger) IF inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                              activeSaleLedger(saleLedger) AND
                                              dateSaleLedger(saleLedger) >= dateFrom AND
                                              dateSaleLedger(saleLedger) <= dateTo
    BY groupType, stockSaleLedger(saleLedger), dateFrom, dateTo PREFCHARWIDTH 15;
sumSalesGroupTypeStockDateDate 'Итоговая сумма продаж' (groupType, stock, dateFrom, dateTo) =
    GROUP SUM sumSaleLedger(saleLedger) IF inSessionGroup(groupGroupTypeSku(groupType, skuSaleLedger(saleLedger))) AND
                                           activeSaleLedger(saleLedger) AND
                                           dateSaleLedger(saleLedger) >= dateFrom AND
                                           dateSaleLedger(saleLedger) <= dateTo
    BY groupType, stockSaleLedger(saleLedger), dateFrom, dateTo PREFCHARWIDTH 15;

//формы
FORM printListSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS s = SaleLedger
    PROPERTIES(s) READONLY dateTimeSaleLedger, nameCustomerSaleLedger, nameSkuSaleLedger, descriptionSaleLedger,
                           quantitySaleLedger, costSumSaleLedger, markupSumSaleLedger, sumVATSaleLedger, sumSaleLedger, averagePriceSaleLedger
    ORDER BY nameSkuSaleLedger(s)
    FILTERS activeSaleLedger(s),
            stockSaleLedger(s) == st,
            dateSaleLedger(s) >= df,
            dateSaleLedger(s) <= dt,
            inSessionGroup(groupGroupTypeSku(gt, skuSaleLedger(s)))
;

printListSalesReport 'Списком' (stock, dateFrom, dateTo) =
    ACTION FORM printListSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printListSkuSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS s = Sku
    PROPERTIES(s) READONLY nameSku
    PROPERTIES(s, st, df, dt) READONLY quantitySoldSkuStockDateFromTo, costSumSoldSkuStockDateFromTo, markupSumSoldSkuStockDateFromTo,
                                       sumVATSoldSkuStockDateFromTo, sumSoldSkuStockDateFromTo
    ORDER BY nameSku(s)
    FILTERS inSessionGroup(groupGroupTypeSku(gt, s)),
            quantitySoldSkuStockDateFromTo(s, st, df, dt) OR costSumSoldSkuStockDateFromTo(s, st, df, dt) OR
            markupSumSoldSkuStockDateFromTo(s, st, df, dt) OR sumVATSoldSkuStockDateFromTo(s, st, df, dt) OR
            sumSoldSkuStockDateFromTo(s, st, df, dt)
;

printListSkuSalesReport 'Списком(по товарам)' (stock, dateFrom, dateTo) =
    ACTION FORM printListSkuSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup(sk)
    PROPERTIES(sk, st, df, dt) READONLY costSumSalesGroupStockDateDate, markupSumSalesGroupStockDateDate, sumVATSalesGroupStockDateDate, sumSalesSkuGroupStockDateDate
    FILTERS inSessionGroup(sk) AND countSkuGroupGroupType(sk, gt),
            groupTypeGroup(sk) == gt
    FILTERGROUP inactive FILTER 'Активные' activeGroup(sk) 'F5' DEFAULT

    OBJECTS s = SaleLedger
    PROPERTIES(s) READONLY dateTimeSaleLedger, nameCustomerSaleLedger, nameSkuSaleLedger, descriptionSaleLedger,
                           quantitySaleLedger, costSumSaleLedger, markupSumSaleLedger, sumVATSaleLedger, sumSaleLedger, averagePriceSaleLedger
    ORDER BY nameSkuSaleLedger(s)
    FILTERS activeSaleLedger(s),
            stockSaleLedger(s) == st,
            dateSaleLedger(s) >= df,
            dateSaleLedger(s) <= dt,
            groupGroupTypeSku(gt, skuSaleLedger(s)) == sk
;

printSalesReport 'По группам' (stock, dateFrom, dateTo) =
    ACTION FORM printSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printSkuSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup(sk)
    PROPERTIES(sk, st, df, dt) READONLY costSumSalesGroupStockDateDate, markupSumSalesGroupStockDateDate, sumVATSalesGroupStockDateDate, sumSalesSkuGroupStockDateDate
    FILTERS inSessionGroup(sk) AND countSkuGroupGroupType(sk, gt),
            groupTypeGroup(sk) == gt
    FILTERGROUP inactive FILTER 'Активные' activeGroup(sk) 'F5' DEFAULT

    OBJECTS s = Sku
    PROPERTIES(s) READONLY nameSku
    PROPERTIES(s, st, df, dt) READONLY quantitySoldSkuStockDateFromTo, costSumSoldSkuStockDateFromTo, markupSumSoldSkuStockDateFromTo,
                                       sumVATSoldSkuStockDateFromTo, sumSoldSkuStockDateFromTo
    ORDER BY nameSku(s)
    FILTERS groupGroupTypeSku(gt, s) == sk,
            quantitySoldSkuStockDateFromTo(s, st, df, dt) OR costSumSoldSkuStockDateFromTo(s, st, df, dt) OR
            markupSumSoldSkuStockDateFromTo(s, st, df, dt) OR sumVATSoldSkuStockDateFromTo(s, st, df, dt) OR
            sumSoldSkuStockDateFromTo(s, st, df, dt)
;

printSkuSalesReport 'По товарам(группы)' (stock, dateFrom, dateTo) =
    ACTION FORM printSkuSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printGroupSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS sk = Group
    PROPERTIES READONLY canonicalNameGroup(sk)
    ORDER BY canonicalNameGroup(sk)
    PROPERTIES(sk, st, df, dt) READONLY costSumSalesGroupStockDateDate, markupSumSalesGroupStockDateDate, sumVATSalesGroupStockDateDate, sumSalesSkuGroupStockDateDate
    FILTERS inSessionGroup(sk) AND countSkuGroupGroupType(sk, gt),
            groupTypeGroup(sk) == gt,
            costSumSalesGroupStockDateDate(sk, st, df, dt) OR markupSumSalesGroupStockDateDate(sk, st, df, dt) OR
            sumVATSalesGroupStockDateDate(sk, st, df, dt) OR sumSalesSkuGroupStockDateDate(sk, st, df, dt)
    FILTERGROUP inactive FILTER 'Активные' activeGroup(sk) 'F5' DEFAULT
;

printGroupSalesReport 'По группам' (stock, dateFrom, dateTo) =
    ACTION FORM printGroupSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printGroupCustomerSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS l = LegalEntity
    PROPERTIES READONLY nameLegalEntity(l)
    ORDER BY nameLegalEntity(l)
    PROPERTIES(gt, l, st, df, dt) READONLY costSumSalesGroupTypeCustomerStockDateDate, markupSumSalesGroupTypeCustomerStockDateDate,
                                           sumVATSalesGroupTypeCustomerStockDateDate, sumSalesGroupTypeCustomerStockDateDate
    FILTERS isBuyerLegalEntity(l)
    FILTERGROUP inactiveLegalEntity FILTER 'Активная' activeLegalEntity(l) 'shift F10' DEFAULT
    OBJECTS s = SaleLedger
    PROPERTIES(s) READONLY dateTimeSaleLedger, nameCustomerSaleLedger, nameSkuSaleLedger, descriptionSaleLedger,
                           quantitySaleLedger, costSumSaleLedger, markupSumSaleLedger, sumVATSaleLedger, sumSaleLedger, averagePriceSaleLedger
    ORDER BY nameSkuSaleLedger(s)
    FILTERS activeSaleLedger(s),
            inSessionGroup(groupGroupTypeSku(gt, skuSaleLedger(s))),
            stockSaleLedger(s) == st,
            dateSaleLedger(s) >= df,
            dateSaleLedger(s) <= dt,
            customerSaleLedger(s) == l
;

printGroupCustomerSalesReport 'По покупателям' (stock, dateFrom, dateTo) =
    ACTION FORM printGroupCustomerSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printGroupCustomerSkuSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS l = LegalEntity
    PROPERTIES READONLY nameLegalEntity(l)
    ORDER BY nameLegalEntity(l)
    PROPERTIES(gt, l, st, df, dt) READONLY costSumSalesGroupTypeCustomerStockDateDate, markupSumSalesGroupTypeCustomerStockDateDate,
                                           sumVATSalesGroupTypeCustomerStockDateDate, sumSalesGroupTypeCustomerStockDateDate
    FILTERS isBuyerLegalEntity(l)
    FILTERGROUP inactiveLegalEntity FILTER 'Активная' activeLegalEntity(l) 'shift F10' DEFAULT
    OBJECTS s = Sku
    PROPERTIES(s) READONLY nameSku
    PROPERTIES(s, st, l, df, dt) READONLY quantitySoldSkuStockCustomerDateFromTo, costSumSoldSkuStockCustomerDateFromTo, markupSumSoldSkuStockCustomerDateFromTo,
                                          sumVATSoldSkuStockCustomerDateFromTo, sumSoldSkuStockCustomerDateFromTo
    ORDER BY nameSku(s)
    FILTERS inSessionGroup(groupGroupTypeSku(gt, s)),
            quantitySoldSkuStockCustomerDateFromTo(s, st, l, df, dt) OR costSumSoldSkuStockCustomerDateFromTo(s, st, l, df, dt) OR
            markupSumSoldSkuStockCustomerDateFromTo(s, st, l, df, dt) OR sumVATSoldSkuStockCustomerDateFromTo(s, st, l, df, dt) OR
            sumSoldSkuStockCustomerDateFromTo(s, st, l, df, dt)
;

printGroupCustomerSkuSalesReport 'По товарам(покупатели)' (stock, dateFrom, dateTo) =
    ACTION FORM printGroupCustomerSkuSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM printCustomerSalesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR fullNameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY costSumSalesGroupTypeStockDateDate, markupSumSalesGroupTypeStockDateDate,
                                        sumVATSalesGroupTypeStockDateDate, sumSalesGroupTypeStockDateDate
    PROPERTIES(gt) READONLY sessionConcatGroups

    OBJECTS l = LegalEntity
    PROPERTIES READONLY nameLegalEntity(l)
    ORDER BY nameLegalEntity(l)
    PROPERTIES(gt, l, st, df, dt) READONLY costSumSalesGroupTypeCustomerStockDateDate, markupSumSalesGroupTypeCustomerStockDateDate,
                                           sumVATSalesGroupTypeCustomerStockDateDate, sumSalesGroupTypeCustomerStockDateDate
    FILTERS isBuyerLegalEntity(l),
            costSumSalesGroupTypeCustomerStockDateDate(gt, l, st, df, dt) OR markupSumSalesGroupTypeCustomerStockDateDate(gt, l, st, df, dt) OR
            sumVATSalesGroupTypeCustomerStockDateDate(gt, l, st, df, dt) OR sumSalesGroupTypeCustomerStockDateDate(gt, l, st, df, dt)
    FILTERGROUP inactiveLegalEntity FILTER 'Активная' activeLegalEntity(l) 'shift F10' DEFAULT        
;

printCustomerSalesReport 'По покупателям' (stock, dateFrom, dateTo) =
    ACTION FORM printCustomerSalesReport OBJECTS st = stock, df = dateFrom, dt = dateTo PRINT  IMAGE 'print.png' IN print;

FORM salesReport 'Отчет по продажам'
    OBJECTS df=DATE FIXED PANEL
    PROPERTIES dateFrom = OBJVALUE(df)

    OBJECTS dt=DATE FIXED PANEL
    PROPERTIES dateTo = OBJVALUE(dt)

    OBJECTS st = Stock FIXED PANEL
    PROPERTIES(st) SELECTOR nameStock
    FILTERS isCompanyStock(st)

    OBJECTS gt = GroupType FIXED PANEL
    PROPERTIES(gt) SELECTOR nameGroupType
    PROPERTIES(gt, st, df, dt) READONLY sumSalesGroupTypeStockDateDate
//    PROPERTIES(gt) READONLY sessionConcatGroups

    TREE skuTree sk = Group PARENT parentGroup
    PROPERTIES inSessionGroup(sk)
    PROPERTIES READONLY orderGroup(sk), skuTreeName = nameGroup(sk)
    PROPERTIES(sk, st, df, dt) READONLY costRecSumSalesGroupStockDateDate, markupRecSumSalesGroupStockDateDate, 
                                        sumVATRecSalesGroupStockDateDate, sumRecSalesSkuGroupStockDateDate
    ORDER BY orderGroup(sk), skuTreeName
    FILTERS groupTypeGroup(sk) == gt
    FILTERGROUP inactive FILTER 'Активные' activeGroup(sk) 'F5' DEFAULT

    OBJECTS s = SaleLedger
    PROPERTIES(s) READONLY dateTimeSaleLedger, nameCustomerSaleLedger, nameSkuSaleLedger, descriptionSaleLedger,
                           quantitySaleLedger, costSumSaleLedger, markupSumSaleLedger, sumVATSaleLedger, sumSaleLedger, averagePriceSaleLedger
    ORDER BY nameSkuSaleLedger(s)
    FILTERS isParentGroupSku(sk, skuSaleLedger(s)),
            activeSaleLedger(s),
            stockSaleLedger(s) == st,
            dateSaleLedger(s) >= df,
            dateSaleLedger(s) <= dt
    PROPERTIES(st, df, dt) printListSalesReport, printListSkuSalesReport, printSalesReport, printSkuSalesReport, printGroupSalesReport,
                           printGroupCustomerSalesReport, printGroupCustomerSkuSalesReport, printCustomerSalesReport
;

DESIGN salesReport FROM DEFAULT{
    NEW top {
        type = CONTAINERH;
        NEW dateContainer{
            caption = 'Период';
            type = CONTAINERH;
            ADD PROPERTY(dateFrom){caption = 'Дата (с)';}
            ADD PROPERTY(dateTo){caption = 'Дата (по)';}
        }
        ADD st.box;
        ADD gt.box;
        NEW sumContainer{
            caption = 'Итоговые суммы';
            type = CONTAINERH;
            ADD PROPERTY(sumSalesGroupTypeStockDateDate(gt,st,df,dt));
        }
    }

    NEW center {
        fill = 1;
        type = SPLITH;

        ADD skuTree.tree.box;
        NEW tabContainer {
            fill = 1;
            type = TABBED;
            NEW salesContainer {
                type = CONTAINERV;
                caption = 'Продажи';

                NEW rowSalesContainer{
                    type = CONTAINERH;
                    NEW firstColumnSalesContainer{
                        caption = 'С детализацией';
                        type = COLUMNS;
                        columns = 2;
                        ADD PROPERTY(printSalesReport(st,df,dt));
                        ADD PROPERTY(printSkuSalesReport(st,df,dt));
                        ADD PROPERTY(printGroupCustomerSalesReport(st,df,dt));
                        ADD PROPERTY(printGroupCustomerSkuSalesReport(st,df,dt));
                    }
                    NEW secondColumnSalesContainer{
                        caption = 'Без детализации';
                        type = CONTAINERV;
                        ADD PROPERTY(printGroupSalesReport(st,df,dt));
                        ADD PROPERTY(printCustomerSalesReport(st,df,dt));
                    }
                    NEW thirdColumnSalesContainer{
                        caption = 'Список';
                        type = CONTAINERV;
                        ADD PROPERTY(printListSalesReport(st,df,dt));
                        ADD PROPERTY(printListSkuSalesReport(st,df,dt));
                    }
                }
                ADD s.box;
            }
        }
    }
    ADD functions.box;
}

NAVIGATOR {
    salesReports {
        ADD salesReport;
    }
}