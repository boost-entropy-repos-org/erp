MODULE SaleInternetOrderDelivery;

REQUIRE SaleInternetPicking, Label;

NAMESPACE Sale;
// Отчет курьера

CLASS DeliveryReport 'Отчет курьера';
TABLE deliveryReport(DeliveryReport);

@defineDocumentHeaderTimePrefix(DeliveryReport, , '');

@deriveDocumentHeaderTimePrefix(DeliveryReport, );
@defineCreated(DeliveryReport);
@deriveDocumentHeaderTimePrefix(DeliveryReport, );

@defineDocumentHeaderNumber(DeliveryReport);

@defineNumeratedDefault(DeliveryReport, 'Отчет курьера', 'ОК');

deliveryReport = DATA DeliveryReport (InternetOrderDetail) INDEXED;
in 'Вкл' (DeliveryReport o, InternetOrderDetail d) = deliveryReport(d) == o;

@defineDocumentHeaderCount(deliveryReport, InternetOrderDetail);

relation = GROUP BY DeliveryReport o, internetOrder(InternetOrderDetail d) SUM 1 IF in(o, d);

seriesNumberInternetOrders 'Интернет-заказы' (deliveryReport) = GROUP
                                                 BY DeliveryReport deliveryReport CONCAT seriesNumber(InternetOrder order) IF relation(deliveryReport, order) , ', '
                                                 ORDER order  CHARWIDTH 30;   

dataDeliveryReportIndex 'Номер строки' = DATA INTEGER (InternetOrderDetail) INDEXED; 
defaultDeliveryReportIndex 'Номер строки (авт.)' (InternetOrderDetail d) =
    PARTITION SUM 1 BY deliveryReport(d)
    ORDER internetOrder(d),d CHARWIDTH 4;
indexDeliveryReport 'Номер строки' (InternetOrderDetail d) = OVERRIDE dataDeliveryReportIndex(d), defaultDeliveryReportIndex(d) IN recognize;

pickingQuantityInternetOrderDetail 'Кол-во (всего) собрано' = GROUP 
    BY deliveryReport(InternetOrderDetail d) SUM pickingQuantity(d) IN documentSum;

pickingSumInternetOrderDetail'Сумма (всего) собрано' = GROUP 
    BY deliveryReport(InternetOrderDetail d) SUM pickingSum(d) IN documentSum;

// Возврат
returnQuantity 'Возвращено' = DATA NUMERIC[16,5](InternetOrderDetail);
returnQuantityInternetOrderDetail'Кол-во (всего) возвращено' = GROUP 
    BY deliveryReport(InternetOrderDetail d) SUM returnQuantity(d) IN documentSum;


CLASS StatusDeliveryReport 'Статус' {
    collected 'Собран',
    delivery 'Доставка',
    delivered 'Доставлен',
    completed 'Завершен'
}    
    
FORM statusDeliveryReport 'Статус'
    OBJECTS o = StatusDeliveryReport
    PROPERTIES(o) READONLY staticCaption
    
    LIST StatusDeliveryReport OBJECT o 
;       
    
status = DATA StatusDeliveryReport (DeliveryReport);
nameStatus 'Статус' (DeliveryReport c) = staticCaption(status(c)) IN documentPrm;

status(DeliveryReport r) <- StatusDeliveryReport.collected WHEN SET(r IS DeliveryReport);    

seriesNumberPicking 'Номер комплектации' (InternetOrderDetail d) = seriesNumber(picking(d)) CHARWIDTH 10;



countInternetOrderDetail 'Кол-во строк товара в документе'  = 
    GROUP
          BY  sku(InternetOrderDetail idetail),
              deliveryReport(idetail) SUM 1 IF sku(idetail);   
editReturnQuantity  = ABSTRACT BOOLEAN (InternetOrderDetail);

FORM deliveryReport 'Отчет курьера'
    OBJECTS r = DeliveryReport PANEL
    PROPERTIES(r) nameStatus, nameNumerator, number, series, date, time, countInternetOrderDetail, pickingQuantityInternetOrderDetail, pickingSumInternetOrderDetail
    
    OBJECTS o = InternetOrder
    FILTERS relation(r,o)
    PROPERTIES (o) READONLY isClosed, isPosted, nameStatus, number, series, date, time

    PROPERTIES (o) READONLY nameCurrency, nameCarrier, nameInternetCustomer, addressInternetCustomer, phoneInternetCustomer
    PROPERTIES (o) READONLY countInternetOrderDetail, quantityInternetOrderDetail, sumInternetOrderDetail,
                            note
    PROPERTIES (o) deliveryDate, namePaymentTypeInternetOrder, paymentCashSumInternetOrder, paymentCardSumInternetOrder, paymentERIPSumInternetOrder, paymentDateInternetOrder,
                            numberPaymentDocumentInternetOrder, deliverySumInternetOrder, deliveryTimeFromInternetOrder, deliveryTimeToInternetOrder   
         
    OBJECTS d = InternetOrderDetail
    PROPERTIES in(r, d)
    PROPERTIES(d) indexDeliveryReport
    PROPERTIES (d) READONLY seriesNumberPicking, idBarcodeSku, idSku, nameSku, shortNameUOMSku
    PROPERTIES (d) READONLY idBatch, nameBatch, pickingQuantity
    PROPERTIES (d) returnQuantity READONLYIF editReturnQuantity(d)
    PROPERTIES (d) READONLY price, discountPrice, pickingSum, nameSupplierStock, seriesNumber, date, time, nameInternetCustomer, addressInternetCustomer, phoneInternetCustomer
    FILTERS deliveryReport(d) == r                                                    
    ORDER indexDeliveryReport(d)  
    FILTERGROUP filters1 FILTER 'По заказу' internetOrder(d)<=o 'F10'  
            
    EDIT DeliveryReport OBJECT r     
;

DESIGN deliveryReport {

    BOX {
        size = (1024, 768);
        OBJECTS {
            NEW specificationBox{
                fill = 1;
                type = SPLITV;
                
                MOVE BOX(o);
                MOVE BOX(d) {
                    caption = 'Спецификация';
                    fill = 2;
                    PANEL(d) {
                        type = CONTAINERV;
                    }
                }
            }
    
            NEW headerBox BEFORE specificationBox {
                type = CONTAINERH;
    
                NEW headerRow1 {
                    fill = 1;
    
                    MOVE GROUP(documentHeader,r) {
                        type = CONTAINERH;
    
                        MOVE PROPERTY(nameNumerator(r));
                        MOVE PROPERTY(number(r));
                        MOVE PROPERTY(series(r));
                        MOVE PROPERTY(date(r));
                        MOVE PROPERTY(time(r));
                    }
                    MOVE GROUP(documentPrm,r);
                }
                NEW sumContainer {
                    MOVE GROUP(documentSum,r) {
                        columns = 1;
                    }
                }
            }
        }
    }
}

FORM deliveryReports 'Отчеты курьера'
    OBJECTS r = DeliveryReport LAST
    PROPERTIES(r) READONLY nameStatus, date, time, countInternetOrderDetail, pickingQuantityInternetOrderDetail, pickingSumInternetOrderDetail,
                  seriesNumberInternetOrders
    PROPERTIES(r) NEWSESSION NEW, EDIT, DELETE GRID            
    
    OBJECTS d = InternetOrderDetail
    PROPERTIES(d) READONLY indexDeliveryReport, seriesNumberPicking
    PROPERTIES (d) READONLY BACKGROUND background(d) idBarcodeSku, idSku, nameSku, shortNameUOMSku
    PROPERTIES (d) READONLY BACKGROUND background(d) pickingQuantity, price, discountPrice, pickingSum, 
                                                     nameSupplierStock
    FILTERS deliveryReport(d) == r      
    ORDER indexDeliveryReport(d)
;

carrier = DATA Carrier (DeliveryReport); 
nameCarrier 'Перевозчик' (DeliveryReport r) = name(carrier(r));

createDeliveryReport 'Создать отчет курьера' (InternetOrder order) = {
    IF NOT countInternetOrders() THEN {
        select(order) <- TRUE;
    } 
    IF countInternetOrders() THEN  {       
    
        NEWSESSION {
            FOR [=GROUP BY Sale.supplierStock[InternetOrderDetail](InternetOrderDetail d), carrier(internetOrder(d)) SUM 1 IF select(internetOrder(d)) AND NOT deliveryReport(d)](Stock stock, Carrier carrier) NEW r = DeliveryReport DO {
                carrier(r) <- carrier;
                FOR Sale.supplierStock[InternetOrderDetail](InternetOrderDetail detail) == stock AND carrier(internetOrder(detail)) == carrier AND select(internetOrder(detail)) AND NOT deliveryReport(detail) DO {
                    deliveryReport(detail) <- r;                        
                }
                SHOW deliveryReport OBJECTS r = r DOCKED NOCANCEL;
            }
        }        
        select(InternetOrder o) <- NULL;
    } ELSE {
        MESSAGE 'Вначале необходимо отметить интернет заказы.';
    }
}


filterDashboardDelivery = GROUP 
        BY internetOrder(InternetOrderDetail detail) SUM 1 IF detail IS InternetOrderDetail AND NOT deliveryReport(detail);


inStockDeliveryReport = GROUP BY Sale.supplierStock[InternetOrderDetail](InternetOrderDetail detail), deliveryReport(detail) SUM 1; 
supplierStocks 'Склады поставщика' = GROUP  
                                                                        BY DeliveryReport deliveryReport CONCAT name(Stock stock) IF inStockDeliveryReport(stock, deliveryReport), ', ' 
                                                                        ORDER name(stock) CHARWIDTH 30;
filterDeliveryDashboard = ABSTRACT CASE BOOLEAN (InternetOrder);
useFilterDeliveryDashboard = ABSTRACT BOOLEAN ();

filterDelivery (InternetOrder o) = IF useFilterDeliveryDashboard() THEN filterDeliveryDashboard(o) ELSE status(o) == StatusInternetOrder.picked;

FORM deliveryDashboard 'Отчеты курьера'
    
    OBJECTS o = InternetOrder 
    PROPERTIES (o) select
    PROPERTIES (o) READONLY isPosted, nameStatus, 
                   nameNumerator, number, series, date, time, nameCurrency, note,
                   deliveryDate, nameInternetCustomer, addressInternetCustomer, phoneInternetCustomer
    PROPERTIES (o) READONLY countInternetOrderDetail, quantityInternetOrderDetail, sumInternetOrderDetail
                  
    PROPERTIES (o) READONLY namePaymentTypeInternetOrder, paymentCashSumInternetOrder, paymentCardSumInternetOrder, paymentERIPSumInternetOrder, paymentDateInternetOrder,
                   numberPaymentDocumentInternetOrder, deliverySumInternetOrder, deliveryTimeFromInternetOrder, deliveryTimeToInternetOrder 
                                                                                                     
    FILTERS filterDashboardDelivery(o),
            filterDelivery(o)
    PROPERTIES createDeliveryReport(o) TOOLBAR           
                   
    OBJECTS d = InternetOrderDetail
    PROPERTIES (d) READONLY index
    PROPERTIES (d) READONLY seriesNumberPicking, idBarcodeSku, idSku, nameSku, shortNameUOMSku, idBatch, nameBatch, quantity, pickingQuantity, returnQuantity,
                   price, discountPrice, sum, nameSupplierStock,
                   seriesNumber, date, time, nameInternetCustomer, addressInternetCustomer, phoneInternetCustomer         
    ORDER index(d)
    FILTERS internetOrder(d) == o 

    OBJECTS r = DeliveryReport LAST
    PROPERTIES(r) READONLY nameStatus, number, series,date, time, nameCarrier, supplierStocks, seriesNumberInternetOrders, countInternetOrderDetail, 
                  pickingQuantityInternetOrderDetail, pickingSumInternetOrderDetail
    PROPERTIES(r) NEWSESSION NEW, EDIT, DELETE  
    PROPERTIES (r) PANEL READONLY createdTime, createdNameUser, createdHostnameComputer  
    
    OBJECTS pd = InternetOrderDetail
    PROPERTIES (pd) READONLY indexDeliveryReport 
    PROPERTIES (pd) READONLY seriesNumberPicking, idBarcodeSku, idSku, nameSku, shortNameUOMSku, idBatch, nameBatch
    PROPERTIES (pd) READONLY pickingQuantity, returnQuantity, price, pickingSum, discountPrice, discountSumPicking
    PROPERTIES (pd) READONLY seriesNumber, date, time, nameInternetCustomer, addressInternetCustomer, phoneInternetCustomer, nameSupplierStock
    PROPERTIES (pd) NEWSESSION EDIT TOOLBAR           
    ORDER indexDeliveryReport(pd) 
    FILTERS deliveryReport(pd)==r       
    
;

DESIGN deliveryDashboard {
    BOX {
        NEW top {
            fill = 1;
            //MOVE BOX(dt);
            NEW tabContainer{
                fill =1;
                type = TABBED;
                NEW body {
                    caption = 'Отчеты курьера';
                    fill = 1;
                    type = SPLITV;
                    MOVE BOX(o);
                    NEW specification {
                        type = TABBED ;
                        fill = 2;
                        NEW specPick{
                            caption = 'Отчеты курьера';
                            fill = 1;
                            type = SPLITH;
                            MOVE BOX(r);
                            NEW tab {
                                fill = 1;
                                type = TABBED ;
                                MOVE BOX(pd);
                            }
                        }
                        MOVE BOX(d){ caption ='Спецификация интернет заказа';}
                    }
                }                          
            }
        }
        MOVE TOOLBARBOX;
    }    
}

NAVIGATOR {
    eShop {
        NEW deliveryDashboard;
    }
}

filterInternetOrderDateFrom 'Дата с' = DATA LOCAL DATE ();
filterInternetOrderDateFrom (InternetOrderDetail detail) = date(detail) >= filterInternetOrderDateFrom() OR (detail IS InternetOrderDetail AND NOT filterInternetOrderDateFrom());      

filterInternetOrderDateTo 'Дата по' = DATA LOCAL DATE ();
filterInternetOrderDateTo (InternetOrderDetail detail) = date(detail) <= filterInternetOrderDateTo() OR (detail IS InternetOrderDetail AND NOT filterInternetOrderDateTo());    

FORM internetOrderLedger 'Регистр интернет заказов'
    PROPERTIES filterInternetOrderDateFrom(), filterInternetOrderDateTo()
    OBJECTS d = InternetOrderDetail
    PROPERTIES(d) READONLY   indexDeliveryReport, seriesNumber, nameInternetCustomer, 
                             phoneInternetCustomer, addressInternetCustomer, cityInternetCustomer, 
                             seriesNumberPicking, idBarcodeSku, idSku, nameSku, shortNameUOMSku, idBatch, nameBatch, quantity, pickingQuantity,
                             returnQuantity, price, discountPrice, sum, discountSum, date, deliveryDate, returnDate, paymentDate, deliveryTimeFromInternetOrder, 
                             deliveryTimeToInternetOrder //bulky, guarantee, 
                             
    ORDER seriesNumber(d) 
    FILTERS deliveryReport(d),
            filterInternetOrderDateFrom(d),
            filterInternetOrderDateTo(d)
;

DESIGN internetOrderLedger {
    NEW topFilters {
        caption = 'Фильтры';
        type = CONTAINERH; 
        MOVE PROPERTY(filterInternetOrderDateFrom());                                               
        MOVE PROPERTY(filterInternetOrderDateTo());                                               
    }   
    MOVE BOX(d){
        PROPERTY(seriesNumber(d)){
            caption = 'Номер интернет заказа';
        }    
        PROPERTY(date(d)){
            caption = 'Дата заказа';
        }     
    }  
    MOVE TOOLBARBOX;
}

NAVIGATOR {
    eShop  {
        NEW internetOrderLedger;
    }
}

WHEN CHANGED (status(DeliveryReport r)) DO {
    IF status(r) == StatusDeliveryReport.delivery THEN {
        status(InternetOrder o) <- StatusInternetOrder.delivery WHERE relation(r, o);
    }

    IF status(r) == StatusDeliveryReport.delivered THEN {
        status(InternetOrder o) <- StatusInternetOrder.delivered WHERE relation(r, o);
    }
}

WHEN CHANGED (status(DeliveryReport r)) DO {
    IF status(r) == StatusDeliveryReport.completed THEN {
        status(InternetOrder o) <- StatusInternetOrder.completed WHERE relation(r, o);
    }
}

internetOrderPickingPrint 'Счет-заказ' (DeliveryReport r) = {
    in(InternetOrder order) <- NULL;
    skip(InternetOrderDetail d) <- NULL;   
     
    full() <- NULL ;   
    in(InternetOrder o) <- TRUE WHERE relation(r, o);    
    skip(InternetOrderDetail d) <- TRUE WHERE NOT pickingQuantity(d) AND in(internetOrder(d));
     
    PRINT internetOrderPrint;
} IMAGE 'print.png' IN print;

EXTEND FORM deliveryDashboard
    PROPERTIES (r) internetOrderPickingPrint TOOLBAR 
;
    
CONSTRAINT deliveryReport(InternetOrderDetail detail) AND NOT picking(detail)
    MESSAGE 'Нельзя удалять комплектацию до удаления отчета курьера или создавать отчет курьера без комплектации';
