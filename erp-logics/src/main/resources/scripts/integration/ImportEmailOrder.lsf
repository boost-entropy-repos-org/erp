MODULE ImportEmailOrder;

REQUIRE System, Email, PurchaseOrder, PurchaseOrderStatus;

importEmailOrderAction 'Загрузить параметры заказов из почты' = CUSTOM 'lsfusion.erp.integration.universal.emailorder.ImportEmailOrderActionProperty' ();

importEmailOrderAccount 'E-mail аккаунт' =  DATA Email.Account();
importEmailOrderNameAccount 'E-mail аккаунт' () = name(importEmailOrderAccount());
importEmailOrderFirstRow 'Начинать со строки' =  DATA INTEGER();
importEmailOrderNumberCell 'Ячейка номера инвойса' =  DATA VARSTRING[10]();
importEmailOrderQuantityColumn 'Колонка количества' =  DATA VARSTRING[10]();

order (seriesNumber) = GROUP BY seriesNumber(Purchase.Order order) AGGR order; 
orderDetail (index, numberOrder) = GROUP 
    BY index(Purchase.OrderDetail orderDetail), seriesNumber(order(orderDetail)) AGGR orderDetail;

importedOrder 'Заказ импортирован' = DATA BOOLEAN (AttachmentEmail);  
notImportedOrder (AttachmentEmail attachmentEmail) = NOT importedOrder (attachmentEmail);

EXTEND FORM mail PROPERTIES(ae) importedOrder BEFORE imported(ae);

EXTEND FORM integrationData
    PROPERTIES() importEmailOrderAction, importEmailOrderNameAccount, importEmailOrderFirstRow, importEmailOrderNumberCell,
                 importEmailOrderQuantityColumn    
;
DESIGN integrationData {
    pane {
        NEW emailorder {
            caption = 'Импорт заказов из почты';
            MOVE PROPERTY(importEmailOrderAction());
            MOVE PROPERTY(importEmailOrderNameAccount());
            MOVE PROPERTY(importEmailOrderFirstRow());
            MOVE PROPERTY(importEmailOrderNumberCell());
            MOVE PROPERTY(importEmailOrderQuantityColumn());
        }
    }
}