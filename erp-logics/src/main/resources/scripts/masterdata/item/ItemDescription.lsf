MODULE ItemDescription;

REQUIRE System, Item;

NAMESPACE Item;

GROUP itemDescription 'Описание' : public;

// Вид
CLASS Type 'Вид товара';
TABLE type(Type);

nameType 'Наименование' = DATA VARISTRING[100](Type);
typeName = GROUP AGGR type BY nameType(type); 

FORM type 'Вид товара'
    OBJECTS t=Type FIXED PANEL
    PROPERTIES(t) nameType
    EDIT Type OBJECT t
;

FORM types 'Виды товара'
    OBJECTS t=Type
    PROPERTIES(t) nameType READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY nameType(t)
    DIALOG Type OBJECT t
;
DESIGN types { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(type, Type, name, 'Вид', itemDescription);
@defineObjectItemAttributeBatch (type, nameType, 'Вид');
@implementItemAttribute(nameType, 'Вид', String, itemType);

@defineItemDefaultValue(type, 'Вид', Type, nameType);
@defineItemFilterValue(type, 'Вид', t);

@defineUniteFilterAttributeItem(type, name, 'вид товара', 'виды товара', item);
@defineItemExtractObjectAttribute(type, nameType, typeName);

// Тип
CLASS Kind 'Тип товара';
TABLE kind(Kind);

nameKind 'Наименование' = DATA VARISTRING[100](Kind);
kindName = GROUP AGGR kind BY nameKind(kind); 

FORM kind 'Тип товара'
    OBJECTS t=Kind FIXED PANEL
    PROPERTIES(t) nameKind
    EDIT Kind OBJECT t
;

FORM kinds 'Типы товара'
    OBJECTS t=Kind
    PROPERTIES(t) nameKind READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY nameKind(t)
    DIALOG Kind OBJECT t
;
DESIGN kinds { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(kind, Kind, name, 'Тип', itemDescription);
@defineObjectItemAttributeBatch (kind, nameKind, 'Тип');
@implementItemAttribute(nameKind, 'Тип', String, itemKind);

@defineItemDefaultValue(kind, 'Тип', Kind, nameKind);
@defineItemFilterValue(kind, 'Тип', t);

@defineUniteFilterAttributeItem(kind, name, 'тип товара', 'типы товара', item);
@defineItemExtractObjectAttribute(kind, nameKind, kindName);

// Сорт
CLASS Sort 'Сорт товара';
TABLE sort(Sort);

nameSort 'Наименование' = DATA VARISTRING[100](Sort);
sortName = GROUP AGGR sort BY nameSort(sort); 

FORM sort 'Сорт товара'
    OBJECTS t=Sort FIXED PANEL
    PROPERTIES(t) nameSort
    EDIT Sort OBJECT t
;

FORM sorts 'Сорта товара'
    OBJECTS t=Sort
    PROPERTIES(t) nameSort READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY nameSort(t)
    DIALOG Sort OBJECT t
;
DESIGN sorts { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(sort, Sort, name, 'Сорт', itemDescription);
@defineObjectItemAttributeBatch (sort, nameSort, 'Сорт');
@implementItemAttribute(nameSort, 'Сорт', String, itemSort);

@defineItemDefaultValue(sort, 'Сорт', Sort, nameSort);
@defineItemFilterValue(sort, 'Сорт', t);

@defineUniteFilterAttributeItem(sort, name, 'сорт товара', 'сорта товара', item);
@defineItemExtractObjectAttribute(sort, nameSort, sortName);

// Форма
CLASS Form 'Форма товара';
TABLE form(Form);

nameForm 'Наименование' = DATA VARISTRING[100](Form);
formName = GROUP AGGR form BY nameForm(form); 

FORM form 'Форма товара'
    OBJECTS t=Form FIXED PANEL
    PROPERTIES(t) nameForm
    EDIT Form OBJECT t
;

FORM forms 'Формы товара'
    OBJECTS t=Form
    PROPERTIES(t) nameForm READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY nameForm(t)
    DIALOG Form OBJECT t
;
DESIGN forms { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(form, Form, name, 'Форма', itemDescription);
@defineObjectItemAttributeBatch (form, nameForm, 'Форма');
@implementItemAttribute(nameForm, 'Форма', String, itemForm);

@defineItemDefaultValue(form, 'Форма', Form, nameForm);
@defineItemFilterValue(form, 'Форма', t);

@defineUniteFilterAttributeItem(form, name, 'форма товара', 'формы товара', item);
@defineItemExtractObjectAttribute(form, nameForm, formName);

// Особенность
CLASS Feature 'Особенность товара';
TABLE feature(Feature);

nameFeature 'Наименование' = DATA VARISTRING[255](Feature);
featureName = GROUP AGGR feature BY nameFeature(feature); 

FORM feature 'Особенность товара'
    OBJECTS t=Feature FIXED PANEL
    PROPERTIES(t) nameFeature
    EDIT Feature OBJECT t
;

FORM features 'Особенности товара'
    OBJECTS t=Feature
    PROPERTIES(t) nameFeature READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY nameFeature(t)
    DIALOG Feature OBJECT t
;
DESIGN features { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(feature, Feature, name, 'Особенность', itemDescription);
@defineObjectItemAttributeBatch (feature, nameFeature, 'Особенность');
@implementItemAttribute(nameFeature, 'Особенность', String, itemFeature);

@defineItemDefaultValue(feature, 'Особенность', Feature, nameFeature);

DESIGN itemGroup {
    PROPERTY (nameFeatureItemGroup(g)) {minimumCharWidth = 20; preferredCharWidth = 40;}
}

@defineItemFilterValue(feature, 'Особенность', t);

@defineUniteFilterAttributeItem(feature, name, 'особенность товара', 'особенности товара', item);
@defineItemExtractObjectAttribute(feature, nameFeature, featureName);

// Упаковка
CLASS PackType 'Упаковка';
TABLE packtype(PackType);

namePackType 'Наименование' = DATA VARISTRING[100](PackType);
packTypeName = GROUP AGGR packType BY namePackType(packType); 

FORM packType 'Упаковка товара'
    OBJECTS t=PackType FIXED PANEL
    PROPERTIES(t) namePackType
    EDIT PackType OBJECT t
;

FORM packTypes 'Упаковки товара'
    OBJECTS t=PackType
    PROPERTIES(t) namePackType READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY namePackType(t)
    DIALOG PackType OBJECT t
;
DESIGN packTypes { main{ preferredSize = (600, 400); } }

@defineObjectItemAttribute(packType, PackType, name, 'Упаковка', itemDescription);
@defineObjectItemAttributeBatch (packType, namePackType, 'Упаковка');
@implementItemAttribute(namePackType, 'Упаковка', String, itemPackType);

@defineItemDefaultValue(packType, 'Упаковка', PackType, namePackType);
@defineItemFilterValue(packType, 'Упаковка', t);

@defineUniteFilterAttributeItem(packType, name, 'упаковка товара', 'упаковки товара', item);
@defineItemExtractObjectAttribute(packType, namePackType, packTypeName);

// Фасовка
CLASS Pack 'Фасовка';
TABLE pack(Pack);

namePack 'Наименование' = DATA VARISTRING[100](Pack);
packName = GROUP AGGR pack BY namePack(pack);

FORM pack 'Фасовка товара'
    OBJECTS t=Pack FIXED PANEL
    PROPERTIES(t) namePack
    EDIT Pack OBJECT t
;

FORM packs 'Фасовки товара'
    OBJECTS t=Pack
    PROPERTIES(t) namePack READONLY, DELETE FORCE PANEL TOOLBAR
    PROPERTIES(t) ADDFORM, EDITFORM
    ORDER BY namePack(t)
    DIALOG Pack OBJECT t
;
DESIGN packs { main{ preferredSize = (600, 400); } }


@defineObjectItemAttribute(pack, Pack, name, 'Фасовка', itemDescription);
@defineObjectItemAttributeBatch (pack, namePack, 'Фасовка');
@implementItemAttribute(namePack, 'Фасовка', String, itemPack);

@defineItemDefaultValue(pack, 'Фасовка', Pack, namePack);
@defineItemFilterValue(pack, 'Фасовка', t);

@defineUniteFilterAttributeItem(pack, name, 'фасовка товара', 'фасовки товара', item);
@defineItemExtractObjectAttribute(pack, namePack, packName);

//-------------------------------------------------------------------//

//FORM packSession 'Добавить'    
//    OBJECTS gg = ItemGroup FIXED PANEL 
//       
//    OBJECTS v = VARISTRING[100] FIXED PANEL    
//    PROPERTIES (v) val = OBJVALUE 
//;
//DESIGN packSession { 
//    main{ 
//        REMOVE gg.box;
//        preferredSize = (600, 400); 
//        ADD v.box {        
//            caption = 'Фасовкa товара';
//            PROPERTY (val) {
//                caption = 'Наименование';
//                panelLabelAbove = TRUE;
////                font = 'bold 24';
//            }
//        }
//        ADD functions.box;
//    }
//}

//FORM packsSession 'Фасовки товара'
//    OBJECTS gg = ItemGroup FIXED PANEL
//
//    OBJECTS t=Pack
//    PROPERTIES(t) namePack READONLY, DELETE FORCE PANEL TOOLBAR
//    PROPERTIES(t) EDITFORM
//    ORDER BY namePack(t)
//;
//DESIGN packsSession { main{ preferredSize = (600, 400); } }

//addPack 'Добавить' = ACTION (gg) {
//    FORM packSession OBJECTS gg = gg MODAL;    
//    IF formResult() == FormResult.ok THEN {
//        LOCAL loc = Pack();
//        loc() <- NULL;
//        IF packName(chosenString('v')) THEN {
//            dataInPackItemGroup(pack, gg) <- TRUE WHERE  pack == packName(chosenString('v'));
//        } ELSE {
//            FOR ADDOBJ p = Pack DO {
//                namePack(p) <- chosenString('v');
//                dataInPackItemGroup(p, gg) <- TRUE;
//                loc() <- p;
//            }
//        }
//        SEEK packsSession.t (IF packName(chosenString('v')) THEN packName(chosenString('v')) ELSE loc());
//    }
//} TOOLBAR IMAGE 'add.png' EDITKEY 'INSERT';
//
//EXTEND FORM packsSession
//    PROPERTIES addPack(gg) FORCE PANEL TOOLBAR TODRAW t
//;

//changePackItem = ACTION (i) {
//    REQUEST OBJECT t
//    FORM packsSession OBJECTS gg = itemGroupItem(i) CONTEXTFILTER t = packItem(i) DIALOG SHOWDROP;   
//    IF formResult() == FormResult.ok THEN {
//        packItem(i) <- requestedObject();
//
//    } ELSE IF formResult() == FormResult.drop THEN {
//        packItem(i) <- NULL;
//    }
//}

//EXTEND FORM item PROPERTIES(i) vv = namePackItem SHOWIF showPackItem(i) BACKGROUND backgroundPackItem(i) ON CHANGE changePackItem(i);

// Свойство
@defineStringItemAttribute(property, VARSTRING[100], 'Свойство', itemDescription);
@defineItemAttributeBatch (property, 'Свойство');
@implementItemAttribute(property, 'Свойство', String, itemProperty);
@defineItemExtractStringAttribute(property);

// Кол-во компонентов
@defineIntegerItemAttribute(numberComponents, 'Кол-во компонентов', itemDescription);
@defineItemAttributeBatch (numberComponents, 'Кол-во компонентов');
@implementItemAttribute(numberComponents, 'Кол-во компонентов', Integer, itemNumberComponents);

// Код артикула
@defineStringItemAttribute(manufacturerCode, VARSTRING[20], 'Код производителя', itemDescription);
@defineItemAttributeBatch (manufacturerCode, 'Код производителя');
@implementItemAttribute(manufacturerCode, 'Код производителя', String, itemManufacturerCode);

// Описание
@defineStringItemAttribute(description, TEXT, 'Описание', itemDescription);
@defineItemAttributeBatch (description, 'Описание');

DESIGN items {
    PROPERTY(descriptionItem(i)) {
        minimumSize = (200, 14);
        preferredSize = (200, 14);
    }
}

DESIGN item {
    PROPERTY(descriptionItem(i)) {
        font = '"Courier New"';
        preferredSize = (400, 128);
    }
}

overCopyItem(s, d) += ACTION (s, d) {
    typeItem(d) <- typeItem(s);
    sortItem(d) <- sortItem(s);
    formItem(d) <- formItem(s);
    featureItem(d) <- featureItem(s);
    packItem(d) <- packItem(s);
    propertyItem(d) <- propertyItem(s);
    numberComponentsItem(d) <- numberComponentsItem(s);
    manufacturerCodeItem(d) <- manufacturerCodeItem(s);
    descriptionItem(d) <- descriptionItem(s);
}


DESIGN item {
    itemPrimaryColumn1 {
        ADD i.itemDescription {
            columns = 2;
        }
    }
}

DESIGN itemGroup {
    itemGroupDetail {
        ADD g.itemDescription {
            columns = 6;
        }
    }
}

