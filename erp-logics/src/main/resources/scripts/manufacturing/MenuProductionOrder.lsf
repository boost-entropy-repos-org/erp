MODULE  MenuProductionOrder;

REQUIRE Menu,
        ProductionOrder,
        BOMNutrition;

// -- Заполнение на основе производственных заказов ---- //

FORM menuOrders 'Производственные заказы'

    OBJECTS o = Order
    PROPERTIES(o) READONLY isPostedOrder FORCE GRID, numberObject, seriesObject, dateOrder, timeOrder,
                  nameComponentsStockOrder, nameProductsStockOrder, fromDateOrder, toDateOrder, quantityProductDetailOrder,
                  productsSumProductDetailOrder, quantityProductDetailOrder,
                  nameCalcPriceListTypeOrder, namePriceListTypeOrder, noteOrder, objectClassName
    FILTERS isPostedOrder(o)

    OBJECTS pd=ProductDetail
    PROPERTIES(pd) READONLY indexProductDetail, nameSkuProductDetail, nameProductProductDetail, shortNameUOMProductDetail, quantityProductDetail,
                   productsPriceProductDetail, productsSumProductDetail
    FILTERS orderProductDetail(pd)==o
;

DESIGN menuOrders FROM DEFAULT {
    main {
        preferredSize = (1024, 768);
        NEW documentContainer BEFORE functions.box {

            childConstraints = TO THE BOTTOM;
            ADD o.box;
            ADD pd.box {
                caption = 'Изделия';
            }
        }
    }
}

fillOrderUserMenu 'Заполнить на основе производственного заказа' =  ACTION (userMenu) {
    FORM menuOrders MODAL;
    IF formResult() == FormResult.ok THEN {
        LOCAL productionOrder = Order();
        ASSIGN productionOrder() <- chosenObject('o');
        ASSIGN noteUserMenu(userMenu) <- [FORMULA VARSTRING[100]  ' CAST($1 AS TEXT) || \' \' || CAST($2 AS TEXT) '](
                                             'Основание:', descriptionOrder(productionOrder()));
        FOR orderProductDetail(productDetail) == productionOrder() ADDOBJ d = UserMenuDetail DO {
            ASSIGN userMenuUserMenuDetail(d) <- userMenu;
            ASSIGN priceUserMenuDetail(d) <- productsPriceProductDetail(productDetail);
            ASSIGN skuUserMenuDetail(d) <- skuProductDetail(productDetail);
            ASSIGN productYieldUserMenuDetail(d) <- productYieldProduct(productProductDetail(productDetail));
            ASSIGN compositionUserMenuDetail(d) <- compositionProduct(productProductDetail(productDetail));
        }
    }
}

EXTEND FORM userMenu
    PROPERTIES(m) fillOrderUserMenu
;
EXTEND DESIGN userMenu {
    headerRow1 {
        NEW row2 BEFORE row1 {
            caption = 'Производственный заказ';
            childConstraints = TO THE RIGHTBOTTOM;

            ADD PROPERTY(fillOrderUserMenu);
        }
    }
}
