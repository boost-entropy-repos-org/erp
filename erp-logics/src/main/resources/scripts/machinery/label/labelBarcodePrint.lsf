MODULE LabelBarcodePrint;

REQUIRE Label;

NAMESPACE Label;

FORM labelBarcodePrint 'Печать ценников по штрих-коду'
    OBJECTS dt = LabelTransactionDetail LAST 
;

consumedChangeBarcodePrint = DATA LOCAL NESTED BOOLEAN();
overChangeBarcodePrint = ACTION ABSTRACT LIST (VARSTRING[15], DepartmentStore);

changeBarcodePrint(DepartmentStore d) = ACTION {
    REQUEST VARSTRING[15] INPUT;
    LOCAL barcode = VARSTRING[15] ();
    barcode() <- requestedString();
    
    LOCAL dialogBarcodeSku = Sku();
    dialogBarcodeSku() <- skuBarcode(barcode(), currentDate());
    
    consumedChangeBarcodePrint() <- NULL;
    overChangeBarcodePrint(barcode(), d);
    IF NOT consumedChangeBarcodePrint() THEN {
        IF dialogBarcodeSku() IS Sku THEN {
            IF active(dialogBarcodeSku()) THEN {
                select(Sku s) <- s == dialogBarcodeSku();
                overQuantityPrint(Sku s) <- 1 IF s == dialogBarcodeSku();
                labelPrintAuto() <- TRUE;
                printSelectedSkuLabelTransaction(d);
            } ELSE {
                MESSAGE CONCAT ' ', name(dialogBarcodeSku()), '(' + barcode() + ')', ' запрещен к продаже';
            }
            
        } ELSE
            MESSAGE CONCAT ' ', 'Не найден штрихкод', barcode(), '(' + requestedString() + ')';
    }
    
    SEEK LAST labelBarcodePrint.dt;
}

EXTEND FORM labelBarcodePrint 
    OBJECTS d = DepartmentStore FIXED PANEL
    PROPERTIES name(d) SELECTOR
    
    OBJECTS b = VARSTRING[15] FIXED PANEL
    PROPERTIES(b) barcode = OBJVALUE ON CHANGE changeBarcodePrint(d) EVENTID 'SCANNER'
    
    PROPERTIES(dt) READONLY nameLabelType, date, time, idBarcode, nameSku, nameBatch, quantity, 
                   name, price, retailPrice, discountSum, nameSkuGroupSku, shortNameUOMSku, nameCountrySku, residentCountrySku, nameSupplierSku, 
                   fullNameSupplierSku, shortNameOwnershipSupplierSku, nameAddressPhoneLegalEntity
    FILTERS departmentStore(dt) == d
;
@extendFormFilterStockAccess(d, labelBarcodePrint);

DESIGN labelBarcodePrint {
    NEW header {
        type = CONTAINERH ;
        MOVE PROPERTY(barcode) { caption = 'Ввести штрихкод'; panelCaptionAbove = TRUE; focusable = FALSE;  font = 'bold 22'; editKey = 'F4'; }
        MOVE d.box;
    }
    MOVE dt.box;
    MOVE functions.box;
}

NAVIGATOR {
    retailDashboardNavigator{
        ADD labelBarcodePrint;
    }
}
