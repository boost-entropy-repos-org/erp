MODULE Terminal;

REQUIRE System, Machinery;

// Группы
CLASS GroupTerminal 'Группы ТСД' : GroupMachinery;
TABLE groupTerminal (GroupTerminal);

stockGroupTerminal = DATA Stock (GroupTerminal);
stockGroupMachinery (groupMachinery) += stockGroupTerminal(groupMachinery);

// Модели
CLASS TerminalModel 'Модель ТСД' : Model;
TABLE terminalModel (TerminalModel);

nameTerminalModel 'Наименование' = DATA VARISTRING[110](TerminalModel);

nameModel(model) += nameTerminalModel(model) IF model IS TerminalModel;

FORM terminalModel 'Модель ТСД'
    OBJECTS t=TerminalModel FIXED PANEL
    PROPERTIES(t) nameTerminalModel, noteModel, handlerModel, maxProductModel
    EDIT TerminalModel OBJECT t
;

FORM terminalModels 'Модели ТСД'
    OBJECTS m=TerminalModel
    PROPERTIES(m) READONLY nameTerminalModel, maxProductModel, handlerModel, noteModel
    PROPERTIES(m) ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR
;

// Терминалы
CLASS Terminal 'ТСД' : Machinery;
TABLE terminal (Terminal);

isTerminal (machinery) = machinery IS Terminal;

groupTerminalTerminal = DATA GroupTerminal (Terminal);
groupMachineryMachinery(machinery) += groupTerminalTerminal(machinery);

directoryGroupTerminal 'Директория обмена с ТСД' = DATA VARSTRING[100] (GroupTerminal) IN base;

terminalModelTerminal = DATA TerminalModel (Terminal);
modelMachinery(machinery) += terminalModelTerminal(machinery);

FORM terminal 'ТСД'
    OBJECTS t=Terminal FIXED PANEL
    PROPERTIES(t) nameGroupMachineryMachinery, nppMachinery, descriptionMachinery, portMachinery, nameModelMachinery
    EDIT Terminal OBJECT t
;

// ------------------------ Группы типов документов ------------------------- //
CLASS GroupTerminalDocumentType 'Группа типов документов';
TABLE groupTerminalDocumentType (GroupTerminalDocumentType);

nameGroupTerminalDocumentType 'Наименование группы' = DATA VARSTRING[200] (GroupTerminalDocumentType) IN base MINCHARWIDTH 10 PREFCHARWIDTH 20;
groupTerminalDocumentTypeGroupTerminal 'Группа типов документов (ИД)' = DATA GroupTerminalDocumentType (GroupTerminal);
nameGroupTerminalDocumentTypeGroupTerminal 'Группа типов документов' (groupTerminal) = nameGroupTerminalDocumentType(groupTerminalDocumentTypeGroupTerminal(groupTerminal));

// ------------------------------------- Виды справочников ТСД --------------------------------- //

CLASS TerminalHandbookType 'Вид справочника ТСД' {
    terminalHandbookTypeLegalEntity 'Организация'
}
FORM terminalHandbookTypes
    OBJECTS t = TerminalHandbookType
    PROPERTIES(t) staticCaption
    DIALOG TerminalHandbookType OBJECT t
;

TABLE terminalHandbookType(TerminalHandbookType);

@defineExternalizable(terminalHandbookType, VARSTRING[100]);  

FORM handbooksTerminalDocumentType 'Виды справочников ТСД'
    OBJECTS h=TerminalHandbookType
    PROPERTIES(h)  staticCaption, idTerminalHandbookType
    PROPERTIES(h)  ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR
;

//---------------------------- типы документов ----------------------------------------//

CLASS TerminalDocumentType 'Тип документов';
TABLE terminalDocumentType (TerminalDocumentType);

groupTerminalDocumentTypeTerminalDocumentType = DATA GroupTerminalDocumentType (TerminalDocumentType);
nameGroupTerminalDocumentTypeTerminalDocumentType 'Группа типов документов' (terminalDocumentType) = nameGroupTerminalDocumentType(groupTerminalDocumentTypeTerminalDocumentType(terminalDocumentType));

nameTerminalDocumentType 'Название' = DATA VARSTRING[200] (TerminalDocumentType) IN base;

@defineExternalizable(terminalDocumentType, VARSTRING[100]);

terminalHandbookType1TerminalDocumentType = DATA TerminalHandbookType (TerminalDocumentType);
idTerminalHandbookType1TerminalDocumentType 'Код' (terminalDocumentType)  = idTerminalHandbookType (terminalHandbookType1TerminalDocumentType(terminalDocumentType));
nameTerminalHandbookType1TerminalDocumentType 'Имя' (terminalDocumentType)  = staticCaption(terminalHandbookType1TerminalDocumentType(terminalDocumentType));

nameInHandbook1TerminalDocumentType 'Наименование в справочнике 1' = DATA VARSTRING[200] (TerminalDocumentType) IN base;
nameInHandbook1TerminalDocumentType(terminalDocumentType) <- nameTerminalHandbookType1TerminalDocumentType(terminalDocumentType) WHEN CHANGED(terminalHandbookType1TerminalDocumentType(terminalDocumentType));

terminalHandbookType2TerminalDocumentType = DATA TerminalHandbookType (TerminalDocumentType);
idTerminalHandbookType2TerminalDocumentType 'Код' (terminalDocumentType)  = idTerminalHandbookType (terminalHandbookType2TerminalDocumentType(terminalDocumentType));
nameTerminalHandbookType2TerminalDocumentType 'Имя' (terminalDocumentType)  = staticCaption(terminalHandbookType2TerminalDocumentType(terminalDocumentType));

nameInHandbook2TerminalDocumentType 'Наименование в справочнике 2' = DATA VARSTRING[200] (TerminalDocumentType) IN base;
nameInHandbook2TerminalDocumentType(terminalDocumentType) <- nameTerminalHandbookType2TerminalDocumentType(terminalDocumentType) WHEN CHANGED(terminalHandbookType2TerminalDocumentType(terminalDocumentType));

FORM groupTerminalDocumentType 'Группа типов документов'
    OBJECTS gtdt=GroupTerminalDocumentType FIXED PANEL
    PROPERTIES(gtdt) nameGroupTerminalDocumentType

    OBJECTS tdt=TerminalDocumentType
    PROPERTIES(tdt)   idTerminalDocumentType, nameTerminalDocumentType, nameGroupTerminalDocumentTypeTerminalDocumentType,
                      nameInHandbook1TerminalDocumentType, idTerminalHandbookType1TerminalDocumentType,
                      nameInHandbook2TerminalDocumentType, idTerminalHandbookType2TerminalDocumentType,
                      ADDOBJ, DELETESESSION

    FILTERGROUP filters3
        FILTER 'Показывать только для данной группы' 'F10' groupTerminalDocumentTypeTerminalDocumentType(tdt) == gtdt DEFAULT

    EDIT GroupTerminalDocumentType OBJECT gtdt
;

FORM groupsTerminalDocumentType 'Группы типов документов'
    OBJECTS gtdt=GroupTerminalDocumentType, tdt=TerminalDocumentType
    PROPERTIES(gtdt) READONLY nameGroupTerminalDocumentType
    PROPERTIES(gtdt) ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR

    PROPERTIES(tdt) READONLY idTerminalDocumentType, nameTerminalDocumentType,
                             nameInHandbook1TerminalDocumentType, idTerminalHandbookType1TerminalDocumentType,
                             nameInHandbook2TerminalDocumentType, idTerminalHandbookType2TerminalDocumentType

    FILTERS groupTerminalDocumentTypeTerminalDocumentType (tdt) == gtdt
;

DESIGN groupsTerminalDocumentType FROM DEFAULT {
    NEW topContainer{
        type = SPLITV;
        fill = 1;

        ADD gtdt.box;
        ADD tdt.box;
    }
    ADD functions.box;
}

FORM groupTerminal 'Группа ТСД'
    OBJECTS grt=GroupTerminal FIXED PANEL
    PROPERTIES(grt) nppGroupMachinery, nameStockGroupMachinery, nameGroupMachinery,
                    nameGroupTerminalDocumentTypeGroupTerminal,
                    filterSkuGroupMachinery, showFilterSkuGroupMachinery SHOWIF filterSkuGroupMachinery(grt),
                    directoryGroupTerminal

    OBJECTS t=Terminal
    PROPERTIES(t)   nameGroupMachineryMachinery, nppMachinery, descriptionMachinery, portMachinery, nameModelMachinery,
                    ADDOBJ, DELETESESSION

    FILTERGROUP filters3
        FILTER 'Показывать только для данной группы' 'F10' groupTerminalTerminal(t) == grt DEFAULT

    EDIT GroupTerminal OBJECT grt
;

FORM groupsTerminal 'Группы ТСД'
    OBJECTS grt=GroupTerminal, t=Terminal
    PROPERTIES(grt)  READONLY nppGroupMachinery, nameStockGroupMachinery, nameGroupMachinery,
                     nameGroupTerminalDocumentTypeGroupTerminal,
                     filterSkuGroupMachinery, showFilterSkuGroupMachinery SHOWIF filterSkuGroupMachinery(grt),
                     namePriceListTypeGroupMachinery, directoryGroupTerminal

    PROPERTIES(grt)  ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR

    PROPERTIES(t) READONLY nppMachinery, descriptionMachinery, portMachinery, nameModelMachinery
    FILTERS groupTerminalTerminal(t) == grt
;

DESIGN groupsTerminal FROM DEFAULT {
    NEW topContainer{
        type = SPLITV;
        fill = 1;

        ADD grt.box;
        ADD t.box;
    }
    ADD functions.box;
}

// ------------------------------------ Документы ТСД ------------------------------- //

CLASS TerminalDocument 'Документ ТСД';
TABLE terminalDocument (TerminalDocument);

@defineExternalizable(terminalDocument, VARSTRING[100]);  

titleTerminalDocument 'Имя' = DATA VARSTRING[100] (TerminalDocument) IN base MINCHARWIDTH 20 PREFCHARWIDTH 30;
quantityTerminalDocument 'Количество' = DATA NUMERIC[14,3] (TerminalDocument) IN base;
idTerminalHandbookType1TerminalDocument 'Код в справочнике 1' = DATA INTEGER (TerminalDocument) IN base;
idTerminalHandbookType2TerminalDocument 'Код в справочнике 2' = DATA INTEGER (TerminalDocument) IN base;

terminalDocumentTypeTerminalDocument = DATA TerminalDocumentType (TerminalDocument);
nameTerminalDocumentTypeTerminalDocument 'Тип документа' (terminalDocument) = nameTerminalDocumentType (terminalDocumentTypeTerminalDocument (terminalDocument)) MINCHARWIDTH 20 PREFCHARWIDTH 30;

idTerminalDocumentTypeTerminalDocument (terminalDocument) = idTerminalDocumentType (terminalDocumentTypeTerminalDocument (terminalDocument));

usedTerminalDocument 'Использован' (terminalDocument) = DATA BOOLEAN (TerminalDocument) IN base;
notUsedTerminalDocument 'Неиспользован' (terminalDocument) = terminalDocument IS TerminalDocument AND NOT usedTerminalDocument(terminalDocument);

terminalDocumentTerminalDocumentDetail = DATA TerminalDocument(TerminalDocumentDetail);

CLASS TerminalDocumentDetail 'Строка документа ТСД';
TABLE terminalDocumentDetail (TerminalDocumentDetail);

@defineExternalizable(terminalDocumentDetail, VARSTRING[100]);          

numberTerminalDocumentDetail 'Номер' = DATA VARSTRING[100] (TerminalDocumentDetail) IN base;
barcodeTerminalDocumentDetail 'Штрих-код' = DATA STRING[15] (TerminalDocumentDetail) IN base;
quantityTerminalDocumentDetail 'Количество' = DATA NUMERIC[14,3] (TerminalDocumentDetail) IN base;
priceTerminalDocumentDetail 'Цена' = DATA NUMERIC[14,2] (TerminalDocumentDetail) IN base;
sumTerminalDocumentDetail 'Сумма' = DATA NUMERIC[16,2] (TerminalDocumentDetail) IN base;
nameTerminalDocumentDetail 'Наименование' = DATA VARSTRING[200] (TerminalDocumentDetail) IN base;
isNewTerminalDocumentDetail 'Новый товар' = DATA BOOLEAN (TerminalDocumentDetail) IN base;

// ----------------------------------------------- Формы документов ------------------------------------------ //

FORM terminalDocument 'Документ ТСД'
    OBJECTS td=TerminalDocument FIXED PANEL
    PROPERTIES(td)  idTerminalDocument, nameTerminalDocumentTypeTerminalDocument, idTerminalHandbookType1TerminalDocument,
                    idTerminalHandbookType2TerminalDocument, titleTerminalDocument, quantityTerminalDocument, usedTerminalDocument READONLY

    OBJECTS tdd=TerminalDocumentDetail
    PROPERTIES(tdd) numberTerminalDocumentDetail, barcodeTerminalDocumentDetail, nameTerminalDocumentDetail,
    isNewTerminalDocumentDetail, priceTerminalDocumentDetail, quantityTerminalDocumentDetail, sumTerminalDocumentDetail, ADDOBJ

    FILTERS terminalDocumentTerminalDocumentDetail(tdd) == td

    EDIT TerminalDocument OBJECT td;
;

DESIGN terminalDocument FROM DEFAULT {
    td.box{
        type = CONTAINERV;

        NEW row1 {
            type = CONTAINERH;
            ADD PROPERTY(idTerminalDocument(td));
            ADD PROPERTY(nameTerminalDocumentTypeTerminalDocument(td));
            ADD PROPERTY(titleTerminalDocument(td));
        }
        NEW row2 {
            type = CONTAINERH;
            ADD PROPERTY(idTerminalHandbookType1TerminalDocument(td));
            ADD PROPERTY(idTerminalHandbookType2TerminalDocument(td));
            ADD PROPERTY(quantityTerminalDocument(td));
            ADD PROPERTY(usedTerminalDocument(td));
        }
    }
    ADD tdd.box;
    ADD functions.box;
}

FORM terminalDocuments 'Документы ТСД'
    OBJECTS td=TerminalDocument
    PROPERTIES(td)  READONLY idTerminalDocument, nameTerminalDocumentTypeTerminalDocument, idTerminalHandbookType1TerminalDocument,
                    idTerminalHandbookType2TerminalDocument, titleTerminalDocument, quantityTerminalDocument
    PROPERTIES(td)  ADDFORM, EDITFORM, DELETE FORCE PANEL TOOLBAR

    OBJECTS tdd=TerminalDocumentDetail
    PROPERTIES(tdd) READONLY numberTerminalDocumentDetail, barcodeTerminalDocumentDetail, nameTerminalDocumentDetail,
    isNewTerminalDocumentDetail, priceTerminalDocumentDetail, quantityTerminalDocumentDetail, sumTerminalDocumentDetail

    FILTERS terminalDocumentTerminalDocumentDetail(tdd) == td
    FILTERGROUP filterUse
        FILTER 'Неиспользованные' 'F10' notUsedTerminalDocument(td) DEFAULT
;

DESIGN terminalDocuments FROM DEFAULT {
    main {
        preferredSize = (1024, 768);
        NEW topContainer{
            type = SPLITV;
            fill = 1;

            ADD td.box;
            ADD tdd.box;
        }
    }
    ADD functions.box;
}

//----------------------------- Макросы для документов --------------------------------//

META defineAddDetailDialogTerminal (object, skuProp)
    @defineAddDetailDialogTerminalInner (object, ###object, skuProp);
END

META defineAddDetailDialogTerminalInner (object, class, skuProp)
    addDetailDialogTerminal###object##Detail###object 'Импорт из ТСД' (object) = ACTION (object) {
        FORM terminalDocuments MODAL;
        IF formResult() == FormResult.ok THEN {
            LOCAL document = TerminalDocument ();
            ASSIGN document() <- chosenObject('td');
            ASSIGN usedTerminalDocument(terminalDocument) <- TRUE WHERE terminalDocument == document()  ;

            FOR terminalDocumentTerminalDocumentDetail(tdd) == document()  DO {
                FOR ADDOBJ o = class##Detail DO {
                    ASSIGN object###object##Detail(o) <- object;
                    ASSIGN skuProp###object##Detail(o) <- skuBarcode(barcodeIdDate(barcodeTerminalDocumentDetail(tdd), date###object(object)));
                    ASSIGN quantity###object##Detail(o) <- quantityTerminalDocumentDetail(tdd);
                }
            }
        }
    } TOOLBAR;
END

// ------------------------------------------------ Стандартные значения ------------------------------------ //

// Модели терминалов сбора данных
loadDefaultTerminalModel 'Добавить модель терминала' = ACTION (stringOne, stringTwo)  {
    FOR ADDOBJ tm = TerminalModel DO {
         ASSIGN nameTerminalModel(tm) <- stringOne;
         ASSIGN handlerModel(tm) <- stringTwo;
    }
}

loadDefaultTerminalModels 'Загрузить стандартные модели ТСД' = ACTION () {
    EXEC loadDefaultTerminalModel('ТСД InventoryTech', 'equ.clt.handler.inventoryTech.InventoryTechHandler');
    EXEC loadDefaultTerminalModel('ТСД EasyCSV', 'equ.clt.handler.easy.EasyCSVHandler');
    EXEC loadDefaultTerminalModel('ТСД LSTerminal', 'equ.clt.handler.lsterminal.LSTerminalHandler');
} IN loadDefault;

@implementLoadDefaultData(loadDefaultTerminalModels);

// Виды справочников терминалов сбора данных
loadDefaultTerminalHandbookType 'Добавить вид справочника ТСД' = ACTION (handbookTypeName, idString) {
    ASSIGN idTerminalHandbookType(x) <- idString WHERE x==handbookTypeName;
}

loadDefaultTerminalHandbookTypes 'Загрузить стандартные виды справочников ТСД' = ACTION () {
    EXEC loadDefaultTerminalHandbookType(TerminalHandbookType.terminalHandbookTypeLegalEntity, '01');
} IN loadDefault;

@implementLoadDefaultData(loadDefaultTerminalHandbookTypes);

// Типы документов терминалов сбора данных
loadDefaultTerminalDocumentType 'Добавить тип документа ТСД' = ACTION (nameString, gtdt, idTypeString, handbook1String, handbook2String) {
    FOR ADDOBJ tdt = TerminalDocumentType DO {
        ASSIGN nameTerminalDocumentType(tdt) <- nameString;
        ASSIGN groupTerminalDocumentTypeTerminalDocumentType(tdt) <- gtdt;
        ASSIGN terminalHandbookType1TerminalDocumentType(tdt) <- terminalHandbookTypeId(handbook1String);
        ASSIGN terminalHandbookType2TerminalDocumentType(tdt) <- terminalHandbookTypeId(handbook2String);
        ASSIGN idTerminalDocumentType(tdt) <- idTypeString;
    }
}

loadDefaultTerminalDocumentTypes 'Загрузить стандартные типы документов ТСД' = ACTION () {
    FOR ADDOBJ gtdt = GroupTerminalDocumentType DO {
        ASSIGN nameGroupTerminalDocumentType(gtdt) <- 'Группа типов документов';
        EXEC loadDefaultTerminalDocumentType('Инвентаризация', gtdt, '01', ' ', ' ');
        EXEC loadDefaultTerminalDocumentType('Приход', gtdt, '02', '01', ' ');
        EXEC loadDefaultTerminalDocumentType('Отгрузка по безналичному расчёту', gtdt, '03', '01', ' ');
    }
} IN loadDefault;

@implementLoadDefaultData(loadDefaultTerminalDocumentTypes);

// ------------------------------------------ Генерация групп терминалов сбора данных ------------------------------ //
loadDefaultGroupTerminal 'Сгенерировать группу терминалов' = ACTION(stock, model, gtdt, num) {
    FOR ADDOBJ g = GroupTerminal DO {
        stockGroupTerminal(g) <- stock;
        nameGroupMachinery(g) <- 'Группа ТСД по умолчанию';
        groupTerminalDocumentTypeGroupTerminal(g) <- gtdt;

        LOCAL numTerminal = INTEGER();
        numTerminal() <- 0;
        WHILE numTerminal() < num DO {
            FOR ADDOBJ t = Terminal DO {
                groupTerminalTerminal(t) <- g;
                numTerminal() <- numTerminal() + 1;
                nppMachinery(t) <- numTerminal();
                terminalModelTerminal(t) <- model;
            }
        }
    }
}

EXTEND FORM defaultData
    OBJECTS         tm=TerminalModel FIXED PANEL
    PROPERTIES(tm)  SELECTOR nameTerminalModel

    OBJECTS         gtdt=GroupTerminalDocumentType FIXED PANEL
    PROPERTIES(gtdt) SELECTOR nameGroupTerminalDocumentType

    OBJECTS         cTerminal=INTEGER FIXED PANEL
    PROPERTIES(cTerminal)   intValueTerminal = OBJVALUE
    PROPERTIES (s, tm, gtdt, cTerminal)  loadDefaultGroupTerminal
;

EXTEND DESIGN defaultData {
    PROPERTY(nameTerminalModel(tm)) {
        caption = 'Модель ТСД';
    }
    PROPERTY(nameGroupTerminalDocumentType(gtdt)) {
        caption = 'Группа типов документов';
    }
    PROPERTY(intValueTerminal) {
        caption = 'Количество ТСД';
    }
    machinery {
        NEW terminal {
            caption = 'ТСД';
            ADD PROPERTY(nameTerminalModel(tm));
            ADD PROPERTY(nameGroupTerminalDocumentType(gtdt));
            ADD PROPERTY(intValueTerminal);
            ADD PROPERTY(loadDefaultGroupTerminal(s,tm,gtdt,cTerminal));
        }
    }
}

NAVIGATOR {
    machineryNavigator {
        NEW terminalNavigator 'Терминалы сбора данных' {
            ADD terminalDocuments;
            ADD groupsTerminal;
            ADD terminalModels;
            ADD groupsTerminalDocumentType;
            ADD handbooksTerminalDocumentType;
        }
    }
}