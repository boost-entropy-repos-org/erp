MODULE PurchaseInvoicePharmacy;

REQUIRE System, PurchaseInvoice, StockPharmacy;

NAMESPACE Purchase;

seriesPharmacyInvoiceDetail 'Серия лекарственного средства' = ABSTRACT VARSTRING[20] (InvoiceDetail) MINCHARWIDTH 7 PREFCHARWIDTH 7;
seriesPharmacyUserInvoiceDetail 'Серия лекарственного средства' = DATA VARSTRING[20] (UserInvoiceDetail) MINCHARWIDTH 7 PREFCHARWIDTH 7;
seriesPharmacyInvoiceDetail(detail) += seriesPharmacyUserInvoiceDetail(detail);

EXTEND FORM userInvoice
    PROPERTIES(d) seriesPharmacyUserInvoiceDetail SHOWIF showSeriesPharmacy() BEFORE nameBatchUserInvoiceDetail
;

EXTEND FORM invoices
    PROPERTIES(d) READONLY seriesPharmacyInvoiceDetail SHOWIF showSeriesPharmacy() BEFORE nameBatchInvoiceDetail
;


WHEN SESSION FORMS userInvoice CHANGED (batchUserInvoiceDetail(detail)) OR
                               CHANGED (skuUserInvoiceDetail(detail)) OR
                               CHANGED (customerStockUserInvoiceDetail(detail)) DO {
    seriesPharmacyUserInvoiceDetail(detail) <- IF batchUserInvoiceDetail(detail) 
                                                    THEN seriesPharmacyBatch(batchUserInvoiceDetail(detail))
                                                    ELSE seriesPharmacyBatch(lastOrderBatchSkuStock(skuUserInvoiceDetail(detail), customerStockUserInvoiceDetail(detail)));
}

