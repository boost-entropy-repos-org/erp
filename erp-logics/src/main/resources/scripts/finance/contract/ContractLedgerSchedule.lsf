MODULE ContractLedgerSchedule;

REQUIRE ContractLedger;

PRIORITY Contract;

sumContractLegderDate(date) = GROUP SUM sumContractLedger(conractALedger) //IF dateContractALedger(conractALedger) > dateFrom AND dateContractALedger(conractALedger) < dateTo
                                     BY dateContractLedger(conractLedger);

sumContractDateFromDateTo(contract, dateFrom, dateTo) = GROUP SUM sumContractLedger(conractLedger) IF dateContractLedger(conractLedger) > dateFrom AND dateContractLedger(conractLedger) < dateTo
                                                               BY contractContractLedger(conractLedger), dateFrom, dateTo;

sumContractDate(contract, date) = GROUP SUM sumContractLedger(conractLedger)
                                         BY contractContractLedger(conractLedger), dateContractLedger(conractLedger);

toString10Date(date) = STRING[10](date);

sumsContractDate 'Суммы' (contract, date) =  TEXT(balanceAContractDate(contract, date) + '\n' + sumContractDate(contract, date));

EXTEND FORM contractLedger

    OBJECTS dateFrom = DATE FIXED PANEL
    PROPERTIES(dateFrom) date1 = OBJVALUE
    OBJECTS dateTo = DATE FIXED PANEL
    PROPERTIES(dateTo) date2 = OBJVALUE

    OBJECTS dateIn = DATE
    PROPERTIES(dateIn) date3 = OBJVALUE
    FILTERS sumContractLegderDate(dateIn) AND dateFrom < dateIn AND dateIn < dateTo

    OBJECTS cc = Contract
    PROPERTIES(cc) READONLY seriesNumberContract, namePartyAContract, namePartyBContract
    ORDER BY seriesNumberContract
    FILTERS sumContractDateFromDateTo(cc, dateFrom, dateTo)

    PROPERTIES READONLY sumsContractDate(cc, dateIn) COLUMNS (dateIn) HEADER toString10Date(dateIn)

    OBJECTS cl2 = ContractLedger
    PROPERTIES (cl2) dateContractLedger, sumContractLedger, descriptionContractLedger
    FILTERS contractContractLedger(cl2) == cc

;

EXTEND DESIGN contractLedger {
    detailContainer {
        NEW rightContainer {
            caption = 'План платежей';
            childConstraints = TO THE BOTTOM;
            NEW dateContainer {
                childConstraints = TO THE RIGHT;
                caption = 'Период';
                ADD PROPERTY(date1) {caption = 'Дата с';}
                ADD PROPERTY(date2) {caption = 'Дата по';};
            }

            REMOVE dateIn.box;
            ADD cc.box;
            PROPERTY(sumsContractDate) {
                minimumSize = ( -1, 34);
                preferredSize = ( -1, 34);
                maximumSize = ( -1, 34);
            }
            ADD cl2.box;

        }
    }
}
