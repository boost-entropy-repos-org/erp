MODULE InventoryBy;

REQUIRE Inventory;

NAMESPACE Inventory;

//------------------------------------------ Печатные формы -------------------------------------------------//

//------------------------------------ Опись ------------------------------------------//

FORM printListInventoryBy 'Опись'

    OBJECTS         li=ListInventory FIXED PANEL
    PROPERTIES (li) dateListInventory, nameLegalEntityStockListInventory, fullNameStockListInventory,
                    nameInventoryListInventory, nameListInventory, noteListInventory, committeeListInventory,
                    nameCommitteeListInventory, nameChairmanCommitteeListInventory, namePositionChairmanListInventory, nameEmployeeListInventory,
                    countPageInventoryListInventory, countPageInventoryDetailListInventory, quantityPageInventoryDetailListInventory,
                    sumPageInventoryDetailListInventory, countIndexListInventory, countIndexBatchListInventory, isBatchListInventory, isSkuListInventory

    OBJECTS t = DATETIME FIXED PANEL
    PROPERTIES(t) dateTime = OBJVALUE

    OBJECTS         i=Sku
    PROPERTIES (li,i) indexListInventorySku
    PROPERTIES (i)    idBarcodeSku, nameSku
    PROPERTIES (li,i) quantityPageInventoryDetailListInventorySku, pricePageInventoryDetailListInventorySku, sumPageInventoryDetailListInventorySku
    FILTERS           quantityPageInventoryDetailListInventorySku(li,i) > 0
    ORDER BY indexListInventorySku(li,i)

    OBJECTS         b=Batch
    PROPERTIES (li,b) indexListInventoryBatch
    PROPERTIES (b)    idBarcodeSkuBatch, nameSkuBatch, descriptionBatch, nameBatch
    PROPERTIES (li,b) quantityPageInventoryDetailListInventoryBatch, pricePageInventoryDetailListInventoryBatch, sumPageInventoryDetailListInventoryBatch
    FILTERS           quantityPageInventoryDetailListInventoryBatch(li,b) > 0
    ORDER BY indexListInventoryBatch(li,b)

    OBJECTS e=Employee
    PROPERTIES(e) READONLY   nameContact, namePositionEmployee
    FILTERS        inListInventoryEmployee(li, e)
;

DESIGN printListInventoryBy {
    main {
        preferredSize = (1024, 768);
        type = CONTAINERV;
        MOVE li.box {
            type = CONTAINERH;
            NEW row {
                type = CONTAINERV;
                MOVE li.documentHeader {
                    type = CONTAINERH;
                    MOVE PROPERTY(nameInventoryListInventory(li));
                    MOVE PROPERTY(nameListInventory(li));
                }
                MOVE li.inventoryCommittee {
                    type = CONTAINERH;
                }
                MOVE li.documentPrm;


            }
            MOVE li.documentSum {
                type = CONTAINERV;
                PROPERTY(countPageInventoryListInventory(li)) {
                    caption = 'Количество страниц';
                }

            }
        }

        MOVE i.box;
        MOVE b.box;
        MOVE e.box;
        MOVE functions.box;
    }
}

printListInventoryBy 'Опись' (listInventory) =
    ACTION FORM printListInventoryBy OBJECTS li=listInventory, t=currentDateTime() PRINT
    IMAGE 'print.png' IN print;

//------------------------------------ Сличительная ведомость ------------------------------------------//

FORM printCollationSheetBy 'Сличительная ведомость'

    OBJECTS          cs=CollationSheet FIXED PANEL
    PROPERTIES (cs)  SELECTOR nameCollationSheet, nameLegalEntityStockCollationSheet, nameCommitteeCollationSheet,
                              nameChairmanCommitteeCollationSheet, namePositionChairmanCollationSheet, nameEmployeeCollationSheet,
                              nameTypeOfAdditionCollationSheet, fullNameStockCollationSheet, dateCollationSheet,
                              quantityPageInventoryDetailCollationSheet, quantityBalanceCollationSheet, quantityShortageCollationSheet,
                              sumPageInventoryDetailCollationSheet, sumBalanceCollationSheet, sumShortageCollationSheet,
                              countListInventoryCollationSheet, countPageInventoryCollationSheet, prevDateCollationSheet,
                              sumItemPageInventoryDetailCollationSheet, sumContainerPageInventoryDetailCollationSheet,
                              sumItemBalanceCollationSheet, sumContainerBalanceCollationSheet,
                              sumItemShortageCollationSheet, sumContainerShortageCollationSheet, isBatchCollationSheet, isSkuCollationSheet,
                              numberDisposalCollationSheet

    OBJECTS          i=Sku
    PROPERTIES(i)     SELECTOR nameSku, idBarcodeSku
    PROPERTIES(cs, i) SELECTOR quantityPageInventoryDetailCollationSheetSku, quantityBalanceCollationSheetSku, quantityShortageCollationSheetSku
    PROPERTIES(cs, i)          pricePageInventoryDetailCollationSheetSku, priceBalanceCollationSheetSku
    PROPERTIES(cs, i) SELECTOR sumPageInventoryDetailCollationSheetSku, sumBalanceCollationSheetSku, sumShortageCollationSheetSku
    FILTERS                    includeCollationSheetSku(cs, i)
    ORDER BY nameSku(i)

    OBJECTS         b=Batch
    PROPERTIES(b)    SELECTOR nameSkuBatch, idBarcodeSkuBatch, descriptionBatch, nameBatch
    PROPERTIES(cs,b) SELECTOR quantityPageInventoryDetailCollationSheetBatch, quantityBalanceCollationSheetBatch, quantityShortageCollationSheetBatch
    PROPERTIES(cs,b) SELECTOR pricePageInventoryDetailCollationSheetBatch, priceBalanceCollationSheetBatch
    PROPERTIES(cs,b) READONLY sumPageInventoryDetailCollationSheetBatch, sumBalanceCollationSheetBatch, sumShortageCollationSheetBatch
    FILTERS                   includeCollationSheetBatch(cs,b),
                              quantityPageInventoryDetailCollationSheetBatch(cs,b) OR quantityBalanceCollationSheetBatch(cs,b)
    ORDER BY nameSkuBatch(b)
;

printCollationSheetBy 'Сличительная ведомость' (collationSheet) =
    ACTION FORM printCollationSheetBy OBJECTS cs = collationSheet PRINT  IMAGE 'print.png' IN print;
    
quantityPageInventoryDetailSkuCollationSheetSkuGroup 'Кол-во по описям' = GROUP SUM quantityPageInventoryDetailCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);
quantityBalanceSkuCollationSheetSkuGroup 'Кол-во по остаткам' = GROUP SUM quantityBalanceCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);
quantityShortageSkuCollationSheetSkuGroup 'Кол-во недостачи' = GROUP SUM quantityShortageCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);

sumPageInventoryDetailSkuCollationSheetSkuGroup 'Сумма по описям' = GROUP SUM sumPageInventoryDetailCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);
sumBalanceSkuCollationSheetSkuGroup 'Сумма по остаткам' = GROUP SUM sumBalanceCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);
sumShortageSkuCollationSheetSkuGroup 'Сумма недостачи' = GROUP SUM sumShortageCollationSheetSku(sheet, sku) BY sheet, skuGroupSku(sku);     
    
FORM printCollationSheetByGroup 'Сличительная ведомость(по группам)'

    OBJECTS          cs=CollationSheet FIXED PANEL
    PROPERTIES (cs)  SELECTOR nameCollationSheet, nameLegalEntityStockCollationSheet, nameCommitteeCollationSheet,
                              nameChairmanCommitteeCollationSheet, namePositionChairmanCollationSheet, nameEmployeeCollationSheet,
                              nameTypeOfAdditionCollationSheet, fullNameStockCollationSheet, dateCollationSheet,
                              quantityPageInventoryDetailCollationSheet, quantityBalanceCollationSheet, quantityShortageCollationSheet,
                              sumPageInventoryDetailCollationSheet, sumBalanceCollationSheet, sumShortageCollationSheet,
                              countListInventoryCollationSheet, countPageInventoryCollationSheet, prevDateCollationSheet,
                              sumItemPageInventoryDetailCollationSheet, sumContainerPageInventoryDetailCollationSheet,
                              sumItemBalanceCollationSheet, sumContainerBalanceCollationSheet,
                              sumItemShortageCollationSheet, sumContainerShortageCollationSheet, isBatchCollationSheet, isSkuCollationSheet,
                              numberDisposalCollationSheet
                              
    OBJECTS          sk = SkuGroup
    PROPERTIES(sk)   READONLY canonicalNameSkuGroup
    PROPERTIES(cs, sk) READONLY quantityPageInventoryDetailSkuCollationSheetSkuGroup, quantityBalanceSkuCollationSheetSkuGroup, quantityShortageSkuCollationSheetSkuGroup,
                                sumPageInventoryDetailSkuCollationSheetSkuGroup, sumBalanceSkuCollationSheetSkuGroup, sumShortageSkuCollationSheetSkuGroup 

    OBJECTS          i=Sku
    PROPERTIES(i)     SELECTOR nameSku, idBarcodeSku
    PROPERTIES(cs, i) SELECTOR quantityPageInventoryDetailCollationSheetSku, quantityBalanceCollationSheetSku, quantityShortageCollationSheetSku
    PROPERTIES(cs, i)          pricePageInventoryDetailCollationSheetSku, priceBalanceCollationSheetSku
    PROPERTIES(cs, i) SELECTOR sumPageInventoryDetailCollationSheetSku, sumBalanceCollationSheetSku, sumShortageCollationSheetSku
    FILTERS                    includeCollationSheetSku(cs, i),
                               skuGroupSku(i) == sk
    ORDER BY nameSku(i)

    OBJECTS         b=Batch
    PROPERTIES(b)    SELECTOR nameSkuBatch, idBarcodeSkuBatch, descriptionBatch, nameBatch
    PROPERTIES(cs,b) SELECTOR quantityPageInventoryDetailCollationSheetBatch, quantityBalanceCollationSheetBatch, quantityShortageCollationSheetBatch
    PROPERTIES(cs,b) SELECTOR pricePageInventoryDetailCollationSheetBatch, priceBalanceCollationSheetBatch
    PROPERTIES(cs,b) READONLY sumPageInventoryDetailCollationSheetBatch, sumBalanceCollationSheetBatch, sumShortageCollationSheetBatch
    FILTERS                   includeCollationSheetBatch(cs,b),
                              quantityPageInventoryDetailCollationSheetBatch(cs,b) OR quantityBalanceCollationSheetBatch(cs,b),
                              skuGroupSku(skuBatch(b)) == sk
    ORDER BY nameSkuBatch(b)
;

printCollationSheetByGroup 'Сличительная ведомость(по группам)' (collationSheet) =
    ACTION FORM printCollationSheetByGroup OBJECTS cs = collationSheet PRINT  IMAGE 'print.png' IN print;    
    
countIndexCollationSheet 'Количество наименований товара'(cs) = GROUP SUM 1 IF includeCollationSheetSku(cs, i)
        BY cs IN documentSum;    
countIndexBatchCollationSheet 'Количество наименований партий'(cs) = GROUP SUM 1 IF includeCollationSheetBatch(cs,b) 
    AND (quantityPageInventoryDetailCollationSheetBatch(cs,b) OR quantityBalanceCollationSheetBatch(cs,b))
        BY cs IN documentSum;     
        
FORM printCollationSheet 'Опись'

    OBJECTS          cs=CollationSheet FIXED PANEL
    PROPERTIES (cs)  SELECTOR nameCollationSheet, fullNameLegalEntityStockCollationSheet, nameLegalEntityStockCollationSheet, committeeCollationSheet, nameCommitteeCollationSheet,
                              nameChairmanCommitteeCollationSheet, namePositionChairmanCollationSheet, nameEmployeeCollationSheet,
                              nameTypeOfAdditionCollationSheet, fullNameStockCollationSheet, dateCollationSheet,
                              quantityPageInventoryDetailCollationSheet, quantityBalanceCollationSheet, quantityShortageCollationSheet,
                              sumPageInventoryDetailCollationSheet, sumBalanceCollationSheet, sumShortageCollationSheet,
                              countListInventoryCollationSheet, countPageInventoryCollationSheet, prevDateCollationSheet,
                              sumItemPageInventoryDetailCollationSheet, sumContainerPageInventoryDetailCollationSheet,
                              sumItemBalanceCollationSheet, sumContainerBalanceCollationSheet, timeFromCollationSheet, timeToCollationSheet,
                              sumItemShortageCollationSheet, sumContainerShortageCollationSheet, isBatchCollationSheet, isSkuCollationSheet,
                              countIndexCollationSheet, countIndexBatchCollationSheet, numberDisposalCollationSheet 

    OBJECTS          i=Sku
    PROPERTIES(i)     SELECTOR nameSku, idBarcodeSku, idSku, shortNameUOMSku
    PROPERTIES(cs, i) SELECTOR quantityPageInventoryDetailCollationSheetSku, quantityBalanceCollationSheetSku, quantityShortageCollationSheetSku
    PROPERTIES(cs, i)          pricePageInventoryDetailCollationSheetSku, priceBalanceCollationSheetSku
    PROPERTIES(cs, i) SELECTOR sumPageInventoryDetailCollationSheetSku, sumBalanceCollationSheetSku, sumShortageCollationSheetSku
    FILTERS                    includeCollationSheetSku(cs, i)
    ORDER BY nameSku(i)

    OBJECTS         b=Batch
    PROPERTIES(b)    SELECTOR nameSkuBatch, idBarcodeSkuBatch, descriptionBatch, nameBatch, idBatch, shortNameUOMBatch
    PROPERTIES(cs,b) SELECTOR quantityPageInventoryDetailCollationSheetBatch, quantityBalanceCollationSheetBatch, quantityShortageCollationSheetBatch
    PROPERTIES(cs,b) SELECTOR pricePageInventoryDetailCollationSheetBatch, priceBalanceCollationSheetBatch
    PROPERTIES(cs,b) READONLY sumPageInventoryDetailCollationSheetBatch, sumBalanceCollationSheetBatch, sumShortageCollationSheetBatch
    FILTERS                   includeCollationSheetBatch(cs,b),
                              quantityPageInventoryDetailCollationSheetBatch(cs,b) OR quantityBalanceCollationSheetBatch(cs,b)
    ORDER BY nameSkuBatch(b)
    
    OBJECTS e=Employee
    PROPERTIES(e) READONLY   nameContact, namePositionEmployee
    FILTERS        inCollationSheetEmployee(cs, e)    
    
;

printCollationSheet 'Опись' (collationSheet) =
    ACTION FORM printCollationSheet OBJECTS cs = collationSheet PRINT  IMAGE 'print.png' IN print;

FORM printCollationSheetXLS 'Опись'

    OBJECTS          cs=CollationSheet FIXED PANEL
    PROPERTIES (cs)  SELECTOR nameCollationSheet, fullNameLegalEntityStockCollationSheet, nameLegalEntityStockCollationSheet, committeeCollationSheet, nameCommitteeCollationSheet,
                              nameChairmanCommitteeCollationSheet, namePositionChairmanCollationSheet, nameEmployeeCollationSheet,
                              nameTypeOfAdditionCollationSheet, fullNameStockCollationSheet, dateCollationSheet,
                              quantityPageInventoryDetailCollationSheet, quantityBalanceCollationSheet, quantityShortageCollationSheet,
                              sumPageInventoryDetailCollationSheet, sumBalanceCollationSheet, sumShortageCollationSheet,
                              countListInventoryCollationSheet, countPageInventoryCollationSheet, prevDateCollationSheet,
                              sumItemPageInventoryDetailCollationSheet, sumContainerPageInventoryDetailCollationSheet,
                              sumItemBalanceCollationSheet, sumContainerBalanceCollationSheet, timeFromCollationSheet, timeToCollationSheet,
                              sumItemShortageCollationSheet, sumContainerShortageCollationSheet, isBatchCollationSheet, isSkuCollationSheet,
                              countIndexCollationSheet, countIndexBatchCollationSheet,
                              positiveQuantityShortageCollationSheet, positiveSumShortageCollationSheet,
                              negativeQuantityShortageCollationSheet, negativeSumShortageCollationSheet, numberDisposalCollationSheet 

    OBJECTS          i=Sku
    PROPERTIES(i)     SELECTOR nameSku, idBarcodeSku, idSku, shortNameUOMSku
    PROPERTIES(cs, i) SELECTOR quantityPageInventoryDetailCollationSheetSku, quantityBalanceCollationSheetSku, quantityShortageCollationSheetSku
    PROPERTIES(cs, i)          pricePageInventoryDetailCollationSheetSku, priceBalanceCollationSheetSku
    PROPERTIES(cs, i) SELECTOR sumPageInventoryDetailCollationSheetSku, sumBalanceCollationSheetSku, sumShortageCollationSheetSku
    FILTERS                    includeCollationSheetSku(cs, i)
    ORDER BY nameSku(i)

    OBJECTS         b=Batch
    PROPERTIES(b)    SELECTOR nameSkuBatch, idBarcodeSkuBatch, descriptionBatch, nameBatch, idBatch, shortNameUOMBatch
    PROPERTIES(cs,b) SELECTOR quantityPageInventoryDetailCollationSheetBatch, quantityBalanceCollationSheetBatch, quantityShortageCollationSheetBatch
    PROPERTIES(cs,b) SELECTOR pricePageInventoryDetailCollationSheetBatch, priceBalanceCollationSheetBatch
    PROPERTIES(cs,b) READONLY sumPageInventoryDetailCollationSheetBatch, sumBalanceCollationSheetBatch, sumShortageCollationSheetBatch
    FILTERS                   includeCollationSheetBatch(cs,b),
                              quantityPageInventoryDetailCollationSheetBatch(cs,b) OR quantityBalanceCollationSheetBatch(cs,b)
    ORDER BY nameSkuBatch(b)
    
    OBJECTS e=Employee
    PROPERTIES(e) READONLY   nameContact, namePositionEmployee
    FILTERS        inCollationSheetEmployee(cs, e)    
    
;

printCollationSheetXLS 'Опись (xls)' (collationSheet) =
    ACTION FORM printCollationSheetXLS OBJECTS cs = collationSheet PRINT XLSX 
    IMAGE 'print.png' IN print;
//------------------------------------ Сличительная ведомость (итоги) ------------------------------------------//

FORM printTotalCollationSheetBy 'Сличительная ведомость (итоги)'

    OBJECTS          cs=CollationSheet FIXED PANEL

    PROPERTIES (cs)  SELECTOR nameCollationSheet, nameLegalEntityStockCollationSheet, nameCommitteeCollationSheet,
                              nameChairmanCommitteeCollationSheet, namePositionChairmanCollationSheet, nameEmployeeCollationSheet,
                              timeFromCollationSheet, timeToCollationSheet, dateCollationSheet, nameHeadManCollationSheet
    PROPERTIES (cs)  SELECTOR nameTypeOfAdditionCollationSheet, fullNameStockCollationSheet,
                              quantityPageInventoryDetailCollationSheet, quantityBalanceCollationSheet, quantityShortageCollationSheet,
                              sumPageInventoryDetailCollationSheet, sumBalanceCollationSheet, sumShortageCollationSheet,
                              countListInventoryCollationSheet, countPageInventoryCollationSheet, prevDateCollationSheet
    PROPERTIES (cs)  SELECTOR sumItemBalanceCollationSheet, sumContainerBalanceCollationSheet, sumItemPageInventoryDetailCollationSheet,
                              sumContainerPageInventoryDetailCollationSheet, sumItemShortageCollationSheet, sumContainerShortageCollationSheet,
                              numberDisposalCollationSheet, accountSumItemBalanceCollationSheet, accountSumContainerBalanceCollationSheet,
                              accountSumBalanceCollationSheet
;

printTotalCollationSheetBy 'Сличительная ведомость (итоги)' (collationSheet) =
    ACTION FORM printTotalCollationSheetBy OBJECTS cs = collationSheet PRINT  IMAGE 'print.png' IN print;


EXTEND FORM inventories

    PROPERTIES(li) printListInventoryBy
    PROPERTIES(cs) printTotalCollationSheetBy, printCollationSheetBy, printCollationSheetByGroup, printCollationSheetXLS, printCollationSheet
;