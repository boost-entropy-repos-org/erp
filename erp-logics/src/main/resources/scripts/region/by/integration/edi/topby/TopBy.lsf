MODULE TopBy;

REQUIRE System, EDI, Integration, Warehouse, Store;

NAMESPACE EDI;

EXTEND CLASS EDIProvider {
    topBy 'СТТ'
}

loginTopBy 'Имя пользователя TopBy' = DATA VARSTRING[100] ();
passwordTopBy 'Пароль TopBy' = DATA VARSTRING[100] () ECHO;
hostTopBy 'Хост' = DATA VARSTRING[100] ();
portTopBy 'Порт' = DATA INTEGER ();
receiveTopBy 'Получить сообщения' = ACTION CUSTOM 'lsfusion.erp.region.by.integration.edi.topby.ReceiveMessagesTopByActionProperty' ();

EXTEND FORM integrationData
    PROPERTIES() loginTopBy, passwordTopBy, hostTopBy, portTopBy, receiveTopBy
;
    
DESIGN integrationData {
    pane {
        NEW vs {
            caption = 'TopBy';
            MOVE PROPERTY(loginTopBy());
            MOVE PROPERTY(passwordTopBy());
            MOVE PROPERTY(hostTopBy());
            MOVE PROPERTY(portTopBy());
            MOVE PROPERTY(receiveTopBy());
        }
    }
}

sendTopBy 'Отправить' = ACTION CUSTOM 'lsfusion.erp.region.by.integration.edi.topby.SendEOrderTopByActionProperty' (EOrder);

send(EOrder o) += ACTION IF EDIProvider(supplier(o)) == EDIProvider.topBy THEN IF exported(o) THEN MESSAGE 'Заказ уже отправлен' ELSE sendTopBy(o);

good(EOrderMessage m) += (code(m) == '1250' OR code(m) == '1251' OR code(m) == '1252');