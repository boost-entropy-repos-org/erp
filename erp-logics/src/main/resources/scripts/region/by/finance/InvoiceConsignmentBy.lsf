MODULE InvoiceConsignmentBy;

REQUIRE Invoice,
        ConsignmentBy;

NAMESPACE Invoice;

@defineConsignmentAbstractHeader(invoice);
@implementConsignmentHeader (Invoice);
@implementConsignmentDetail (invoice);

dataSupplierConsignment (consignment) += fromInvoice(consignment);
supplierStockConsignment (consignment) += fromStockInvoice(consignment);

dataCustomerConsignment (consignment) += toInvoice(consignment);
customerStockConsignment (consignment) += toStockInvoice(consignment);

dataCurrencyConsignment (consignment) += currencyInvoice(consignment);

dataPriceConsignmentDetail (detail) += priceInvoiceDetail(detail);
invoicePriceConsignmentDetail(detail) += invoicePriceInvoiceDetail(detail);
invoiceSumConsignmentDetail(detail) += invoiceSumInvoiceDetail(detail);

dataSumConsignmentDetail (detail) += sumInvoiceDetail(detail);
dataVatConsignmentDetail (detail) += valueVATInvoiceDetail(detail);

dataSumVATConsignmentDetail (detail) += VATSumInvoiceDetail(detail);
dataSumInvoiceConsignmentDetail (detail) += invoiceSumInvoiceDetail(detail);
noteConsignmentDetail (detail) += noteInvoiceDetail(detail);
extraDescriptionConsignmentDetail (detail) += extraDescriptionInvoiceDetail(detail);

DESIGN options { consignment { MOVE PROPERTY(notNullInvoiceVAT()); } }

META defineInvoiceConsignment(contactA, contactB)

    @defineConsignmentInterfaceHeader(invoice);
    @implementConsignmentDocumentHeader(invoice, userInvoice, );

    EXTEND FORM  invoices
        PROPERTIES(i) FORCE PANEL editAttributesConsignment
        PROPERTIES(i) FORCE PANEL SHOWIF showTTN1Consignment(i)
                         printConsignmentVerticalA, printConsignmentVerticalAB, printConsignmentHorizontalA,
                         printConsignmentVerticalB, printConsignmentHorizontalB, printConsignmentAttach,
                         printConsignmentVertical, printConsignmentHorizontal, printConsignmentAttachXLS 
        PROPERTIES(i) FORCE PANEL SHOWIF showTN2Consignment(i)
                         printConsignmentSimpleHorizontal, printConsignmentSimpleVertical, printConsignmentSimpleAttach
    ;

    DESIGN invoices {
        printTab {
            NEW consignmentRow1 {
                align = LEADING;
                type = CONTAINERH;

                NEW contOne {
                    alignment = STRETCH;
                    type = CONTAINERH;
                    caption = 'Накладная';
                    MOVE PROPERTY(editAttributesConsignment(i)) {
                        alignment = STRETCH;
                    }
                }
                NEW tn2 {
                    alignment = STRETCH;
                    type = COLUMNS;
                    columns = 3;
                    caption = 'ТН-2';
                    MOVE PROPERTY(printConsignmentSimpleVertical(i));
                    MOVE PROPERTY(printConsignmentSimpleHorizontal(i));
                    MOVE PROPERTY(printConsignmentSimpleAttach(i));
                }
            }
            NEW consignmentRow2 {
                align = LEADING;
                type = COLUMNS;
                columns = 3;
                caption = 'ТТН-1';
                MOVE PROPERTY(printConsignmentVerticalA(i));
                MOVE PROPERTY(printConsignmentVerticalAB(i));
                MOVE PROPERTY(printConsignmentHorizontalA(i));
                MOVE PROPERTY(printConsignmentVerticalB(i));
                MOVE PROPERTY(printConsignmentHorizontalB(i));
                MOVE PROPERTY(printConsignmentAttach(i));      
                MOVE PROPERTY(printConsignmentVertical(i));  
                MOVE PROPERTY(printConsignmentHorizontal(i));
            }
            NEW consignmentRow3 {
                type = CONTAINERH;            
                NEW export {
                    type = CONTAINERH;
                    caption = 'Экспорт';  
                    MOVE PROPERTY(printConsignmentAttachXLS(i));                
                }
            }    
        }
    }
END

seriesCharToNum = FORMULA 'lpad(CAST(CASE WHEN ASCII($1) < 1049 THEN ASCII($1) - 1039 ELSE ASCII($1) - 1041 END as char(2)), 2, \'0\')';
TTN1series (s) = '861' + seriesCharToNum(left(s,1)) + seriesCharToNum(right(s,1));

ttn1SeriesNumberInvoice(i) = TTN1series(seriesInvoice(i)) + numberInvoice(i); 
