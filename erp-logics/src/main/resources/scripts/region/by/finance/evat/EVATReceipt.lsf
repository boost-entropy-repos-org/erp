MODULE EVATReceipt;

REQUIRE ZReportReport, SaleInvoiceEvat;

NAMESPACE EVAT;

//------------------------------ Создание ЭСЧФ на основании чека ------------------------------------------------

customerGroupEVAT 'Группа покупателей при создании ЭСЧФ из чека' = DATA LegalEntityGroup();
nameCustomerGroupEVAT 'Группа покупателей при создании ЭСЧФ из чека' = name(customerGroupEVAT());

EXTEND FORM options 
    PROPERTIES() nameCustomerGroupEVAT;

DESIGN options { 
    EVAT { 
        MOVE PROPERTY(nameCustomerGroupEVAT()); 
    } 
}

customer = DATA LOCAL NESTED LegalEntity();
range = DATA LOCAL NESTED Range();
customerStr = DATA LOCAL NESTED VARSTRING[150]();
unpStr = DATA LOCAL NESTED VARSTRING[9]();

FORM findCustomer 'Поиск покупателя'
    OBJECTS c = VARSTRING[150] PANEL
    PROPERTIES name = VALUE(c)
    
    OBJECTS u = VARSTRING[9] PANEL
    PROPERTIES unp = VALUE(u)
     
//    OBJECTS range = Range PANEL
//    PROPERTIES(range) valueCurrentRate SELECTOR  
//    FILTERS   nameTax(range) == 'НДС', nameCountry(range) == 'Республика Беларусь'
;

DESIGN findCustomer {
    NEW customer{
        caption = 'Введите часть наименования покупателя или УНП';
        MOVE PROPERTY(name) {caption = 'Наименование';}   
        MOVE PROPERTY(unp) {caption = 'УНП';}   
    }
    MOVE functions.box;   
}


FORM inputData 'Новый покупатель'
    OBJECTS cu = VARSTRING[150] PANEL
    PROPERTIES name = VALUE(cu)
    
    OBJECTS un = VARSTRING[9] PANEL
    PROPERTIES unp = VALUE(un)

    OBJECTS a = VARSTRING[150] PANEL
    PROPERTIES address = VALUE(a)
     
//    OBJECTS range = Range PANEL
//    PROPERTIES(range) valueCurrentRate SELECTOR  
//    FILTERS   nameTax(range) == 'НДС', nameCountry(range) == 'Республика Беларусь'
;

DESIGN inputData {
    NEW customer{
        caption = 'Введите данные нового покупателя';
        MOVE PROPERTY(name) {caption = 'Наименование';}   
        MOVE PROPERTY(unp) {caption = 'УНП';}   
        MOVE PROPERTY(address) {caption = 'Юридический адрес';}   
    }
//    NEW tax{
//        MOVE range.box {caption = 'НДС';}  
//    }
    MOVE functions.box;   
}

FORM checkData 'Проверка ставки НДС'
    OBJECTS c = LegalEntity PANEL
    PROPERTIES (c) READONLY name, UNP, address
    
    OBJECTS range = Range PANEL
    PROPERTIES(range) valueCurrentRate SELECTOR  
    FILTERS   nameTax(range) == 'НДС', nameCountry(range) == 'Республика Беларусь'
;

DESIGN checkData {
    NEW customer{
        caption = 'Покупатель';
        MOVE PROPERTY(name(c)) {caption = 'Наименование';}   
        MOVE PROPERTY(UNP(c)) {caption = 'УНП';}   
        MOVE PROPERTY(address(c)) {caption = 'Юридический адрес';}   
    }
    MOVE range.box {caption = 'НДС';}  
    MOVE functions.box;   
}

FORM selectCustomer 'Выбор покупателя'
    OBJECTS l = LegalEntity
    PROPERTIES(l) READONLY name, UNP
    FILTERS ((isISubstring(name(l),customerStr()) AND customerStr() !='') OR (isISubstring(UNP(l),unpStr())  AND unpStr() !=''))
             AND (legalEntityGroup(l) == customerGroupEVAT() OR NOT customerGroupEVAT())
;

countLegalEntitiesByName(VARSTRING[150] str) = GROUP SUM 1 IF isISubstring(name(LegalEntity l),VARSTRING[150] str) AND str !='' 
                                                        AND (legalEntityGroup(l) == customerGroupEVAT() OR NOT customerGroupEVAT()) BY str;
countLegalEntitiesByUNP(VARSTRING[9] str) = GROUP SUM 1 IF isISubstring(UNP(LegalEntity l),VARSTRING[9] str)  AND str !='' 
                                                        AND (legalEntityGroup(l) == customerGroupEVAT() OR NOT customerGroupEVAT()) BY str;

createEVAT 'Создать ЭСЧФ' = ACTION ABSTRACT (Receipt);

EXTEND FORM receiptListPeriod
    PROPERTIES(r) createEVAT TODRAW r FORCE PANEL
;

