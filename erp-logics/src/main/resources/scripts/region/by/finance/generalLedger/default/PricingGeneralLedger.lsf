MODULE PricingGeneralLedger;

REQUIRE GeneralLedger, Pricing, DimensionStock, DimensionLegalEntity;

NAMESPACE Pricing;
//------------------- Расценка --------------------//
                                                                              //todo: добавить в аналитику по кредиту организацию
EXTEND CLASS Pricing : GeneralLedger.GLDocument;
isPostedGLDocument(document) += isPostedPricing(document);
nameGLDocument(document) += descriptionPricing(document);

numberGLDocument(document) += numberPricing(document);
seriesGLDocument(document) += seriesPricing(document);

dateTimeGLDocument(document) += dateTimePricing(document);
operationGLDocument(document) += operationPricing(document);

//editGLDocument (GLDocument)+= editInvoice(GLDocument);

////////////////////////////// Приход от поставщика //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,                                      // основание
                                          PrPurMarkC,                                   // идентификатор
                                          legalEntityStock,                             // компания
                                          retailMarkupSumContainerPricingDetailPricing, // сумма
                                          description,                                  // описание
                                          '41.3',                                       // дебет
                                          '42.1',                                       // кредит
                                          'by_default',                                 // идентификатор плана счетов
                                          'by_default_pricing_purchase'                         // идентификатор операции
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkCGeneralLedger(generalLedger));
//-- Товар
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurMarkI,
                                          legalEntityStock,
                                          retailMarkupSumItemPricingDetailPricing,
                                          description,
                                          '41.2',
                                          '42.1',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkIGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkIGeneralLedger(generalLedger));

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATC,
                                          legalEntityStock,
                                          retailVATSumContainerPricingDetailPricing,
                                          description,
                                          '41.3',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATCGeneralLedger(generalLedger));

//-- Товар
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATI,
                                          legalEntityStock,
                                          retailVATSumItemPricingDetailPricing,
                                          description,
                                          '41.2',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATIGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATIGeneralLedger(generalLedger));

////////////////////////////// Списание по нормам //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNMarkC,
                                          legalEntityStock,
                                          retailMarkupSumContainerPricingDetailPricing,
                                          description,
                                          '42.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNMarkCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNMarkNotC,
                                          legalEntityStock,
                                          retailMarkupSumNotContainerPricingDetailPricing,
                                          description,
                                          '42.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNMarkNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNMarkNotCGeneralLedger(generalLedger));

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNVATC,
                                          legalEntityStock,
                                          retailVATSumContainerPricingDetailPricing,
                                          description,
                                          '42.2',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNVATCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNVATNotC,
                                          legalEntityStock,
                                          retailVATSumNotContainerPricingDetailPricing,
                                          description,
                                          '42.2',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNVATNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNVATNotCGeneralLedger(generalLedger));

//-------------------------------- Сумма поставщика -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNSupC,
                                          legalEntityStock,
                                          sumContainerPricingDetailPricing,
                                          description,
                                          '44.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNSupCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNSupCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNSupNotC,
                                          legalEntityStock,
                                          sumNotContainerPricingDetailPricing,
                                          description,
                                          '44.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNSupNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNSupNotCGeneralLedger(generalLedger));

////////////////////////////// Списание (веревки) //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRMarkC,
                                          legalEntityStock,
                                          retailMarkupSumContainerPricingDetailPricing,
                                          description,
                                          '42.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRMarkCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRMarkNotC,
                                          legalEntityStock,
                                          retailMarkupSumNotContainerPricingDetailPricing,
                                          description,
                                          '42.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRMarkNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRMarkNotCGeneralLedger(generalLedger));

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRVATC,
                                          legalEntityStock,
                                          retailVATSumContainerPricingDetailPricing,
                                          description,
                                          '42.2',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRVATCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRVATNotC,
                                          legalEntityStock,
                                          retailVATSumNotContainerPricingDetailPricing,
                                          description,
                                          '42.2',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRVATNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRVATNotCGeneralLedger(generalLedger));

//-------------------------------- Сумма поставщика -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRSupC,
                                          legalEntityStock,
                                          sumContainerPricingDetailPricing,
                                          description,
                                          '44.7',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRSupCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRSupCGeneralLedger(generalLedger));
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRSupNotC,
                                          legalEntityStock,
                                          sumNotContainerPricingDetailPricing,
                                          description,
                                          '44.7',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRSupNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRSupNotCGeneralLedger(generalLedger));

// ----------------------------------- Стандартные данные ----------------------------------- //

@defineLoadDefaultOperation (Pricing, iname, isid);
loadDefaultOperationsPricingBy 'Загрузить стандарные операции расценки' () = ACTION () {
    EXEC loadDefaultOperation ('Расценка товара при поступлении на магазин', 'by_default_pricing_purchase');
    EXEC loadDefaultOperation ('Расценка при списании товара по нормам на магазине', 'by_default_pricing_writeOffNorm');
    EXEC loadDefaultOperation ('Расценка при списании веревок на магазине', 'by_default_pricing_writeOffRopes');
} ;
loadDefaultOperations () += loadDefaultOperationsPricingBy();
