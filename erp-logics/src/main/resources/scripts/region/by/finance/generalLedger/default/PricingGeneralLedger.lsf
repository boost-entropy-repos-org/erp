MODULE PricingGeneralLedger;

REQUIRE GeneralLedger, Pricing, DimensionStock, DimensionLegalEntity;

NAMESPACE Pricing;
//------------------- Расценка --------------------//
                                                                              //todo: добавить в аналитику по кредиту организацию
EXTEND CLASS Pricing : GeneralLedger.GLDocument;
isPostedGLDocument(document) += isPostedPricing(document);
nameGLDocument(document) += descriptionPricing(document);

numberGLDocument(document) += numberPricing(document);
seriesGLDocument(document) += seriesPricing(document);

dateTimeGLDocument(document) += dateTimePricing(document);
operationGLDocument(document) += operationPricing(document);

//editGLDocument (GLDocument)+= ACTION editInvoice(GLDocument);

////////////////////////////// Приход от поставщика //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
retailPurchaseMarkupSumContainerPricingDetailPricing = retailMarkupSumContainerPricingDetailPricing(p) IF NOT isReturnPricing(p);
@defineGeneralLedgerAggregationOperation (pricing,                                      // основание
                                          PrPurMarkC,                                   // идентификатор
                                          legalEntityStock,                             // компания
                                          retailPurchaseMarkupSumContainerPricingDetail, // сумма
                                          description,                                  // описание
                                          '41.3',                                       // дебет
                                          '42.1',                                       // кредит
                                          'by_default',                                 // идентификатор плана счетов
                                          'by_default_pricing_purchase'                         // идентификатор операции
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurMarkCGeneralLedger;    

//-- Товар
retailPurchaseMarkupSumItemPricingDetailPricing = retailMarkupSumItemPricingDetailPricing(p) IF NOT isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurMarkI,
                                          legalEntityStock,
                                          retailPurchaseMarkupSumItemPricingDetail,
                                          description,
                                          '41.2',
                                          '42.1',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkIGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkIGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurMarkIGeneralLedger;    

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
retailPurchaseVATSumContainerPricingDetailPricing = retailVATSumContainerPricingDetailPricing(p) IF NOT isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATC,
                                          legalEntityStock,
                                          retailPurchaseVATSumContainerPricingDetail,
                                          description,
                                          '41.3',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurVATCGeneralLedger;    

//-- Товар
retailPurchaseVATSumItemPricingDetailPricing = retailVATSumItemPricingDetailPricing(p) IF NOT isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATI,
                                          legalEntityStock,
                                          retailPurchaseVATSumItemPricingDetail,
                                          description,
                                          '41.2',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATIGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATIGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurVATIGeneralLedger;    

////////////////////////////// Возврат товара поставщику (сторно) //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
negativeRetailMarkupSumContainerPricingDetailPricing (p) = -retailMarkupSumContainerPricingDetailPricing(p) IF isReturnPricing(p);
@defineGeneralLedgerAggregationOperation (pricing,                                      // основание
                                          PrPurMarkCR,                                   // идентификатор
                                          legalEntityStock,                             // компания
                                          negativeRetailMarkupSumContainerPricingDetail, // сумма
                                          description,                                  // описание
                                          '41.3',                                       // дебет
                                          '42.1',                                       // кредит
                                          'by_default',                                 // идентификатор плана счетов
                                          'by_default_pricing_purchase'                         // идентификатор операции
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkCRGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkCRGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurMarkCRGeneralLedger;    

//-- Товар
negativeRetailMarkupSumItemPricingDetailPricing (p) = -retailMarkupSumItemPricingDetailPricing(p) IF isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurMarkIR,
                                          legalEntityStock,
                                          negativeRetailMarkupSumItemPricingDetail,
                                          description,
                                          '41.2',
                                          '42.1',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurMarkIRGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurMarkIRGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurMarkIRGeneralLedger;    

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
negativeRetailVATSumContainerPricingDetailPricing (p) = -retailVATSumContainerPricingDetailPricing(p) IF isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATCR,
                                          legalEntityStock,
                                          negativeRetailVATSumContainerPricingDetail,
                                          description,
                                          '41.3',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATCRGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATCRGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurVATCRGeneralLedger;    

//-- Товар
negativeRetailVATSumItemPricingDetailPricing (p) = -retailVATSumItemPricingDetailPricing(p) IF isReturnPricing(p);

@defineGeneralLedgerAggregationOperation (pricing,
                                          PrPurVATIR,
                                          legalEntityStock,
                                          negativeRetailVATSumItemPricingDetail,
                                          description,
                                          '41.2',
                                          '42.2',
                                          'by_default',
                                          'by_default_pricing_purchase'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrPurVATIRGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrPurVATIRGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrPurVATIRGeneralLedger;  

////////////////////////////// Списание по нормам //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNMarkC,
                                          legalEntityStock,
                                          retailMarkupSumContainerPricingDetail,
                                          description,
                                          '42.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNMarkCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNMarkCGeneralLedger;    

//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNMarkNotC,
                                          legalEntityStock,
                                          retailMarkupSumNotContainerPricingDetail,
                                          description,
                                          '42.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNMarkNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNMarkNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNMarkNotCGeneralLedger;    

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNVATC,
                                          legalEntityStock,
                                          retailVATSumContainerPricingDetail,
                                          description,
                                          '42.2',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNVATCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNVATCGeneralLedger;    

//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNVATNotC,
                                          legalEntityStock,
                                          retailVATSumNotContainerPricingDetail,
                                          description,
                                          '42.2',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNVATNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNVATNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNVATNotCGeneralLedger;    

//-------------------------------- Сумма поставщика -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNSupC,
                                          legalEntityStock,
                                          sumContainerPricingDetail,
                                          description,
                                          '44.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNSupCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNSupCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNSupCGeneralLedger;    

//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoNSupNotC,
                                          legalEntityStock,
                                          sumNotContainerPricingDetail,
                                          description,
                                          '44.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffNorm'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoNSupNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoNSupNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoNSupNotCGeneralLedger;    

////////////////////////////// Списание (веревки) //////////////////////////////////
//-------------------------------- Торговая надбавка -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRMarkC,
                                          legalEntityStock,
                                          retailMarkupSumContainerPricingDetail,
                                          description,
                                          '42.1',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRMarkCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRMarkCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRMarkCGeneralLedger;    

//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRMarkNotC,
                                          legalEntityStock,
                                          retailMarkupSumNotContainerPricingDetail,
                                          description,
                                          '42.1',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRMarkNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRMarkNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRMarkNotCGeneralLedger;    

//-------------------------------- НДС розничный -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRVATC,
                                          legalEntityStock,
                                          retailVATSumContainerPricingDetail,
                                          description,
                                          '42.2',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRVATCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRVATCGeneralLedger;    

//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRVATNotC,
                                          legalEntityStock,
                                          retailVATSumNotContainerPricingDetail,
                                          description,
                                          '42.2',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRVATNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRVATNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRVATNotCGeneralLedger;    

//-------------------------------- Сумма поставщика -------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRSupC,
                                          legalEntityStock,
                                          sumContainerPricingDetail,
                                          description,
                                          '44.7',
                                          '41.3',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRSupCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRSupCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRSupCGeneralLedger;
    
//-- Не тара
@defineGeneralLedgerAggregationOperation (pricing,
                                          PrWoRSupNotC,
                                          legalEntityStock,
                                          sumNotContainerPricingDetail,
                                          description,
                                          '44.7',
                                          '41.2',
                                          'by_default',
                                          'by_default_pricing_writeOffRopes'
                                          );
creditGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(pricingPrWoRSupNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStorePricing(pricingPrWoRSupNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '10' IF l IS PrWoRSupNotCGeneralLedger;

// ----------------------------------- Стандартные данные ----------------------------------- //

@defineLoadDefaultOperation (Pricing, iname, isid);
loadDefaultOperationsPricingBy 'Загрузить стандарные операции расценки' () = ACTION () {
    EXEC loadDefaultOperation ('Расценка товара при поступлении на магазин', 'by_default_pricing_purchase');
    EXEC loadDefaultOperation ('Расценка при списании товара по нормам на магазине', 'by_default_pricing_writeOffNorm');
    EXEC loadDefaultOperation ('Расценка при списании веревок на магазине', 'by_default_pricing_writeOffRopes');
} ;
loadDefaultOperations () += ACTION loadDefaultOperationsPricingBy();

@extendFormGeneralLedgerDocument(pricings, p);