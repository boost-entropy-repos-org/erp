MODULE RepricingGeneralLedger;

REQUIRE GeneralLedger, Repricing, DimensionStock;
NAMESPACE Repricing;

//------------------- Переоценка --------------------//

EXTEND CLASS Repricing : GeneralLedger.GLDocument;
isPostedGLDocument(document) += isPostedRepricing(document);
nameGLDocument(document) += descriptionRepricing(document);

numberGLDocument(document) += numberRepricing(document);
seriesGLDocument(document) += seriesRepricing(document);

dateTimeGLDocument(document) += dateTimeRepricing(document);
operationGLDocument(document) += operationRepricing(document);

//editGLDocument (GLDocument)+= ACTION editInvoice(GLDocument);

////////////////////////////// Обычная переоценка //////////////////////////////////
//-------------------------------- Торговая надбавка ----------------------------------//
//-- Не услуги
@defineGeneralLedgerAggregationOperation (repricing,                                      // основание
                                          RepMark,                                        // идентификатор
                                          legalEntityStock,                               // компания
                                          diffMarkupSumNotChargeRepricingDetail, // сумма
                                          description,                                    // описание
                                          '41.2',                                         // дебет
                                          '42.1',                                         // кредит
                                          'by_default',                                   // идентификатор плана счетов
                                          'by_default_repricing'                          // идентификатор операции
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(repricingRepMarkGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStoreRepricing(repricingRepMarkGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '11' IF l IS RepMarkGeneralLedger;    

//-------------------------------- НДС розничный  ----------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (repricing,
                                          RepVATC,
                                          legalEntityStock,
                                          diffVATSumContainerRepricingDetail,
                                          description,
                                          '41.3',
                                          '42.2',
                                          'by_default',
                                          'by_default_repricing'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(repricingRepVATCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStoreRepricing(repricingRepVATCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '11' IF l IS RepVATCGeneralLedger;    
//-- Не тара
@defineGeneralLedgerAggregationOperation (repricing,
                                          RepVATNotC,
                                          legalEntityStock,
                                          diffVATSumNotContainerRepricingDetail,
                                          description,
                                          '41.2',
                                          '42.2',
                                          'by_default',
                                          'by_default_repricing'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(repricingRepVATNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStoreRepricing(repricingRepVATNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '11' IF l IS RepVATNotCGeneralLedger;    

//-------------------------------- Сумма поставщика ----------------------------------//
//-- Тара
@defineGeneralLedgerAggregationOperation (repricing,
                                          RepSupC,
                                          legalEntityStock,
                                          diffSumContainerRepricingDetail,
                                          description,
                                          '41.3',
                                          '92.2',
                                          'by_default',
                                          'by_default_repricing'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(repricingRepSupCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStoreRepricing(repricingRepSupCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '11' IF l IS RepSupCGeneralLedger;    
//-- Не тара
@defineGeneralLedgerAggregationOperation (repricing,
                                          RepSupNotC,
                                          legalEntityStock,
                                          diffSumNotContainerRepricingDetail,
                                          description,
                                          '41.2',
                                          '92.1',
                                          'by_default',
                                          'by_default_repricing'
                                          );
debitGeneralLedgerDimensionType(generalLedger,dimensionType) += WHEN CLASS(repricingRepSupNotCGeneralLedger(generalLedger)) AND dimensionType == DimensionType.stock THEN departmentStoreRepricing(repricingRepSupNotCGeneralLedger(generalLedger));
idOperationGeneralLedger(l) += '11' IF l IS RepSupNotCGeneralLedger;    

// ----------------------------------- Стандартные данные ----------------------------------- //

@defineLoadDefaultOperation (Repricing, iname, isid);

loadDefaultOperationsRepricingBy 'Загрузить стандарные операции переоценки товара' () = ACTION () {
    EXEC loadDefaultOperation ('Переоценка товара на магазине', 'by_default_repricing');
} ;

loadDefaultOperations () += ACTION loadDefaultOperationsRepricingBy();

@extendFormGeneralLedgerDocument(repricings, p);