MODULE PurchaseDeclarationEVAT;

REQUIRE PurchaseDeclarationDetail, EVAT;

NAMESPACE Purchase;

createEVATDeclaration 'Таможенные декларации' (LegalEntity l, DATE dFrom, DATE dTo) = ACTION {
    FOR date(Declaration d) >= dFrom AND date(d) <= dTo ADDOBJ e = EVAT DO {
        status(e) <- EVATStatus.original;
        
        date(e) <- date(d);
        
//        numberContract (e) <- number(contractSku(i));
//        dateContract (e) <- dateFrom(contractSku(i));
        legalEntityStatusSupplier(e) <- LegalEntityStatus.foreignOrganization;
        codeDocType (e) <- 603;
        blankCodeDoc (e) <- '402861';
        seriesDoc(e) <- OVERRIDE ' ', series(d);
        numberDoc(e) <- number(d);
        unpSender(e) <- UNP(l);
        
        //Поставщик
        supplier(e) <- [= GROUP MIN supplier(InvoiceDetail d) BY declaration(d)](d);
//        branchCodeSupplier(e) <- branchCode(supplierStock(i));
        
        //Получатель
        customer(e) <- l;
        declarationCustomer(e) <- number(d);
//        branchCodeCustomer(e) <- branchCode(customerStock(i));
        
        FOR declaration(DeclarationDetail id) == d ADDOBJ ed = EVATDetail DO {
            evat(ed) <- e;

            name(ed) <- nameCustoms(id);
            code(ed) <- OVERRIDE '0000000000', codeCustomsGroup(id);
//            quantity(ed) <- quantity(id); 
//            price(ed) <- price(id);
            sum(ed) <- homeSum(id) (+) dutySum(id);
            exciseSum(ed) <- 0;
            vatRate(ed) <- percentVAT(id);
            vatSum(ed) <- VATSum(id);
            sumWithVAT(ed) <- homeSum(id) (+) VATSum(id);
            
            descriptionType(ed) <- DescriptionType.importVAT;
        } 
    } 
    APPLY {};
} CONFIRM;

EXTEND FORM evats
    PROPERTIES createEVATDeclaration(l, dFrom, dTo) TOOLBAR TODRAW e
;

DESIGN evats {
    generate {
        MOVE PROPERTY(createEVATDeclaration(l, dFrom, dTo));
    }
}