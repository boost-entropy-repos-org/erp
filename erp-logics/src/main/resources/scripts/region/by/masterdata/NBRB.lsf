MODULE NBRB;

REQUIRE System,
        Currency,
        SchedulerDefaultData;


//---------------------------------------------- Импорт курсов НБРБ -----------------------------------------------------//

GROUP nbrb 'Курсы НБРБ' : public;

importNBRBExchangeRateDateFrom 'Дата с' = DATA DATE () IN nbrb;
importNBRBExchangeRateDateTo 'Дата по' = DATA DATE () IN nbrb;

importNBRBExchangeRateDaysCount 'Кол-во дней' = DATA INTEGER() IN nbrb;

importNBRBExchangeRateDateFromDateToAction 'Импортировать курсы НБРБ' = ACTION CUSTOM 'lsfusion.erp.region.by.masterdata.ImportNBRBExchangeRateDateFromDateToActionProperty' IN nbrb;
importNBRBExchangeRateLastDaysAction 'Импортировать последние курсы НБРБ' = ACTION CUSTOM 'lsfusion.erp.region.by.masterdata.ImportNBRBExchangeRateLastDaysActionProperty' IN nbrb;

importNBRBExchangeRateDateFromDateTo 'Импортировать курсы НБРБ' = ACTION () {
    FOR c IS Currency DO {
        EXEC importNBRBExchangeRateDateFromDateToAction(c);
    }
    EXEC apply();
} IN nbrb;

importNBRBExchangeRateLastDays 'Импортировать последние курсы НБРБ' = ACTION () {
    FOR c IS Currency DO {
        EXEC importNBRBExchangeRateLastDaysAction(c);
    }
    EXEC apply();
} IN nbrb;

EXTEND FORM typeExchangeCurrencyDate
    PROPERTIES() importNBRBExchangeRateDateFrom, importNBRBExchangeRateDateTo, importNBRBExchangeRateDateFromDateTo
    PROPERTIES() importNBRBExchangeRateDaysCount, importNBRBExchangeRateLastDays
;

EXTEND DESIGN typeExchangeCurrencyDate {
    importExchangeRates {
//        NEW dateFromDateToContainer {
//            type = CONTAINERH;
//            ADD PROPERTY(importNBRBExchangeRateDateFrom());
//            ADD PROPERTY(importNBRBExchangeRateDateTo());
//            ADD PROPERTY(importNBRBExchangeRateDateFromDateTo());
//        }
        ADD NOGROUP.nbrb;
        NEW lastDaysContainer {
            type = CONTAINERH;
            ADD PROPERTY(importNBRBExchangeRateDaysCount());
            ADD PROPERTY(importNBRBExchangeRateLastDays());
        }
        
    }
}

loadDefaultScheduledTasks () += ACTION ()  { 
    loadDefaultScheduledTask ('Загрузка курсов НБРБ', 2014_07_01_15:00, 43200, SchedulerStartType.afterFinish);
    loadDefaultScheduledTaskDetail ('Загрузка курсов НБРБ', 1, 'NBRB.importNBRBExchangeRateLastDays[]');
}
