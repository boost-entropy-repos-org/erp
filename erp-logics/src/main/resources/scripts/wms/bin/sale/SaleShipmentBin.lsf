MODULE SaleShipmentBin;

REQUIRE Bin, SaleShipment, SaleBin;

NAMESPACE Sale;

//---------------------------------Ячейка ----------------------------------//

@defineDocumentInterfaceDetailBin(shipment);
overCopyUserShipmentDetail(d, detail) += ACTION (d, detail) {      
    binUserShipmentDetail(d) <- binUserShipmentDetail(detail);
}
@extendFormInterfaceDetailBin(shipment, s, , quantity);
@deriveDocumentOperationProperty(UserShipment, showBin);
binUserShipmentDetail(detail) <- binStockSku(supplierStockUserShipmentDetail(detail), skuUserShipmentDetail(detail))
    WHEN CHANGED(supplierStockUserShipmentDetail(detail)) OR
         CHANGED(skuUserShipmentDetail(detail));

//-- invoice
@defineInvoiceShipmentBin(supplierStock);
@deriveDocumentOperationProperty(UserInvoice, showBin);

binUserInvoiceDetail(detail) <- binStockSku(supplierStockUserInvoiceDetail(detail), skuUserInvoiceDetail(detail))
    WHEN CHANGED(supplierStockUserInvoiceDetail(detail)) OR
         CHANGED(skuUserInvoiceDetail(detail));

//-- Проводим по регистру (ячейка)
binDataSkuLedger(ledger) += binShipmentDetail(ledger);

//---------------------------------Новый функционал ----------------------------------//

@defineDocumentDetailBinCustom(userShipment, current, ' текущая');
currentBinUserShipmentDetail (detail) = currentBinUserShipment(userShipmentUserShipmentDetail(detail));

EXTEND FORM userShipment
    PROPERTIES(s) SHOWIF showBinUserShipment(s) nameCurrentBinUserShipment
;

EXTEND DESIGN userShipment {
    headerBin {
        ADD PROPERTY(nameCurrentBinUserShipment(s)) AFTER PROPERTY(showBinUserShipment(s));
    }
}


WHEN SESSION FORMS userShipment
    SET(detail IS UserShipmentDetail) AND currentBinUserShipmentDetail(detail)
        DO ASSIGN binUserShipmentDetail(detail) <- currentBinUserShipmentDetail(detail) WHERE currentBinUserShipmentDetail(detail);

WHEN SESSION FORMS userShipment
    CHANGED(invoiceDetailUserShipmentDetail(detail))
        DO ASSIGN binUserShipmentDetail(detail) <- binInvoiceDetail(invoiceDetailUserShipmentDetail(detail));