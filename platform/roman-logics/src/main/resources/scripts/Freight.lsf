MODULE Freight;

REQUIRE System,
        Stock,
        Store,
        I18n,
        LegalEntity,
        Barcode,
        RetailCRM,
        StockDocument,
        Employee,
        UserPriceChange,
        Contract,
        Supplier,
        Warehouse,
        RomanLogicsModule;

PRIORITY Stock, LegalEntity, Store, RomanLogicsModule;

changeMainCompositionSkuLanguage = ACTION (sku, freight) {
    REQUEST STRING[200] INPUT;
    SET mainCompositionSkuLanguage(sku, language) <- requestedString() WHERE language == languageFreight(freight);
}

changeAdditionalCompositionSkuLanguage = ACTION (sku, freight) {
    REQUEST STRING[200] INPUT;
    SET additionalCompositionSkuLanguage(sku, language) <- requestedString() WHERE language == languageFreight(freight);
}

mainCompositionLanguageFreightSku (freight, sku) <- mainCompositionSkuFreight(sku, freight) WHEN ASSIGNED (freight IS FreightChanged);
additionalCompositionLanguageFreightSku (freight, sku) <- additionalCompositionSkuFreight(sku, freight) WHEN ASSIGNED (freight IS FreightChanged);

nameCountryLanguageFreightSku 'Страна (иностр.)' (freight, sku) = nameCountrySkuLanguage(sku, languageFreight(freight));
nameCountryOfOriginLanguageFreightSku 'Страна (иностр.)' (freight, sku) = languageName(countryOfOriginFreightSku(freight, sku), languageFreight(freight));

nameCountryOfOriginLanguageFreight (country, freight) = languageName(country, languageFreight(freight));
localeLanguageFreight (freight) = localeLanguage(languageFreight(freight));

nameCategoryFreightLanguageSku 'Номенклатурная группа (иностр.)' (freight, sku) = nameCategoryArticleSkuLanguage(sku, languageFreight(freight));
nameCategoryFreightLanguageArticle 'Номенклатурная группа (иностр.)' (freight, article) = nameCategoryArticleLanguage(article, languageFreight(freight));

compositionLanguageFreightArticleCompositionCountryCategory (freight, article, STRING, country, customCategory10) = GROUP MAX mainCompositionLanguageFreightSku(freight, sku)
                                                                                                                           BY freight, articleSku(sku),
                                                                                                                              mainCompositionOriginFreightSku(freight, sku),
                                                                                                                              countryOfOriginFreightSku(freight, sku),
                                                                                                                              customCategory10FreightSku(freight, sku);

CONSTRAINT customsZoneFreight(freight) != customsZoneCustomCategory10(customCategory10SkuFreight(sku, freight))
    CHECKED BY customCategory10SkuFreight
    MESSAGE 'ТН ВЭД для другой таможенной зоны';

CONSTRAINT customsZoneFreight(freight) != customsZoneSubCategory(subCategorySkuFreight(sku, freight))
    CHECKED BY subCategorySkuFreight
    MESSAGE 'ТН ВЭД для другой таможенной зоны';

//customCategory10LanguageFreightSku(freight, sku) <- customCategory10SkuFreight(sku, freight) WHEN ASSIGNED (freight IS FreightChanged);

CONSTRAINT customsZoneFreight(freight) != customsZoneCustomCategory10(customCategory10FreightSku(freight, sku))
    CHECKED BY customCategory10FreightSku
    MESSAGE 'ТН ВЭД для другой таможенной зоны';

CONSTRAINT customsZoneFreight(freight) != customsZoneSubCategory(subCategoryFreightSku(freight, sku))
    CHECKED BY subCategoryFreightSku
    MESSAGE 'ТН ВЭД для другой таможенной зоны';

CONSTRAINT customsZoneFreight(freight) != customsZoneCustomCategory10(customCategory10CategoryGenderCompositionTypeFabricFreight(category, gender, composition, typeFabric, freight))
    CHECKED BY customCategory10CategoryGenderCompositionTypeFabricFreight
    MESSAGE 'ТН ВЭД для другой таможенной зоны';

META dateFreight (object, caption)

    FORM date###object caption
        OBJECTS d = DATE FIXED PANEL
        PROPERTIES(d) OBJVALUE
    ;

END

@dateFreight(freightShipped, 'Дата отгрузки');
//@dateFreight(freightArrived, 'Дата прибытия');

FORM dateFreightArrived

    OBJECTS f = Freight FIXED PANEL
    PROPERTIES(f) dateArrivalFreight, sumFreightFreight
;

isFreightShipped(freight) = freight IS FreightShipped;
isFreightArrived(freight) = freight IS FreightArrived;

toShipFreight 'Отгрузить' =  ACTION (freight) IF freight IS FreightPriced AND NOT freight IS FreightShipped THEN {
    FORM dateFreightShipped MODAL;
        IF formResult() == FormResult.ok THEN {
            SET dateShipmentFreight(freight) <- chosenDate('d');
            CHANGECLASS freight TO FreightShipped;
            EXEC apply();
        }

} IMAGE 'sign_tick.png';

toArrivedFreight 'Прибыл' = ACTION (freight) IF freight IS FreightShipped THEN {
    FORM dateFreightArrived MODAL;

        IF formResult() == FormResult.ok THEN {
            //SET dateArrivalFreight(freight) <- chosenDate('d');
            //SET sumFreightFreight(freight) <- chosenNumeric('n');
            CHANGECLASS freight TO FreightArrived;
            EXEC apply();
        }

} IMAGE 'sign_tick.png'; //AND NOT freight IS FreightArrived

FORM freight 'Фрахт'

    OBJECTS f = Freight FIXED PANEL
    PROPERTIES(f) objectClassName, nameNumeratorObject, numberObject, seriesObject, date, dateShipmentFreight SHOWIF isFreightShipped(f),
                  dateArrivalFreight SHOWIF isFreightArrived(f), nameCountryFreight, nameLanguageFreight, nameRouteFreight,
                  nameExporterFreight, descriptionFreight, volumeDataFreight, palletCountDataFreight,
                  nameCurrencyFreight, sumFreightFreight

    EDIT Freight OBJECT f
;

DESIGN freight FROM DEFAULT {

    main{

        NEW headerContainer{

            caption = 'Шапка документа';
            childConstraints = TO THE BOTTOM;
            NEW firstContainer{
                childConstraints = TO THE RIGHT;
                ADD PROPERTY(objectClassName);
                ADD PROPERTY(nameNumeratorObject);
                ADD PROPERTY(numberObject);
                ADD PROPERTY(seriesObject);
            }
            NEW dateContainer{
                childConstraints = TO THE RIGHT;
                ADD PROPERTY(date);
                ADD PROPERTY(dateShipmentFreight);
                ADD PROPERTY(dateArrivalFreight);
            }
        }

        NEW paramContainer {

            caption = 'Параметры документа';
            ADD PROPERTY(nameCountryFreight);
            ADD PROPERTY(nameLanguageFreight);
            ADD PROPERTY(nameRouteFreight);
            ADD PROPERTY(nameExporterFreight);
            ADD PROPERTY(descriptionFreight);
        }

        NEW sumContainer{

            caption = 'Суммы документа';
            childConstraints = TO THE BOTTOM;
            ADD PROPERTY(volumeDataFreight);
            ADD PROPERTY(palletCountDataFreight);
            ADD PROPERTY(nameCurrencyFreight);
            ADD PROPERTY(sumFreightFreight);
        }
        POSITION sumContainer TO THE RIGHT headerContainer;
        POSITION sumContainer TO THE RIGHT paramContainer;

        PROPERTY(objectClassName) { background = #FFEEEE; }
        PROPERTY(date) { background = #FFEEEE; }
        PROPERTY(dateArrivalFreight) { background = #FFEEEE; }
        PROPERTY(dateShipmentFreight) { background = #FFEEEE; }
        PROPERTY(nameRouteFreight) { background = #FFEEEE; }
        PROPERTY(nameExporterFreight) { background = #FFEEEE; }
        PROPERTY(nameCountryFreight) { background = #FFEEEE; }
        PROPERTY(nameCurrencyFreight) { background = #FFEEEE; }
        PROPERTY(sumFreightFreight) { background = #FFEEEE; }
        PROPERTY(descriptionFreight) { background = #FFEEEE; }
    }

    ADD functions.box;
}

EXTEND FORM freightListForm
    PROPERTIES (freight) READONLY dateArrivalFreight BEFORE nameRouteFreight(freight), nameCountryFreight BEFORE nameRouteFreight(freight), nameLanguageFreight BEFORE nameRouteFreight(freight)
    PROPERTIES (freight) FORCE GRID toShipFreight, toArrivedFreight

    PROPERTIES (freight) ADDFORM, EDITFORM, deletef=DELETE FORCE PANEL TOOLBAR
;

EXTEND DESIGN freightListForm{
    PROPERTY(deletef){
        askConfirm=TRUE;
    }
}

EXTEND DESIGN freightShipmentForm {

    PROPERTY(nameImporterShipmentFreight) { background = #FFEEEE; }
    PROPERTY(grossWeightDirectInvoice) { background = #FFEEEE; }
}

EXTEND FORM freightChangeForm

    PROPERTIES (freight, sku) nameCategoryFreightLanguageSku AFTER nameCategoryArticleSku SHOWIF languageFreight(freight),
                              nameCountryLanguageFreightSku  AFTER nameCountrySku SHOWIF languageFreight(freight)

    PROPERTIES (sku) mainCompositionOriginSku, mainCompositionSku ON SHORTCUT translationAllMainComposition(sku)
    PROPERTIES (sku, freight) sidCustomCategory10SkuFreight BEFORE nameCountrySku,
                              nameSubCategorySkuFreight BEFORE nameCountrySku,
                              mainCompositionSkuFreight ON CHANGE changeMainCompositionSkuLanguage(sku, freight) ON SHORTCUT translationAllMainCompositionLanguage(sku, freight) SHOWIF languageFreight(freight)

    PROPERTIES (sku) additionalCompositionOriginSku, additionalCompositionSku ON SHORTCUT translationAllAdditionalComposition(sku)
    PROPERTIES (sku, freight) additionalCompositionSkuFreight ON CHANGE changeAdditionalCompositionSkuLanguage(sku, freight) ON SHORTCUT translationAllAdditionalCompositionLanguage(sku, freight) SHOWIF languageFreight(freight)

    PROPERTIES (freight, skuFreight) mainCompositionOriginFreightSku, mainCompositionFreightSku ON SHORTCUT translationAllFreightMainComposition(freight, skuFreight),
                                     mainCompositionLanguageFreightSku ON SHORTCUT translationAllLanguageMainComposition(freight, skuFreight) SHOWIF languageFreight(freight),

                                     additionalCompositionOriginFreightSku, additionalCompositionFreightSku ON SHORTCUT translationAllFreightAdditionalComposition(freight, skuFreight),
                                     additionalCompositionLanguageFreightSku ON SHORTCUT translationAllLanguageAdditionalComposition(freight, skuFreight) SHOWIF languageFreight(freight),

                                     nameCountryOfOriginLanguageFreightSku AFTER nameCountryOfOriginFreightSku(freight, skuFreight) SHOWIF languageFreight(freight)
;

EXTEND DESIGN freightChangeForm {

    PROPERTY(sidCustomCategory10CategoryGenderCompositionTypeFabricFreight) { background = #FFEEEE; }
    PROPERTY(sidCustomCategory10SkuFreight) { background = #FFEEEE; }
    PROPERTY(nameCountrySku) { background = #FFEEEE; }
    PROPERTY(netWeightSku) { background = #FFEEEE; }
    PROPERTY(mainCompositionSku) { background = #FFEEEE; }
    PROPERTY(additionalCompositionSku) { background = #FFEEEE; }
    PROPERTY(mainCompositionSkuFreight) { background = #FFEEEE; }
    PROPERTY(additionalCompositionSkuFreight) { background = #FFEEEE; }

}

EXTEND DESIGN freightInvoiceForm {

    PROPERTY(markupPercentImporterFreightBrandSupplier) { background = #FFEEEE; }
    PROPERTY(insuranceFreightBrandSupplier) { background = #FFEEEE; }
    PROPERTY(markupPercentImporterFreightArticle) { background = #FFEEEE; }
    PROPERTY(markupPercentImporterFreightSku) { background = #FFEEEE; }
}

EXTEND FORM invoiceFromForm2
    PROPERTIES (freight, article) nameCategoryFreightLanguageArticle
    PROPERTIES (freight) localeLanguageFreight
    PROPERTIES (country, freight) nameCountryOfOriginLanguageFreight
    PROPERTIES (freight, article, composition, country, category) compositionLanguageFreightArticleCompositionCountryCategory
;
